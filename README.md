# WebDAV 画像変換サーバー

## 概要

画像最適化に特化した WebDAV サーバーです。画像の自動変換とキャッシュ機能を備えています。
単一サーバーで画像ファイルの自動変換（WebP 形式）とキャッシュ機能を提供する Node.js アプリケーションとして実装しています。

**最新の主要機能**:

- 🚀 **スタック処理システム**: LIFO方式で最新リクエストを最優先処理
- 🛡️ **設定値検証機能**: config.txtの入力規則チェックと自動修正
- 💾 **動的メモリ管理**: 大量画像処理時のメモリ最適化
- ⚡ **高スペック環境対応**: Ryzen 3950X・64GB RAM最適化設定
- 🏗️ **モジュール分割**: 機能別に分割された保守しやすいアーキテクチャ
- 📝 **動的設定管理**: サーバー再起動なしで全設定を変更可能

## 主な機能

### 🖼️ 画像自動変換

- **対応入力形式**: JPG, JPEG, PNG, TIFF, TIF, BMP, AVIF
- **出力形式**: WebP
- **変換エンジン**: Sharp（高速） + ImageMagick（フォールバック）
- **自動リサイズ**: 設定に応じて最適なサイズに調整
- **品質調整**: クエリパラメータ `?q=70` で指定可能（30-90 の範囲）

**実装箇所**:

- **画像拡張子判定**: `.core/webdav.js` - `IMAGE_EXTS`配列で対応形式を定義
- **変換処理メイン**: `.core/image.js` - `convertAndRespond`関数で Sharp/ImageMagick による変換処理
- **並列処理制限**: `.core/image.js` - `convertAndRespondWithLimit`関数で並列数制御とin-flight管理
- **Sharp 設定**: `main.js` 94-111 行 - パフォーマンス最適化設定（並列度制御、メモリキャッシュ、ファイルキャッシュ）
- **品質パラメータ処理**: `.core/webdav.js` - クエリパラメータ`q`の取得と検証（30-90 の範囲制限）
- **画像処理モード**: `.core/image.js` - 3つの処理モード（高速処理、バランス処理、高圧縮処理）

### ⚡ 高性能キャッシュシステム

- **LRU キャッシュ**: ディレクトリリストとファイル統計の高速キャッシュ
- **画像キャッシュ**: 1MB 以上の画像のみキャッシュ対象
- **自動クリーンアップ**: 5 分 TTL で古いキャッシュを自動削除
- **重複変換防止**: 同じ画像の同時変換要求を効率的に処理
- **失敗バックオフ**: 変換失敗時の再試行制御

**実装箇所**:

- **キャッシュ設定**: `.core/cache.js` - キャッシュディレクトリ、TTL、クリーンアップ間隔の設定（ファイルベースキャッシュ、原子的更新、TTL 管理）
- **LRU キャッシュ**: `.core/webdav.js` - ディレクトリリストとファイル統計の LRU キャッシュインスタンス（LRU アルゴリズム、メモリ制限、分離設計）
- **キャッシュラッパー**: `.core/webdav.js` - `readdirSyncWrap`、`statSyncWrap`等のキャッシュ機能付きファイルシステム関数（ストリーミング読み込み、エラーハンドリング）
- **画像キャッシュ**: `.core/image.js` - キャッシュキー生成とキャッシュパス設定（MD5 ハッシュ、変更検知、衝突回避）
- **重複変換防止**: `.core/image.js` - in-flight変換管理（in-flight deduplication、タイムアウト制御、失敗バックオフ）
- **失敗バックオフ**: `.core/image.js` - 失敗記録と再試行制御（連続失敗時の再試行制御、リトライ制限）
- **自動クリーンアップ**: `.core/cache.js` - `cleanupCache`関数による定期クリーンアップ（非同期処理、TTL 期限切れファイル削除）

### 🚀 スタック処理システム（新機能）

- **適応的処理方式**: 30件以下はFIFO（順序保持）、30件超はLIFO（ユーザビリティ優先）
- **フォルダ変更検出**: フォルダが変わったら古いリクエストを自動破棄
- **積極的スタック管理**: スタックサイズに応じた自動的な古いリクエスト破棄
- **強制復旧機能**: 処理が停止した場合の自動復旧
- **スタック監視**: 3秒間隔でのスタック状況監視と自動クリーンアップ

**実装箇所**:

- **RequestStackクラス**: `.core/stack.js` - 適応的処理方式のリクエストスタック管理（FIFO/LIFO切り替え、フォルダ変更検出、積極的破棄、強制復旧、スタック監視）
- **スタック処理統合**: `.core/webdav.js` - HTTPサーバーとの統合（画像変換リクエストのスタック追加、順次処理）
- **SimpleServerMonitor**: `.core/stack.js` - スタック処理用の軽量監視機能（リクエストカウント、スタック状況ログ、処理方式表示）

### 🛡️ セキュリティ機能

- **パストラバーサル攻撃対策**: 安全なパス解決
- **Depth: infinity 拒否**: 無限階層のディレクトリ探索を防止
- **ファイルアクセス制限**: ルートディレクトリ外へのアクセスを拒否
- **並列処理制限**: CPU 数に応じた適切な並列度制御
- **HTTP圧縮**: gzip圧縮による通信量削減
- **動的設定読み込み**: 設定ファイルの変更を自動反映
- **設定値検証**: config.txtの入力規則チェックと自動修正

**実装箇所**:

- **パストラバーサル対策**: `.core/webdav.js` - `safeResolve`関数による安全なパス解決（パストラバーサル対策、プラットフォーム対応、大文字小文字処理、正規化）
- **Depth: infinity 拒否**: `.core/webdav.js` - WebDAV リクエスト前処理ミドルウェア（PROPFIND、Depth: infinity、セキュリティ対策、DoS 攻撃防止）
- **並列処理制限**: `main.js` 94-111 行 - Sharpの動的並列度制御（メモリ枯渇と CPU 過負荷の防止）
- **アクセス制限**: `.core/webdav.js` - プラットフォーム別のパス比較によるアクセス制御（Windows/Unix 系対応、大文字小文字区別）
- **HTTP圧縮**: `.core/webdav.js` - gzip圧縮によるWebDAVレスポンスとテキストファイルの圧縮（圧縮閾値設定、非同期処理）
- **動的設定読み込み**: `.core/config.js` - `loadConfig`関数による設定ファイル監視と動的更新（差分検出、型変換、ログ出力）
- **設定値検証**: `.core/config.js` - `validateConfigValue`関数による入力規則チェック（数値範囲、真偽値、時刻形式、パス形式の検証）

### 🚀 単一サーバー動的設定

- **動的設定**: config.txtの変更で即座に反映（サーバー再起動不要）
- **画像処理モード**: 3つの処理モードを動的に切り替え可能
- **パラメータ調整**: 品質、サイズ、キャッシュ設定等をリアルタイムで調整

**実装箇所**: `main.js` 175 行 - `startWebDAV(activeCacheDir)`で単一サーバーを起動

## システム要件

- **Node.js**: 16 以上
- **ImageMagick**: フォールバック用（オプション）
- **ディスク容量**: キャッシュ用の十分な容量
- **メモリ**: 画像処理用の十分なメモリ

## インストール

### 1. 依存関係のインストール

```bash
npm install
```

### 2. ImageMagick のインストール（推奨）

#### Windows

```bash
# Chocolatey を使用する場合
choco install imagemagick

# または公式サイトからダウンロード
# <https://imagemagick.org/script/download.php#windows>
```

#### macOS

```bash
brew install imagemagick
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt-get install imagemagick

# CentOS/RHEL
sudo yum install ImageMagick
```

## 使用方法

### 基本的な起動

```bash
# メインサーバーを起動（3つのサーバーが同時起動）
node main.js

# テスト用のシンプルサーバー
node test.js
```

### アクセス方法

起動後、以下の URL でアクセス可能：

- **WebDAVサーバー**: <http://localhost:1900/> (config.txtのPORT設定で変更可能)

### モバイル・タブレットでのアクセス

スマートフォンやタブレットから WebDAV サーバーにアクセスするには専用のアプリが必要です：

#### iOS（iPhone/iPad）＆Android

- **Documents by Readdle**: 高機能なファイル管理アプリ
- **ES File Explorer**: シンプルなファイル管理アプリ
- **Owlfiles**: 軽量なファイル管理アプリ

#### 設定方法（再起動）

1. アプリをインストール後、WebDAV サーバーを追加
2. サーバー情報を入力：
   - **サーバー**: `http://[PCのIPアドレス]:1900`（例：`http://192.168.1.100:1900`、config.txtで変更可能）
   - **ユーザー名**: 空欄（認証なし）
   - **パスワード**: 空欄（認証なし）
3. 接続してファイルにアクセス

**注意**: PC の IP アドレスを確認するには、コマンドプロンプトで `ipconfig`（Windows）または `ifconfig`（Mac/Linux）を実行してください。

### 画像変換の使用例

```bash
# 通常の画像アクセス（自動変換）
http://localhost:1900/path/to/image.jpg

# 品質指定（30-90の範囲）
http://localhost:1900/path/to/image.jpg?q=80

# 自動リサイズ（設定に応じて）
http://localhost:1900/path/to/large_image.jpg
```

## 設定

### サーバー設定の変更

**実装箇所**: `config.txt`

`config.txt` ファイルを編集してサーバー設定を変更：

```txt
# サーバー設定
PORT=1900
ROOT_PATH=Z:/書籍
MAX_LIST=1280
```

### 動的設定ファイル (`config.txt`)

**実装箇所**: `.core/config.js`

サーバー再起動なしで設定を変更できる動的設定ファイル機能：

#### 設定ファイルの場所

```コマンドライン
./config.txt
```

#### 対応設定項目

| 設定項目 | 説明 | デフォルト値 | 有効範囲 | 例 |
|---------|------|-------------|----------|-----|
| `PHOTO_SIZE` | 画像リサイズサイズ | `640` | 100-8192px | `640`, `1024`, `1920` |
| `DEFAULT_QUALITY` | デフォルト品質 | `30` | 10-100 | `40`, `70`, `85` |
| `MAX_LIST` | 最大リスト数 | `1280` | 10-10000 | `896`, `1024`, `4096` |
| `IMAGE_MODE` | 画像処理モード | `2` | 1-3 | `1`(高速), `2`(バランス), `3`(高圧縮) |
| `CACHE_TTL_MS` | キャッシュ有効期間（ミリ秒） | `300000` (5分) | 1分-24時間 | `600000`, `1800000` |
| `CACHE_MIN_SIZE` | キャッシュ最小サイズ（バイト） | `1048576` (1MB) | 1KB-100MB | `2097152`, `524288` |
| `COMPRESSION_ENABLED` | HTTP圧縮の有効/無効 | `true` | `true`/`false` | `true`, `false` |
| `COMPRESSION_THRESHOLD` | 圧縮閾値（0.0-1.0） | `0.3` (30%) | 0.0-1.0 | `0.2`, `0.5` |
| `MAX_CONCURRENCY` | 最大並列処理数 | `2` | 1-32 | `4`, `8`, `16` |
| `SHARP_MEMORY_LIMIT` | Sharpメモリキャッシュ制限（MB） | `64` | 16-4096MB | `128`, `256`, `1024` |
| `SHARP_PIXEL_LIMIT` | Sharpピクセル制限 | `10000000` | 1M-1000M | `25000000`, `100000000` |
| `RATE_LIMIT_ENABLED` | レート制限の有効/無効 | `true` | `true`/`false` | `true`, `false` |
| `RATE_LIMIT_REQUESTS` | 1分間あたりのリクエスト数 | `50` | 1-1000 | `100`, `300`, `500` |
| `RATE_LIMIT_WINDOW_MS` | レート制限時間窓（ミリ秒） | `60000` | 1秒-5分 | `30000`, `120000` |
| `RATE_LIMIT_QUEUE_SIZE` | レート制限キューサイズ | `100` | 10-1000 | `200`, `500` |
| `STACK_MAX_SIZE` | スタック最大サイズ | `100` | 50-500 | `200`, `300` |
| `STACK_PROCESSING_DELAY_MS` | スタック処理遅延（ミリ秒） | `5` | 1-100ms | `10`, `20` |
| `MAGICK_PATH` | ImageMagickコマンドパス | `magick` | 有効なパス | `/usr/bin/magick` |
| `RESTART_ENABLED` | 自動再起動機能の有効/無効 | `false` | `true`/`false` | `true`, `false` |
| `RESTART_TIME` | 再起動時刻（24時間形式） | `12:10` | HH:MM形式 | `03:00`, `14:30` |

#### 設定ファイル例

```txt
# WebDAV画像変換サーバー設定ファイル
# 設定変更後、サーバーの自動再読み込み（10秒以内）

# 圧縮設定
COMPRESSION_ENABLED=true
COMPRESSION_THRESHOLD=0.3

# 画像変換設定
PHOTO_SIZE=640
DEFAULT_QUALITY=30
# 画像処理モード: 1=高速処理(effort=0,smartSubsample=false,回転補正なし), 2=バランス(effort=1,smartSubsample=true,回転補正あり), 3=高圧縮(effort=1,smartSubsample=true,回転補正あり,最適リサイズ)
IMAGE_MODE=2

# キャッシュ設定（ミリ秒）- Ryzen 3950X・64GB最適化
CACHE_TTL_MS=600000
CACHE_MIN_SIZE=2097152

# メモリ管理設定（大量アクセス対策）- Ryzen 3950X・64GB最適化
MAX_CONCURRENCY=16
SHARP_MEMORY_LIMIT=1024
SHARP_PIXEL_LIMIT=100000000

# レート制限設定（大量アクセス対策）- Ryzen 3950X・64GB最適化
RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS=300
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_QUEUE_SIZE=500

# スタック処理システム設定 - Ryzen 3950X・64GB最適化
# スタック処理では複雑な過負荷対策は不要（LIFO方式で最新リクエストが最優先）
STACK_MAX_SIZE=200
STACK_PROCESSING_DELAY_MS=5

# サーバー設定
MAX_LIST=1280

# 再起動設定
RESTART_ENABLED=false
RESTART_TIME=12:10

# ImageMagick設定
MAGICK_PATH=magick
```

#### 設定変更の反映

- **監視間隔**: 10秒間隔で設定ファイルを監視
- **自動反映**: 設定変更を検出すると自動的に反映
- **ログ出力**: 変更内容を詳細にログ出力
- **差分検出**: 前回との差分のみをログ出力（冗長なログを防止）
- **設定値検証**: 不正な値は自動的にデフォルト値で修正
- **入力規則**: 各パラメータの有効範囲を自動チェック

#### 設定値検証機能

設定ファイルの値を自動検証し、不正な値の場合はデフォルト値で修正します：

**検証例**:

```コマンドライン
[2025-10-05T12:55:30] WARN: [設定値無効] MAX_CONCURRENCY: "50" → デフォルト値 16 を使用 (並列数は1-32の範囲)
[2025-10-05T12:55:30] WARN: [設定値無効] DEFAULT_QUALITY: "abc" → デフォルト値 80 を使用 (数値が無効)
[2025-10-05T12:55:30] WARN: [設定値無効] COMPRESSION_ENABLED: "yes" → デフォルト値 true を使用 (真偽値はtrue/false)
```

**検証項目**:

- **数値型**: 範囲チェック（品質: 10-100、サイズ: 100-8192px等）
- **真偽値型**: `true`/`false`のみ有効
- **時刻形式**: `HH:MM`形式（例: `03:00`、`14:30`）
- **パス形式**: 空でない文字列
- **浮動小数点型**: 閾値は0.0-1.0の範囲

### スタック処理システム設定

**実装箇所**: `.core/stack.js`

```javascript
class RequestStack {
  constructor() {
    this.stack = []; // リクエストスタック
    this.processing = false; // 処理中フラグ
    this.maxStackSize = 100; // スタックの最大サイズ
    this.currentFolder = null; // 現在のフォルダパス
    // ... その他の設定
  }
}

// 動的スタック設定読み込み関数
const getStackMaxSize = () => getDynamicConfig('STACK_MAX_SIZE', 100);
const getStackProcessingDelay = () => getDynamicConfig('STACK_PROCESSING_DELAY_MS', 5);
```

**設定項目**:

- `STACK_MAX_SIZE`: スタック最大サイズ（50-500の範囲）
- `STACK_PROCESSING_DELAY_MS`: スタック処理遅延（1-100msの範囲）

### キャッシュ設定

**実装箇所**: `.core/cache.js`

```javascript
const CACHE_DIR = "Y:/caches/webdav/tmp"; // キャッシュディレクトリ
const CLEANUP_INTERVAL_MS = 30 * 60 * 1000; // クリーンアップ間隔（30分）

// 動的キャッシュ設定読み込み関数
const getCacheMinSize = () => getDynamicConfig('CACHE_MIN_SIZE', 1 * 1024 * 1024); // 1MB
const getCacheTTL = () => getDynamicConfig('CACHE_TTL_MS', 5 * 60 * 1000); // 5分
```

### HTTP圧縮設定

**実装箇所**: `.core/webdav.js`

- **圧縮対象**: WebDAVレスポンス（XML、HTML、JSON、テキスト）
- **圧縮アルゴリズム**: gzip
- **圧縮設定**: レベル9、メモリレベル9、ウィンドウビット15
- **圧縮閾値**: デフォルト30%（設定ファイルで変更可能）
- **最小サイズ**: 1KB未満のファイルは圧縮しない

### 環境変数

**実装箇所**: `main.js` 135-136 行

```bash
# ImageMagick のパスを指定（デフォルト: "magick"）
export MAGICK_PATH="/usr/local/bin/magick"

# 自動再起動機能の設定
export RESTART_ENABLED="true"        # 再起動機能の有効/無効
export RESTART_TIME="03:00"          # 再起動時刻（24時間形式、JST）

# HTTP圧縮設定
export COMPRESSION_ENABLED="true"    # 圧縮機能の有効/無効
export COMPRESSION_THRESHOLD="0.3"   # 圧縮閾値（0.0-1.0）
```

### 自動再起動機能

**実装箇所**: `main.js` 122-169 行

毎日特定時刻にプロセスを自動再起動し、メモリリークやリソース問題を防止します。

#### 設定方法

```bash
# Windows (コマンドプロンプト)
set RESTART_ENABLED=true
set RESTART_TIME=03:00
node main.js

# Windows (PowerShell)
$env:RESTART_ENABLED="true"
$env:RESTART_TIME="03:00"
node main.js

# Linux/macOS
export RESTART_ENABLED="true"
export RESTART_TIME="03:00"
node main.js
```

#### 設定オプション

| 環境変数 | 説明 | デフォルト | 例 |
|---------|------|-----------|-----|
| `RESTART_ENABLED` | 再起動機能の有効/無効 | `false` | `"true"`, `"false"` |
| `RESTART_TIME` | 再起動時刻（JST） | `"03:00"` | `"02:30"`, `"14:00"` |

#### 動作仕様

- **チェック間隔**: 1分間隔で現在時刻をチェック
- **予告機能**: 再起動5分前にログで予告
- **グレースフルシャットダウン**: 既存接続の完了を待ってから再起動
- **重複防止**: 同日の重複再起動を防止
- **ログ出力**: 再起動予告と実行ログを記録

#### 使用例

```bash
# 毎日午前3時に再起動
export RESTART_ENABLED="true"
export RESTART_TIME="03:00"

# 毎日午後2時に再起動
export RESTART_ENABLED="true"
export RESTART_TIME="14:00"

# 再起動機能を無効化
export RESTART_ENABLED="false"
```

#### プロセス管理ツールとの連携

PM2などのプロセス管理ツールと組み合わせることで、完全な自動復旧が可能です：

```bash
# PM2での起動例
pm2 start main.js --name webdav-server --restart-delay 5000

# 環境変数付きで起動
RESTART_ENABLED=true RESTART_TIME=03:00 pm2 start main.js
```

## 技術的詳細

### アーキテクチャの特徴

#### ハイブリッド処理システム

- **WebDAV + HTTP**: 単一サーバーで WebDAV プロトコルと HTTP 画像変換を同時処理
- **ストリーミング処理**: 大容量画像でもメモリ効率的な処理を実現
- **原子的操作**: キャッシュ更新時の整合性を保証

#### 高度なキャッシュ戦略

- **多層キャッシュ**: LRU メモリキャッシュ + ファイルベースキャッシュの組み合わせ
- **in-flight deduplication**: 同一画像の同時変換要求を効率的に統合
- **失敗バックオフ**: 連続失敗時の再試行制御によるサーバー保護

#### 適応的スタック処理

- **状況応答処理**: リクエスト数に応じてFIFO/LIFOを自動切り替え
- **少量リクエスト時**: FIFO（先入先出し）で順序を保持し公平性を確保
- **大量リクエスト時**: LIFO（後入先出し）でユーザビリティを優先

#### 並列処理最適化

- **並列数制限**: p-limitによる同時実行数の制御（メモリ枯渇・CPU過負荷防止）
- **in-flight管理**: 重複変換防止とタイムアウト管理による安定性向上
- **動的並列制御**: config.txtのMAX_CONCURRENCYでリアルタイム調整可能
- **ハイブリッド処理**: スタック処理（順次）と並列処理制限の組み合わせ

#### セキュリティ設計

- **パストラバーサル対策**: プラットフォーム対応の安全なパス解決
- **DoS 攻撃防止**: Depth: infinity 拒否による無限探索の防止
- **リソース保護**: 並列度制御とタイムアウト設定による枯渇防止

## パフォーマンス最適化

### Sharp 設定

**実装箇所**: `main.js` 47-80 行

- **並列処理**: CPU 数に応じた最適な並列度（concurrency 制限、メインスレッド保護）
- **メモリキャッシュ**: 1024MB のメモリキャッシュ（同一画像の再変換高速化）
- **ファイルキャッシュ**: 500 個のファイルキャッシュ（ディスク I/O 最適化）
- **アイテムキャッシュ**: 1000 個のアイテムキャッシュ（メタデータ取得高速化）
- **軽量版**: 最速処理モード（effort=0, smartSubsample=false）

### キャッシュ戦略

**実装箇所**: `main.js` 464-472 行

- **ディレクトリリストキャッシュ**: 200,000 エントリ（1 時間 TTL、LRU アルゴリズム、メモリ制限）
- **ファイル統計キャッシュ**: 1,000,000 エントリ（1 時間 TTL、分離設計、TTL 管理）
- **画像変換結果キャッシュ**: ファイルベース（5 分 TTL、原子的更新、競合回避）

### 並列処理制御

**実装箇所**: `main.js` 476 行、796-801 行、926-930 行

- **p-limit**: CPU数×2または32の最大並列度制御（メモリ枯渇と CPU 過負荷の防止）
- **in-flight dedupe**: 重複変換要求の効率的な処理（同一キーの変換要求統合、タイムアウト制御）
- **失敗バックオフ**: 変換失敗時の再試行制御（連続失敗時の再試行制御、リトライ制限）

## トラブルシューティング

### よくある問題

#### 1. ポートが使用中

```コマンドライン
ポート 1900 は既に使用されています。v20.0 (軽量版) の起動をスキップします。
```

**解決方法**: 他のプロセスを終了するか、ポート番号を変更してください。

#### 2. ImageMagick が見つからない

```コマンドライン
[ImageMagick変換失敗] spawn magick ENOENT
```

**解決方法**:

- ImageMagick をインストールする
- 環境変数 `MAGICK_PATH` を設定する
- Sharp のみで動作するため、ImageMagick は必須ではありません

#### 3. キャッシュディレクトリの権限エラー

```コマンドライン
[cache write error] EACCES
```

**解決方法**: キャッシュディレクトリの書き込み権限を確認してください。

#### 4. メモリ不足

```コマンドライン
[Sharp失敗→ImageMagick] out of memory
```

**解決方法**:

- システムのメモリを増やす
- `Photo_Size` を小さくする
- 軽量版を使用する

### ログの確認

サーバーは詳細なログを出力します：

- **リクエスト情報**: アクセス元、メソッド、パス
- **変換処理**: 変換開始・完了、使用エンジン
- **キャッシュ状況**: キャッシュヒット・ミス
- **エラー処理**: フォールバック処理の詳細

### パフォーマンス監視

```bash
# プロセス監視
ps aux | grep node

# メモリ使用量確認
top -p $(pgrep -f "node main.js")

# ディスク使用量確認
du -sh Y:/caches/webdav/tmp
```

## ソースコード構造

### ファイル構成

```コマンドライン
プロジェクトルート/
├── main.js (175行) - メインエントリーポイント
├── config.txt - 動的設定ファイル
├── .core/
│   ├── config.js (434行) - 設定管理・検証・動的読み込み
│   ├── cache.js (148行) - キャッシュシステム管理
│   ├── stack.js (299行) - スタック処理システム
│   ├── image.js (823行) - 画像変換処理
│   └── webdav.js (790行) - WebDAVサーバー実装
└── test.js (11行) - テスト用サーバー
```

### モジュール分割の詳細

**main.js (175行)**:

- モジュール読み込み・共通初期化
- Sharpライブラリのパフォーマンス最適化設定
- 自動再起動機能
- メインループ（単一サーバー起動）

**.core/config.js (434行)**:

- 設定値検証機能
- 動的設定読み込み機能
- 設定ファイル監視・更新
- 各種設定取得関数

**.core/cache.js (148行)**:

- キャッシュディレクトリ管理
- キャッシュクリーンアップ機能
- キャッシュシステム初期化

**.core/stack.js (299行)**:

- RequestStackクラス（LIFO方式のリクエストスタック管理）
- SimpleServerMonitorクラス（スタック処理用の軽量監視機能）
- スタック処理システム初期化

**.core/image.js (823行)**:

- 画像変換エンジン（Sharp/ImageMagick）
- 原子的キャッシュ更新
- ストリーミング処理
- エラーハンドリング・フォールバック

**.core/webdav.js (790行)**:

- WebDAVサーバー実装（RFC4918準拠）
- セキュリティ対策
- HTTP圧縮機能
- キャッシュ機能付きファイルシステム

### 主要な関数・クラス

| 関数/クラス名         | ファイル | 機能                                                                        |
| --------------------- | -------- | --------------------------------------------------------------------------- |
| `configureSharp()`    | main.js  | Sharpライブラリのパフォーマンス最適化設定                                   |
| `validateConfigValue()` | .core/config.js | 設定値検証関数（入力規則チェック、自動修正）                                |
| `getDynamicConfig()`  | .core/config.js | 動的設定読み込み関数（型変換、デフォルト値）                                |
| `loadConfig()`        | .core/config.js | 設定ファイル監視・更新（差分検出、ログ出力）                               |
| `initializeCacheSystem()` | .core/cache.js | キャッシュシステム初期化（ディレクトリ作成、権限確認）                 |
| `RequestStack`        | .core/stack.js | 適応的処理方式のリクエストスタック管理（FIFO/LIFO切り替え、フォルダ変更検出、積極的破棄、強制復旧） |
| `SimpleServerMonitor` | .core/stack.js | スタック処理用の軽量監視機能（リクエストカウント、スタック状況ログ）       |
| `startWebDAV()`       | .core/webdav.js | WebDAV サーバー起動メイン関数（単一サーバー、ハイブリッド処理）             |
| `CachedFileSystem`    | .core/webdav.js | キャッシュ機能付き WebDAV ファイルシステム（LRU キャッシュ統合）            |
| `safeResolve()`       | .core/webdav.js | セキュアなパス解決（パストラバーサル対策、プラットフォーム対応）            |
| `convertAndRespond()` | .core/image.js | 画像変換・レスポンス送信（Sharp/ImageMagick、原子的更新）                   |
| `convertAndRespondWithLimit()` | .core/image.js | 並列制限付き画像変換（p-limit、in-flight管理、重複防止）                    |
| `readdirSyncWrap()`   | .core/webdav.js | 同期ディレクトリ読み込みキャッシュ（ストリーミング読み込み、MAX_LIST 制限） |
| `statSyncWrap()`      | .core/webdav.js | 同期ファイル統計キャッシュ（エラーハンドリング、デフォルト値）              |
| `readdirPWrap()`      | .core/webdav.js | 非同期ディレクトリ読み込みキャッシュ（非同期 opendir、エラー回復）          |
| `statPWrap()`         | .core/webdav.js | 非同期ファイル統計キャッシュ（Promise 対応、エラー処理）                    |

### データフロー

1. **初期化**: main.js → モジュール読み込み → .core/config.js 初期化 → .core/cache.js 初期化 → .core/stack.js 初期化 → Sharp 最適化設定
2. **設定監視**: .core/config.js → 設定ファイル監視 → 設定値検証 → 差分検出 → 環境変数更新 → ログ出力
3. **リクエスト受信**: .core/webdav.js → HTTP サーバー → セキュアパス解決 → 画像拡張子判定
4. **スタック処理**: .core/webdav.js → 画像変換リクエスト → .core/stack.js に追加 → 適応的処理方式（FIFO/LIFO切り替え）で順次処理 → フォルダ変更検出時の自動破棄
5. **画像変換**: .core/image.js → 並列制限チェック → in-flight重複チェック → キャッシュキー生成 → キャッシュチェック → Sharp/ImageMagick 変換 → 原子的キャッシュ更新 → ストリーミングレスポンス
6. **WebDAV 処理**: .core/webdav.js → ファイルシステム操作 → LRU キャッシュ活用 → セキュリティチェック → HTTP圧縮 → レスポンス

## API リファレンス

### 画像変換パラメータ

| パラメータ | 説明     | 範囲  | デフォルト         |
| ---------- | -------- | ----- | ------------------ |
| `q`        | 画像品質 | 30-90 | サーバー設定による |

### レスポンスヘッダー

| ヘッダー             | 説明                           |
| -------------------- | ------------------------------ |
| `Content-Type`       | `image/webp`                   |
| `Content-Length`     | ファイルサイズ                 |
| `Content-Encoding`   | `gzip`（圧縮時）               |
| `Last-Modified`      | 最終更新日時                   |
| `ETag`               | エンティティタグ               |
| `Cache-Control`      | キャッシュ制御                 |
| `Vary`               | `Accept-Encoding`（圧縮時）    |

## ライセンス

ISC

## 更新履歴

- **v23.2.1**: 本格的なeffort設定の導入
  - ⚙️ **設定画面**: 設定画面のUI修正
- **v23.2.0**: 本格的なeffort設定の導入
  - 🔧 **本格的なeffort設定**: effort値を0から6までで設定可能
  - ⚙️ **設定画面**: effort値設定の項目を追加
- **v23.1.2**: 設定画面のUI修正
  - ⚙️ **設定画面**: 画像変換設定のテンプレートを追加、ラベルを修正
- **v23.1.1**: 設定画面のUI修正
  - ⚙️ **設定画面**: 一部UIを大幅改修
- **v23.1.0**: 設定画面のUI修正
  - ⚙️ **設定画面**: 画質テンプレートを用意、ダークモードを導入
- **v23.0.0**: 設定画面の導入
  - ⚙️ **設定画面**: `localhost:1900/setting`でアクセスできる設定画面を導入
- **v22.1.2**: 並列処理性能最適化
  - ⚡ **並列処理制限**: p-limitによる同時実行数制御でメモリ枯渇・CPU過負荷を防止
  - 🔄 **in-flight管理**: 重複変換防止とタイムアウト管理による安定性向上
  - 🎛️ **動的並列制御**: `config.txt`のMAX_CONCURRENCYでリアルタイム調整可能
  - 🔧 **ハイブリッド処理**: スタック処理と並列処理制限の組み合わせ
- **v22.1.1**: 適応的スタック処理システム
  - 🔄 **適応的処理方式**: 30件以下はFIFO、30件超はLIFOで自動切り替え
  - ⚖️ **公平性とユーザビリティの両立**: 少量リクエスト時は順序保持、大量リクエスト時は最新優先
  - 📊 **処理方式の可視化**: ログで現在の処理方式（FIFO/LIFO）を表示
- **v22.1.0**: モジュール分割と単一サーバー化
  - 🏗️ **モジュール分割**: 機能別に分割された保守しやすいアーキテクチャ
  - 🎯 **単一サーバー化**: 複数サーバーから単一サーバーに簡素化
  - 🚫 **ラベルシステム削除**: 不要なサーバーラベルシステムを完全削除
  - 🔧 **画像処理モード**: 3つの処理モード（高速・バランス・高圧縮）を動的切り替え
- **v22.0.0**: スタック処理システムと設定値検証機能を追加
  - 🚀 **スタック処理システム**: リクエストスタックによる順次処理（v22.1.1で適応的処理方式に進化）
  - 🛡️ **設定値検証機能**: `config.txt`の入力規則チェックと自動修正
  - 💾 **動的メモリ管理**: 大量画像処理時のメモリ最適化
  - ⚡ **高スペック環境対応**: Ryzen 3950X・64GB RAM最適化設定
  - 🔧 **エラーハンドリング強化**: Premature closeエラー対策とImageMagick強制終了
  - 📊 **詳細ログ機能**: 変換段階（Sharp/ImageMagick/元画像）の明確化
- **v21.0.1**: `config.txt`のパス指定を修正
- **v21.0.0**: 動的設定読み込み機能、HTTP圧縮機能、高スペック環境最適化を追加
  - 動的設定ファイル監視（`config.txt`）
  - HTTP gzip圧縮（WebDAVレスポンス、テキストファイル）
  - 高スペック環境向け最適化（キャッシュサイズ、並列処理）
  - 設定変更ログの差分出力機能
- **v20.0.2**: 詳細な技術的説明コメントを追加、README.md の実装箇所情報を更新
- **v20.0.1**: ログを整理、README 作成、バージョン記述を `package.json` に移行
- **v20.0**: パフォーマンス改善、エラーハンドリング強化、キャッシュ最適化
- **v19.0**: ？？？
- **v18.0**: ？？？
- **v17.0**: ？？？（暫定安定板）
- **v16.0**: ？？？
- **v15.0**: ？？？
- **v14.0**: ？？？
- **v13.0**: ？？？
- **v12.0**: ？？？
- **v11.0**: ？？？
- **v10.0**: ？？？
- **v9.0**: ？？？
- **v8.0**: ？？？
- **v7.0**: ？？？
- **v6.0**: ？？？
- **v5.0**: ？？？
- **v4.0**: Sharp変換のフォールバックとしてImageMagikと連携
- **v3.0**: Sharp変換の対応フォーマットを指定
- **v2.0**: Sharpによる変換機能を実装
- **v1.0**: シンプルなテスト用サーバー（`test.js`）

## 改善予定・既知の課題

### 🚧 今後の改善予定

#### セキュリティ強化

- **認証機能の追加**: 基本的なユーザー認証システム
- **HTTPS 対応**: SSL/TLS 暗号化通信
- **アクセス制御**: IP アドレス制限、ディレクトリ別権限管理

#### パフォーマンス向上

- **画像形式の拡張**: AVIF、HEIC 出力対応
- **CDN 連携**: 外部 CDN へのキャッシュ配信
- **並列処理の最適化**: より効率的な並列変換処理（✅ 一部実装済み：高スペック環境最適化）

#### 機能拡張

- **Web インターフェース**: ブラウザでのファイル管理 UI
- **API エンドポイント**: RESTful API の提供
- **メタデータ管理**: EXIF 情報の保持・表示
- **バッチ処理**: 複数ファイルの一括変換

#### 運用性向上

- **設定ファイル**: JSON/YAML での設定管理（✅ 一部実装済み：`config.txt`）
- **ログ管理**: 構造化ログ、ログローテーション
- **ヘルスチェック**: サーバー状態監視エンドポイント
- **メトリクス**: パフォーマンス統計の収集

### ⚠️ 既知の課題

#### 現在の制限事項

- **認証なし**: セキュリティリスク（同一ネットワーク内での使用推奨）
- **メモリ使用量**: 大容量画像処理時のメモリ消費（✅ 改善済み：動的メモリ管理機能追加）
- **キャッシュ容量**: ディスク容量の制限
- **同時接続数**: 大量の同時アクセス時の性能低下（✅ 改善済み：スタック処理システム導入）

#### 互換性の問題

- **古いブラウザ**: WebP 非対応ブラウザでの表示問題
- **モバイルアプリ**: 一部アプリでの WebDAV 実装の違い
- **ファイル名**: 特殊文字を含むファイル名の処理

#### パフォーマンス課題

- **初回アクセス**: キャッシュ未生成時の遅延
- **大容量ファイル**: 数 GB の画像ファイルの処理時間
- **ネットワーク**: 低速回線での転送効率

### 🔧 トラブルシューティング

#### Q: モバイルアプリで接続できない

- PC とモバイルが同じネットワークに接続されているか確認
- ファイアウォールでポートが開放されているか確認
- IP アドレスが正しいか確認

#### Q: 画像が表示されない

- 対応形式（JPG, PNG, TIFF など）か確認
- ファイルサイズが大きすぎないか確認
- ブラウザのキャッシュをクリア

#### Q: サーバーが重い

- 同時接続数を制限
- キャッシュディレクトリの容量を確認
- `config.txt`を修正
