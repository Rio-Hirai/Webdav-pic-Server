# WebDAV 画像変換サーバー

高機能な WebDAV サーバーで、画像の自動変換とキャッシュ機能を備えています。

## 概要

このプロジェクトは、複数の設定で WebDAV サーバーを同時起動し、画像ファイルの自動変換（WebP 形式）とキャッシュ機能を提供する Node.js アプリケーションです。

## 主な機能

### 🚀 複数サーバー同時起動

- **軽量版** (ポート 1900): 高速処理重視、品質 50、リサイズ 896px
- **バランス版** (ポート 1901): 品質と速度のバランス、品質 70、リサイズ 1024px
- **オリジナル版** (ポート 1902): 高品質重視、品質 85、リサイズなし

### 🖼️ 画像自動変換

- **対応入力形式**: JPG, JPEG, PNG, TIFF, TIF, BMP, AVIF
- **出力形式**: WebP
- **変換エンジン**: Sharp（高速） + ImageMagick（フォールバック）
- **自動リサイズ**: 設定に応じて最適なサイズに調整
- **品質調整**: クエリパラメータ `?q=70` で指定可能（30-90 の範囲）

### ⚡ 高性能キャッシュシステム

- **LRU キャッシュ**: ディレクトリリストとファイル統計の高速キャッシュ
- **画像キャッシュ**: 1MB 以上の画像のみキャッシュ対象
- **自動クリーンアップ**: 5 分 TTL で古いキャッシュを自動削除
- **重複変換防止**: 同じ画像の同時変換要求を効率的に処理
- **失敗バックオフ**: 変換失敗時の再試行制御

### 🛡️ セキュリティ機能

- **パストラバーサル攻撃対策**: 安全なパス解決
- **Depth: infinity 拒否**: 無限階層のディレクトリ探索を防止
- **ファイルアクセス制限**: ルートディレクトリ外へのアクセスを拒否
- **並列処理制限**: CPU 数に応じた適切な並列度制御

## システム要件

- **Node.js**: 16 以上
- **ImageMagick**: フォールバック用（オプション）
- **ディスク容量**: キャッシュ用の十分な容量
- **メモリ**: 画像処理用の十分なメモリ

## インストール

### 1. 依存関係のインストール

```bash
npm install
```

### 2. ImageMagick のインストール（推奨）

#### Windows

```bash
# Chocolatey を使用する場合
choco install imagemagick

# または公式サイトからダウンロード
# <https://imagemagick.org/script/download.php#windows>
```

#### macOS

```bash
brew install imagemagick
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt-get install imagemagick

# CentOS/RHEL
sudo yum install ImageMagick
```

## 使用方法

### 基本的な起動

```bash
# メインサーバーを起動（3つのサーバーが同時起動）
node main.js

# テスト用のシンプルサーバー
node test.js
```

### アクセス方法

起動後、以下の URL でアクセス可能：

- **軽量版**: http://localhost:1900/
- **バランス版**: http://localhost:1901/
- **オリジナル版**: http://localhost:1902/

### 画像変換の使用例

```bash
# 通常の画像アクセス（自動変換）
http://localhost:1901/path/to/image.jpg

# 品質指定（30-90の範囲）
http://localhost:1901/path/to/image.jpg?q=80

# 自動リサイズ（設定に応じて）
http://localhost:1901/path/to/large_image.jpg
```

## 設定

### サーバー設定の変更

`main.js` の `serverConfigs` 配列を編集：

```javascript
const serverConfigs = [
  {
    PORT: 1900, // ポート番号
    ROOT_PATH: "Z:/", // ルートディレクトリ
    MAX_LIST: 128 * 2, // 最大リスト数（256）
    Photo_Size: 128 * 7, // 画像リサイズサイズ（896px）
    defaultQuality: 50, // デフォルト品質
    label: "v20.0 (軽量版)", // サーバーラベル
  },
  {
    PORT: 1901,
    ROOT_PATH: "Z:/",
    MAX_LIST: 128 * 8, // 最大リスト数（1024）
    Photo_Size: 128 * 8, // 画像リサイズサイズ（1024px）
    defaultQuality: 70,
    label: "v20.1 (バランス版)",
  },
  {
    PORT: 1902,
    ROOT_PATH: "Z:/",
    MAX_LIST: 128 * 32, // 最大リスト数（4096）
    Photo_Size: null, // リサイズなし（オリジナル）
    defaultQuality: 85,
    label: "v20.2 (オリジナル版)",
  },
];
```

### キャッシュ設定

```javascript
const CACHE_DIR = "Y:/caches/webdav/tmp"; // キャッシュディレクトリ
const CACHE_MIN_SIZE = 1 * 1024 * 1024; // キャッシュ最小サイズ（1MB）
const CACHE_TTL_MS = 5 * 60 * 1000; // キャッシュ有効期間（5分）
const CLEANUP_INTERVAL_MS = 30 * 60 * 1000; // クリーンアップ間隔（30分）
```

### 環境変数

```bash
# ImageMagick のパスを指定（デフォルト: "magick"）
export MAGICK_PATH="/usr/local/bin/magick"
```

## パフォーマンス最適化

### Sharp 設定

- **並列処理**: CPU 数に応じた最適な並列度
- **メモリキャッシュ**: 200MB のメモリキャッシュ
- **軽量版**: 最速処理モード（effort=0, smartSubsample=false）

### キャッシュ戦略

- **ディレクトリリストキャッシュ**: 50,000 エントリ（1 時間 TTL）
- **ファイル統計キャッシュ**: 200,000 エントリ（1 時間 TTL）
- **画像変換結果キャッシュ**: ファイルベース（5 分 TTL）

### 並列処理制御

- **p-limit**: CPU 数に応じた適切な並列度制御
- **in-flight dedupe**: 重複変換要求の効率的な処理
- **失敗バックオフ**: 変換失敗時の再試行制御

## トラブルシューティング

### よくある問題

#### 1. ポートが使用中

```
ポート 1900 は既に使用されています。v20.0 (軽量版) の起動をスキップします。
```

**解決方法**: 他のプロセスを終了するか、ポート番号を変更してください。

#### 2. ImageMagick が見つからない

```
[ImageMagick変換失敗] spawn magick ENOENT
```

**解決方法**:

- ImageMagick をインストールする
- 環境変数 `MAGICK_PATH` を設定する
- Sharp のみで動作するため、ImageMagick は必須ではありません

#### 3. キャッシュディレクトリの権限エラー

```
[cache write error] EACCES
```

**解決方法**: キャッシュディレクトリの書き込み権限を確認してください。

#### 4. メモリ不足

```
[Sharp失敗→ImageMagick] out of memory
```

**解決方法**:

- システムのメモリを増やす
- `Photo_Size` を小さくする
- 軽量版を使用する

### ログの確認

サーバーは詳細なログを出力します：

- **リクエスト情報**: アクセス元、メソッド、パス
- **変換処理**: 変換開始・完了、使用エンジン
- **キャッシュ状況**: キャッシュヒット・ミス
- **エラー処理**: フォールバック処理の詳細

### パフォーマンス監視

```bash
# プロセス監視
ps aux | grep node

# メモリ使用量確認
top -p $(pgrep -f "node main.js")

# ディスク使用量確認
du -sh Y:/caches/webdav/tmp
```

## API リファレンス

### 画像変換パラメータ

| パラメータ | 説明     | 範囲  | デフォルト         |
| ---------- | -------- | ----- | ------------------ |
| `q`        | 画像品質 | 30-90 | サーバー設定による |

### レスポンスヘッダー

| ヘッダー         | 説明             |
| ---------------- | ---------------- |
| `Content-Type`   | `image/webp`     |
| `Content-Length` | ファイルサイズ   |
| `Last-Modified`  | 最終更新日時     |
| `ETag`           | エンティティタグ |
| `Cache-Control`  | キャッシュ制御   |

## ライセンス

ISC

## 貢献

プルリクエストやイシューの報告を歓迎します。

## 更新履歴

- **v20.0.1**: パフォーマンス改善、エラーハンドリング強化、キャッシュ最適化
- **v20.0**: 複数サーバー同時起動、画像変換機能追加
- **test.js**: シンプルなテスト用サーバー

## サポート

問題が発生した場合は、以下の情報を含めてイシューを作成してください：

- Node.js のバージョン
- オペレーティングシステム
- エラーメッセージの全文
- 再現手順
