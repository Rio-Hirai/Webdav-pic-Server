# WebDAV 画像変換サーバー

## 目次

- [概要](#概要)
- [主な機能](#主な機能)
- [システム要件](#システム要件)
- [インストール](#インストール)
- [テスト](#テスト)
- [使用方法](#使用方法)
- [設定](#設定)
- [技術的詳細](#技術的詳細)
- [パフォーマンス最適化](#パフォーマンス最適化)
- [トラブルシューティング](#トラブルシューティング)
- [ソースコード構造](#ソースコード構造)
- [API リファレンス](#api-リファレンス)
- [ライセンス](#ライセンス)
- [更新履歴](#更新履歴)
- [改善予定・既知の課題](#改善予定既知の課題)

## 概要

画像最適化に特化した **WebDAV サーバー**です。画像の自動変換（WebP 形式）と高性能キャッシュ機能を備え、**モバイル回線での通信量を大幅に削減**できる Node.js アプリケーションです。

ベースは標準的な WebDAV サーバーなため、画像変換機能に加えて**一般的なファイルサーバーとしての機能も完全に維持**しています。シンボリックリンクやジャンクションにも対応しており、柔軟なファイル管理が可能です。

**重要な特徴**: HTTP レスポンスの特性を活用して画像変換は**要求時にリアルタイムで実行**されます。元ファイルは読み取り専用扱いで保護し、かつ変換後の画像もディスクに保存されません（オプションのキャッシュ機能を除く）。これにより、元データの安全性とストレージ容量の節約を両立しています。

### 🎯 主な用途

- **モバイル回線での画像閲覧**: VPN（[SoftEther](https://ja.softether.org/) など）を介して外出先から自宅サーバーの画像を閲覧
- **通信量削減**: 画像を自動的に WebP 形式に変換し、**画質設定により 60 ～ 90％の通信量を削減**（元の JPEG と比較）
- **リアルタイム変換**: 要求時に Sharp モジュールによって自動変換し、キャッシュ機能により高速な再表示を実現
- **標準的なファイル共有**: Windows エクスプローラー、macOS Finder などの標準クライアントで直接マウント可能

### 📊 SMB との比較

| 項目                                           | SMB（ファイル共有）                                       | 本サーバー（WebDAV + 自動変換）                                                                                |
| ---------------------------------------------- | --------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| **転送速度**                                   | ✅ 高速（生ファイルを直接転送）                           | ⚠️ 変換の処理時間が発生（約 200ms）</br>※低速回線では逆転する場合あり                                           |
| **プロトコルオーバーヘッド**                   | ✅ 小さい（バイナリプロトコル、ヘッダー数十〜数百バイト） | ⚠️ やや大きい（HTTP ベース、ヘッダー数百バイト〜数 KB）</br>※データサイズ削減により相対的な影響は小さい         |
| **通信量**                                     | ❌ 多い（元画像をそのまま転送）                           | ✅ 大幅削減（WebP 変換により 60 ～ 90％削減）                                                                  |
| **元ファイルへの影響**                         | ⚠️ 読み書き可能（誤操作のリスクあり）                     | ✅ **読み取り専用**（HTTP レスポンスのみ変換、元ファイルは保護）                                               |
| **ストレージ容量**                             | ✅ 不要                                                   | ✅ **不要**（変換後画像を保存せず、リアルタイム変換・ストリーミング送信）</br>※オプションのキャッシュ機能を除く |
| **シンボリックリンク**／</br>**ジャンクション** | ⚠️ 一部非対応                                             | ✅ 完全対応                                                                                                    |
| **推奨用途**                                   | ローカルネットワーク内での高速転送                        | モバイル回線や帯域制限時の通信量節約                                                                           |

**推奨される使用場面:**

1. **通信量を節約したい場合**

   - モバイル回線のデータ通信量を節約したい
   - 混雑等で帯域が制限されている
   - 画像の画質をある程度調整しても問題ない

2. **ファイル共有機能を活用したい場合**
   - ファイル共有機能として利用しつつ、通信量を最適化したい
   - シンボリックリンクやジャンクションを活用したい

### 🛠️ 技術的な特徴

- **HTTP レスポンスのみ変換**: 画像変換は HTTP レスポンス送信時のみ実行。**元ファイルには一切影響を与えない**（読み取り専用で安全）
- **リアルタイム変換・ストリーミング**: 変換後画像をディスクに保存せず、要求時にリアルタイムで変換してストリーミング送信。**ストレージ容量を節約**
- **Sharp + ImageMagick ハイブリッド**: Sharp による高速変換を優先し、失敗時や HEIC 画像は ImageMagick に自動フォールバック
- **改良した並列処理制御**: p-limit による改良した並列処理で、複数画像を同時に変換可能（設定値に応じて最大 32 並列）
- **システム情報自動検出**: CPU 数とメモリ情報から推奨並列数を自動算出
- **動的設定管理**: サーバー再起動なしで設定を変更可能（`/setting` UI または `config.txt` 直接編集）
- **動的並列数変更**: 設定変更時に並列制御を自動再初期化（再起動不要）
- **強化されたエラーハンドリング**: ストリーミングエラー/未捕捉例外を安全に処理し、切断時は即時解放

**最新の主要機能**:

- 🖼️ **HEIC/HEIF 形式対応**: ImageMagick への直接ルーティングで HEIC 画像をリアルタイム変換
- ⚙️ **WebP 詳細設定**: preset、reduction effort、effort 設定による高精度圧縮制御
- 📊 **通信量統計ダッシュボード**: 削減できたデータ量やキャッシュヒット率を自動集計し、Web UI と API で確認
- 🎨 **設定画面大幅改善**: テンプレート機能、ダークモード対応、直感的な UI
- ⚡ **Node.js 25.0.0 対応**: JSON.stringify や WebAssembly のパフォーマンス改善を活用
- 🚀 **改良した並列処理**: 画像変換の並列実行を改良し、パフォーマンスを大幅向上
- 🖥️ **システム情報自動検出**: CPU 数とメモリ情報から並列数の推奨値を自動算出
- 🛡️ **設定値検証機能**: config.txt の入力規則チェックと自動修正
- 💾 **動的メモリ管理**: 大量画像処理時のメモリ最適化
- 🏗️ **モジュール分割**: 機能別に分割された保守しやすいアーキテクチャ
- 📝 **動的設定管理**: サーバー再起動なしで全設定を変更可能

## 主な機能

### 🖼️ 画像自動変換

- **対応入力形式**: JPG, JPEG, PNG, TIFF, TIF, BMP, AVIF, **HEIC, HEIF**
- **出力形式**: WebP
- **変換エンジン**: Sharp（高速） + ImageMagick（フォールバック・HEIC 専用）
- **自動リサイズ**: 設定に応じて最適なサイズに調整
- **品質調整**: クエリパラメータ `?q=70` で指定可能（10-100 の範囲）
- **WebP 詳細設定**: preset、reduction effort、effort 設定による高精度圧縮制御

**実装箇所**:

- **画像拡張子判定**: `.core/webdav.js` - `IMAGE_EXTS`配列で対応形式を定義（HEIC/HEIF 含む）
- **変換処理メイン**: `.core/image.js` - `convertAndRespond`関数で Sharp/ImageMagick による変換処理
- **HEIC 専用変換**: `.core/image.js` - `convertHeicWithImageMagick`関数で HEIC 画像の直接ルーティング
- **並列処理制限**: `.core/image.js` - `convertAndRespondWithLimit`関数で改良した並列数制御と in-flight 管理
- **動的並列制御**: `.core/image.js` - `reinitializeConcurrency`関数で設定変更時の並列制御再初期化
- **Sharp 設定**: `main.js` 94-110 行 - パフォーマンス最適化設定（並列度制御、メモリキャッシュ、ファイルキャッシュ）
- **品質パラメータ処理**: `.core/webdav.js` - クエリパラメータ`q`の取得と検証（10-100 の範囲制限）
- **画像処理モード**: `.core/image.js` - 3 つの処理モード（高速処理、バランス処理、高圧縮処理）
- **WebP 詳細設定**: `.core/image.js` - preset、reduction effort、effort 設定による高精度圧縮制御
- **安定性向上（切断/ストリーミング）**:
  - `.core/image.js` - クライアント切断(`close`)時に Sharp パイプラインを破棄
  - `.core/webdav.js` - キャッシュ配信ストリームの `error/close` 監視と安全終了

### ⚡ 高性能キャッシュシステム

- **LRU キャッシュ**: ディレクトリリストとファイル統計の高速キャッシュ
- **画像キャッシュ**: 1MB 以上の画像のみキャッシュ対象
- **自動クリーンアップ**: 5 分 TTL で古いキャッシュを自動削除
- **重複変換防止**: 同じ画像の同時変換要求を効率的に処理
- **失敗バックオフ**: 変換失敗時の再試行制御
- **ストリーム安全化**: キャッシュ配信中のストリーム例外を 500 応答でフェイルセーフ

**実装箇所**:

- **キャッシュ設定**: `.core/cache.js` - キャッシュディレクトリ、TTL、クリーンアップ間隔の設定（ファイルベースキャッシュ、原子的更新、TTL 管理）
- **LRU キャッシュ**: `.core/webdav.js` - ディレクトリリストとファイル統計の LRU キャッシュインスタンス（LRU アルゴリズム、メモリ制限、分離設計）
- **キャッシュラッパー**: `.core/webdav.js` - `readdirSyncWrap`、`statSyncWrap`等のキャッシュ機能付きファイルシステム関数（ストリーミング読み込み、エラーハンドリング）
- **画像キャッシュ**: `.core/webdav.js` - キャッシュキー生成とキャッシュパス設定（SHA-256 ハッシュ、変更検知、衝突回避、Windows パス長制限対策）
- **重複変換防止**: `.core/image.js` - in-flight 変換管理（in-flight deduplication、タイムアウト制御、失敗バックオフ）
- **失敗バックオフ**: `.core/image.js` - 失敗記録と再試行制御（連続失敗時の再試行制御、リトライ制限）
- **自動クリーンアップ**: `.core/cache.js` - `cleanupCache`関数による定期クリーンアップ（非同期処理、TTL 期限切れファイル削除）

### 📊 統計・メトリクス

- **削減量の可視化**: 画像変換とテキスト圧縮で節約できたバイト数・削減率・最大削減量を継続集計
- **キャッシュヒット追跡**: キャッシュ経由レスポンス数やリクエスト総数を記録し、効果を即座に確認
- **Web UI ダッシュボード**: 設定画面下部でライト/ダーク対応のサマリカードとカテゴリ別テーブルを表示（15 秒ごと自動更新＆手動更新ボタン付き）
- **API/ログ連携**: `/setting/stats` エンドポイントまたは `logs/stats.json` を参照して外部可視化基盤へ転送可能

**実装箇所**:

- **集計ロジック**: `.core/stats.js` - request キューによる非同期集計と `logs/stats.json` へのデボンストア
- **記録ポイント**: `.core/webdav.js` / `.core/image.js` - 画像変換（Sharp / ImageMagick）、キャッシュヒット、gzip 圧縮、元画像レスポンス時にレコード追加
- **API**: `.core/webdav.js` - `/setting/stats` で最新のスナップショットを JSON 返却
- **UI**: `public/settings.html` / `public/css/settings.css` - 統計カードとテーブルレイアウト、ライト/ダークテーマ対応

### 🚀 並列処理システム

- **改良した並列実行**: 複数の画像を同時に変換可能（設定値に応じて最大 32 並列）
- **システム情報自動検出**: CPU 数とメモリ情報から推奨並列数を自動算出
- **UI 上限自動設定**: 設定画面の並列数上限をシステム情報に基づいて動的に設定
- **動的並列制御**: config.txt の変更で並列数をリアルタイム調整可能
- **in-flight 重複防止**: 同一画像の同時変換要求を効率的に統合
- **タイムアウト管理**: 長時間残っている変換処理を自動クリーンアップ
- **最上位例外捕捉**: 変換ハンドラ全体を `catch` で保護して継続動作

**実装箇所**:

- **並列制御**: `.core/image.js` - `pLimit`による改良した並列処理制御（並列数制限、in-flight 管理）
- **動的再初期化**: `.core/image.js` - `reinitializeConcurrency`関数で設定変更時の並列制御再初期化
- **設定監視**: `main.js` - 設定変更検出と Sharp 設定の再適用
- **システム情報**: `main.js` - CPU 数とメモリ情報の取得と推奨値算出
- **システム情報 API**: `.core/webdav.js` - `/setting/sysinfo`エンドポイントでシステム情報を公開
- **例外ハンドリング**:
  - `.core/webdav.js` - 画像変換非同期処理の最上位で `catch` を追加
  - `main.js` - `unhandledRejection`/`uncaughtException`/`warning` をロギングして継続

### 🛡️ セキュリティ機能

- **パストラバーサル攻撃対策**: 安全なパス解決
- **Depth: infinity 拒否**: 無限階層のディレクトリ探索を防止
- **ファイルアクセス制限**: ルートディレクトリ外へのアクセスを拒否
- **並列処理制限**: 設定値に応じた適切な並列度制御
- **HTTP 圧縮**: gzip 圧縮による通信量削減
- **動的設定読み込み**: 設定ファイルの変更を自動反映
- **設定値検証**: config.txt の入力規則チェックと自動修正

**実装箇所**:

- **パストラバーサル対策**: `.core/webdav.js` - `safeResolve`関数による安全なパス解決（パストラバーサル対策、プラットフォーム対応、大文字小文字処理、正規化）
- **Depth: infinity 拒否**: `.core/webdav.js` - WebDAV リクエスト前処理ミドルウェア（PROPFIND、Depth: infinity、セキュリティ対策、DoS 攻撃防止）
- **並列処理制限**: `main.js` 93-133 行 - Sharp の動的並列度制御（メモリ枯渇と CPU 過負荷の防止）
- **アクセス制限**: `.core/webdav.js` - プラットフォーム別のパス比較によるアクセス制御（Windows/Unix 系対応、大文字小文字区別）
- **HTTP 圧縮**: `.core/webdav.js` - gzip 圧縮による WebDAV レスポンスとテキストファイルの圧縮（圧縮閾値設定、非同期処理）
- **動的設定読み込み**: `.core/config.js` - `loadConfig`関数による設定ファイル監視と動的更新（差分検出、型変換、ログ出力）
- **設定値検証**: `.core/config.js` - `validateConfigValue`関数による入力規則チェック（数値範囲、真偽値、時刻形式、パス形式の検証）

### 🎨 設定画面システム

- **Web UI**: `localhost:1900/setting`でアクセス可能な設定画面
- **テンプレート機能**: 画質テンプレート（元画質、最低画質、低画質、中画質、高画質）
- **ダークモード対応**: 自動切り替えと手動切り替え
- **リアルタイム保存**: 設定変更の即座反映
- **直感的 UI**: スライダー、セレクトボックス、トグルスイッチ
- **階層表示（子項目インデント）**: 折り畳み対象の子項目にインデント表示を追加（`.row.child`）
- **詳細設定の初期展開**: 「詳細設定」をオンにしている場合、初期表示で関連項目を展開
- **はみ出し防止**: 狭幅時にインデントとスライダー出力の最小幅を調整し数値のはみ出しを防止
- **統計ダッシュボード**: 画面下部で累計削減量・リクエスト件数・カテゴリ別削減率を表示

**実装箇所**:

- **設定画面 UI**: `public/settings.html` - 完全な Web UI 設定画面
- **設定 API**: `.core/webdav.js` - `/setting/data`（読み込み）、`/setting/save`（保存）エンドポイント
- **CSS**: `public/css/settings.css` - ダークモード対応のスタイルシート

### 🚀 単一サーバー動的設定

- **動的設定**: config.txt の変更で即座に反映（サーバー再起動不要）
- **画像処理モード**: 3 つの処理モードを動的に切り替え可能
- **パラメータ調整**: 品質、サイズ、キャッシュ設定等をリアルタイムで調整
- **WebP 詳細設定**: preset、reduction effort、effort 設定の動的変更
- **統計記録**: 画像/テキスト圧縮ごとの削減量・キャッシュヒットを `logs/stats.json` に追記し、API からも取得可能

**実装箇所**: `main.js` 193 行 - `startWebDAV(activeCacheDir)`で単一サーバーを起動

## システム要件

- **Node.js**: 25.0.0 以上（推奨）
- **ImageMagick**: HEIC/HEIF 変換用（必須）
- **ディスク容量**: キャッシュ用の十分な容量
- **メモリ**: 画像処理用の十分なメモリ（推奨: 8GB 以上）

## インストール

### 1. 依存関係のインストール

```bash
npm install
```

### 2. ImageMagick のインストール（ほぼ必須）

#### Windows

```bash
# Chocolatey を使用する場合
choco install imagemagick

# または公式サイトからダウンロード
# <https://imagemagick.org/script/download.php#windows>
```

#### macOS

```bash
brew install imagemagick
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt-get install imagemagick

# CentOS/RHEL
sudo yum install ImageMagick
```

## テスト

本プロジェクトには Jest を使用した自動テストが含まれています。

### テストの実行

```bash
npm test
```

### テスト項目詳細

| テスト対象ファイル | テスト項目 | 内容 |
| :--- | :--- | :--- |
| `stack.js` | **FIFO 処理順序** | スタックサイズが小さい場合、リクエストが先入れ先出し（FIFO）で処理されることを検証 |
| | **LIFO 処理順序** | スタックサイズが大きい場合（>30）、新しいリクエストが優先（LIFO）されることを検証 |
| | **フォルダ変更時の挙動** | 閲覧フォルダが変更された際、古いリクエストスタックがクリアされることを検証 |
| `config.js` | **デフォルト値** | 環境変数が未定義の場合、デフォルト値が返されることを検証 |
| | **数値検証** | 数値設定（`MAX_CONCURRENCY`等）に不正な値（文字列など）が指定された場合、デフォルト値にフォールバックすることを検証 |
| | **数値範囲検証** | 設定値が有効範囲外（例: 0や過大な値）の場合、デフォルト値にフォールバックすることを検証 |
| | **真偽値検証** | 真偽値設定（`COMPRESSION_ENABLED`等）が正しく解析されるか検証 |
| | **浮動小数点検証** | 浮動小数点設定（`COMPRESSION_THRESHOLD`等）が正しく解析されるか検証 |
| `image.js` | **Sharp 変換** | Sharp ライブラリが正しく呼び出され、リサイズと WebP 変換が実行されることを検証（モック使用） |
| | **ImageMagick フォールバック** | Sharp でのエラー発生時に、ImageMagick へのフォールバック処理がトリガーされることを検証 |

### テスト環境について

- テスト実行時は `cross-env` を使用してテスト用の環境変数が設定されます。
- Node.js v25 以降での `localStorage` の問題に対応するため、`NODE_OPTIONS` が自動的に適用されます。
- テスト中に生成される一時ファイル（`test_storage` など）は、テスト完了後に削除して問題ありません。

## 使用方法

### 基本的な起動

```bash
# サーバーを起動
node main.js
```

or

```bash
# サーバーを起動
npm start
```

### アクセス方法

起動後、以下の URL でアクセス可能：

- **WebDAV サーバー**: <http://localhost:1900/> (config.txt の PORT 設定で変更可能)
- **設定画面**: <http://localhost:1900/setting> (Web UI 設定画面)

### モバイル・タブレットでのアクセス

スマートフォンやタブレットから WebDAV サーバーにアクセスするには専用のアプリが必要です：

#### iOS（iPhone/iPad）＆Android

- **Documents by Readdle**: 高機能なファイル管理アプリ
- **ES File Explorer**: シンプルなファイル管理アプリ
- **Owlfiles**: 軽量かつ高速なファイル管理アプリ

#### 設定方法（再起動）

1. アプリをインストール後、WebDAV サーバーを追加
2. サーバー情報を入力：
   - **サーバー**: `http://[PCのIPアドレス]:1900`（例：`http://192.168.1.100:1900`、config.txt で変更可能）
   - **ユーザー名**: 空欄（認証なし）
   - **パスワード**: 空欄（認証なし）
3. 接続してファイルにアクセス

**注意**: PC の IP アドレスを確認するには、コマンドプロンプトで `ipconfig`（Windows）または `ifconfig`（Mac/Linux）を実行してください。

### 画像変換の使用例

```bash
# 通常の画像アクセス（自動変換）
http://localhost:1900/path/to/image.jpg

# HEIC画像の自動変換
http://localhost:1900/path/to/image.heic

# 品質指定（10-100の範囲）
http://localhost:1900/path/to/image.jpg?q=80

# 自動リサイズ（設定に応じて）
http://localhost:1900/path/to/large_image.jpg
```

## 設定

### HTTPS/SSL証明書の設定

HTTPSモードでサーバーを起動するには、SSL証明書と秘密鍵ファイルが必要です。

#### 方法1: 自己署名証明書（開発・テスト用）

ローカル環境や開発環境で使用する場合は、自己署名証明書を生成できます。

**Windows (OpenSSLを使用):**

1. OpenSSLをインストール（未インストールの場合）:
   ```bash
   # Chocolateyを使用する場合
   choco install openssl

   # または公式サイトからダウンロード
   # https://slproweb.com/products/Win32OpenSSL.html
   ```

2. 証明書ディレクトリを作成:
   ```bash
   mkdir ssl
   cd ssl
   ```

3. 秘密鍵を生成:
   ```bash
   openssl genrsa -out private.key 2048
   ```

4. 証明書署名要求(CSR)を生成:
   ```bash
   openssl req -new -key private.key -out certificate.csr
   ```
   - プロンプトで情報を入力（Common NameにはサーバーのIPアドレスまたはホスト名を入力）

5. 自己署名証明書を生成:
   ```bash
   openssl x509 -req -days 365 -in certificate.csr -signkey private.key -out certificate.crt
   ```

6. `config.txt`に設定を追加:
   ```txt
   SSL_CERT_PATH=ssl/certificate.crt
   SSL_KEY_PATH=ssl/private.key
   ```

**注意**: 自己署名証明書はブラウザで警告が表示されます。開発環境でのみ使用してください。

#### 方法2: mkcert（開発用、簡単）

mkcertを使用すると、ローカル開発用の信頼された証明書を簡単に生成できます。

1. mkcertをインストール:
   ```bash
   # Chocolateyを使用する場合
   choco install mkcert
   
   # またはGitHubからダウンロード
   # https://github.com/FiloSottile/mkcert/releases
   ```

2. ローカルCAをインストール:
   ```bash
   mkcert -install
   ```

3. 証明書を生成:
   ```bash
   mkdir ssl
   cd ssl
   mkcert localhost 127.0.0.1 ::1
   ```
   これで`localhost+2.pem`（証明書）と`localhost+2-key.pem`（秘密鍵）が生成されます。

4. `config.txt`に設定を追加:
   ```txt
   SSL_CERT_PATH=ssl/localhost+2.pem
   SSL_KEY_PATH=ssl/localhost+2-key.pem
   ```

#### 方法3: Let's Encrypt（本番環境用）

本番環境で使用する場合は、Let's Encryptの無料証明書を使用できます。

1. Certbotをインストール:
   ```bash
   # Windows (WSLを使用する場合)
   sudo apt-get update
   sudo apt-get install certbot
   ```

2. 証明書を取得:
   ```bash
   sudo certbot certonly --standalone -d yourdomain.com
   ```

3. 証明書ファイルの場所を確認:
   - 証明書: `/etc/letsencrypt/live/yourdomain.com/fullchain.pem`
   - 秘密鍵: `/etc/letsencrypt/live/yourdomain.com/privkey.pem`

4. `config.txt`に設定を追加:
   ```txt
   SSL_CERT_PATH=/etc/letsencrypt/live/yourdomain.com/fullchain.pem
   SSL_KEY_PATH=/etc/letsencrypt/live/yourdomain.com/privkey.pem
   ```

**注意**: Let's Encryptの証明書は90日で期限切れになるため、自動更新の設定が必要です。

#### 証明書ファイルの配置

証明書ファイルは以下のように配置することを推奨します:

```
プロジェクトルート/
├── ssl/
│   ├── certificate.crt  (または fullchain.pem)
│   └── private.key     (または privkey.pem)
├── config.txt
└── main.js
```

#### 設定例

`config.txt`に以下のように設定します:

```txt
# SSL/HTTPS設定
SSL_CERT_PATH=ssl/certificate.crt
SSL_KEY_PATH=ssl/private.key
```

証明書が設定されていない場合、サーバーはHTTPモードで起動します（後方互換性）。

### 設定画面での設定変更

**Web UI 設定画面**: <http://localhost:1900/setting>

設定画面では以下の操作が可能です：

- **テンプレート選択**: 画質テンプレート（元画質、最低画質、低画質、中画質、高画質）
- **スライダー調整**: 画像サイズ、品質、WebP 設定の直感的な調整
- **モード選択**: 画像処理モード（高速、バランス、高圧縮）
- **詳細設定**: WebP preset、reduction effort、effort 設定
- **リアルタイム保存**: 設定変更の即座反映

### サーバー設定の変更

**実装箇所**: `config.txt`

`config.txt` ファイルを編集してサーバー設定を変更：

```txt
# サーバー設定
PORT=1900
ROOT_PATH=Z:/書籍
MAX_LIST=1280
```

### 動的設定ファイル (`config.txt`)

**実装箇所**: `.core/config.js`

サーバー再起動なしで設定を変更できる動的設定ファイル機能：

#### 設定ファイルの場所

```コマンドライン
./config.txt
```

#### 対応設定項目

| 設定項目                | 説明                                | デフォルト値    | 有効範囲         | 例                                                       |
| ----------------------- | ----------------------------------- | --------------- | ---------------- | -------------------------------------------------------- |
| `PHOTO_SIZE`            | 画像リサイズサイズ                  | `640`           | 100-8192px       | `640`, `1024`, `1920`                                    |
| `DEFAULT_QUALITY`       | デフォルト品質                      | `30`            | 10-100           | `40`, `70`, `85`                                         |
| `MAX_LIST`              | 最大リスト数                        | `1280`          | 10-10000         | `896`, `1024`, `4096`                                    |
| `IMAGE_MODE`            | 画像処理モード                      | `2`             | 1-3              | `1`(高速), `2`(バランス), `3`(高圧縮)                    |
| `CACHE_TTL_MS`          | キャッシュ有効期間（ミリ秒）        | `300000` (5 分) | 1 分-24 時間     | `600000`, `1800000`                                      |
| `CACHE_MIN_SIZE`        | キャッシュ最小サイズ（バイト）      | `1048576` (1MB) | 1KB-100MB        | `2097152`, `524288`                                      |
| `COMPRESSION_ENABLED`   | HTTP 圧縮の有効/無効                | `true`          | `true`/`false`   | `true`, `false`                                          |
| `COMPRESSION_THRESHOLD` | 圧縮閾値（0.0-1.0）                 | `0.3` (30%)     | 0.0-1.0          | `0.2`, `0.5`                                             |
| `MAX_CONCURRENCY`       | 最大並列処理数                      | `2`             | 1-32             | `4`, `8`, `16`                                           |
| `SHARP_MEMORY_LIMIT`    | Sharp メモリキャッシュ制限（MB）    | `64`            | 16-4096MB        | `128`, `256`, `1024`                                     |
| `SHARP_PIXEL_LIMIT`     | Sharp ピクセル制限                  | `10000000`      | 1M-1000M         | `25000000`, `100000000`                                  |
| `RATE_LIMIT_ENABLED`    | レート制限の有効/無効               | `true`          | `true`/`false`   | `true`, `false`                                          |
| `RATE_LIMIT_REQUESTS`   | 1 分間あたりのリクエスト数          | `50`            | 1-1000           | `100`, `300`, `500`                                      |
| `RATE_LIMIT_WINDOW_MS`  | レート制限時間窓（ミリ秒）          | `60000`         | 1 秒-5 分        | `30000`, `120000`                                        |
| `RATE_LIMIT_QUEUE_SIZE` | レート制限キューサイズ              | `100`           | 10-1000          | `200`, `500`                                             |
| `STACK_MAX_SIZE`        | スタック最大サイズ                  | `100`           | 50-500           | `200`, `300`                                             |
| `WEBP_EFFORT`           | WebP 圧縮努力レベル                 | `1`             | 0-6              | `0`(最速), `3`(標準), `6`(最高圧縮)                      |
| `WEBP_EFFORT_FAST`      | WebP 圧縮努力レベル（高速モード用） | `0`             | 0-2              | `0`(最速), `1`(標準), `2`(高圧縮)                        |
| `WEBP_PRESET`           | WebP プリセット                     | `default`       | 有効なプリセット | `default`, `photo`, `picture`, `drawing`, `icon`, `text` |
| `WEBP_REDUCTION_EFFORT` | WebP reduction effort               | `0`             | 0-6              | `0`(最速), `3`(標準), `6`(最高圧縮)                      |

#### 設定ファイル例

```txt
# WebDAV画像変換サーバー設定ファイル
# 設定変更後、サーバーの自動再読み込み（10秒以内）

# 圧縮設定
COMPRESSION_ENABLED=true
COMPRESSION_THRESHOLD=0.3

# 画像変換設定
PHOTO_SIZE=640
DEFAULT_QUALITY=30
# 画像処理モード: 1=高速処理(effort=0,smartSubsample=false,回転補正なし), 2=バランス(effort=1,smartSubsample=true,回転補正あり), 3=高圧縮(effort=1,smartSubsample=true,回転補正あり,最適リサイズ)
IMAGE_MODE=2

# WebP詳細設定
WEBP_EFFORT=1
WEBP_EFFORT_FAST=0
WEBP_PRESET=default
WEBP_REDUCTION_EFFORT=0

# キャッシュ設定（ミリ秒）- Ryzen 3950X・64GB最適化
CACHE_TTL_MS=600000
CACHE_MIN_SIZE=2097152

# メモリ管理設定（大量アクセス対策）- Ryzen 3950X・64GB最適化
MAX_CONCURRENCY=16
SHARP_MEMORY_LIMIT=1024
SHARP_PIXEL_LIMIT=100000000

# レート制限設定（大量アクセス対策）- Ryzen 3950X・64GB最適化
RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS=300
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_QUEUE_SIZE=500

# 並列処理設定 - Ryzen 3950X・64GB最適化
MAX_CONCURRENCY=16

# サーバー設定
MAX_LIST=1280

# 再起動設定
RESTART_ENABLED=false
RESTART_TIME=12:10

# ImageMagick設定
MAGICK_PATH=magick
```

#### 設定変更の反映

- **監視間隔**: 10 秒間隔で設定ファイルを監視
- **自動反映**: 設定変更を検出すると自動的に反映
- **ログ出力**: 変更内容を詳細にログ出力
- **差分検出**: 前回との差分のみをログ出力（冗長なログを防止）
- **設定値検証**: 不正な値は自動的にデフォルト値で修正
- **入力規則**: 各パラメータの有効範囲を自動チェック

#### 設定値検証機能

設定ファイルの値を自動検証し、不正な値の場合はデフォルト値で修正します：

**検証例**:

```コマンドライン
[2025-10-05T12:55:30] WARN: [設定値無効] MAX_CONCURRENCY: "50" → デフォルト値 16 を使用 (並列数は1-32の範囲)
[2025-10-05T12:55:30] WARN: [設定値無効] DEFAULT_QUALITY: "abc" → デフォルト値 80 を使用 (数値が無効)
[2025-10-05T12:55:30] WARN: [設定値無効] COMPRESSION_ENABLED: "yes" → デフォルト値 true を使用 (真偽値はtrue/false)
```

**検証項目**:

- **数値型**: 範囲チェック（品質: 10-100、サイズ: 100-8192px 等）
- **真偽値型**: `true`/`false`のみ有効
- **時刻形式**: `HH:MM`形式（例: `03:00`、`14:30`）
- **パス形式**: 空でない文字列
- **浮動小数点型**: 閾値は 0.0-1.0 の範囲

### 並列処理設定

**実装箇所**: `.core/image.js`

```javascript
// 並列制御の初期化
let conversionLimit = pLimit(getMaxConcurrency());

// 並列数を再初期化する関数（設定変更時に呼び出し）
function reinitializeConcurrency() {
  const newConcurrency = getMaxConcurrency();
  conversionLimit = pLimit(newConcurrency);
  logger.info(`[並列制御再初期化] 最大並列数: ${newConcurrency}`);
}
```

**設定項目**:

- `MAX_CONCURRENCY`: 最大並列処理数（1-32 の範囲、デフォルト: 16）

### キャッシュ設定

**実装箇所**: `.core/cache.js`

```javascript
const CACHE_DIR = "Y:/caches/webdav/tmp"; // キャッシュディレクトリ
const CLEANUP_INTERVAL_MS = 30 * 60 * 1000; // クリーンアップ間隔（30分）

// 動的キャッシュ設定読み込み関数
const getCacheMinSize = () => getDynamicConfig("CACHE_MIN_SIZE", 1 * 1024 * 1024); // 1MB
const getCacheTTL = () => getDynamicConfig("CACHE_TTL_MS", 5 * 60 * 1000); // 5分
```

### HTTP 圧縮設定

**実装箇所**: `.core/webdav.js`

- **圧縮対象**: WebDAV レスポンス（XML、HTML、JSON、テキスト）
- **圧縮アルゴリズム**: gzip
- **圧縮設定**: レベル 9、メモリレベル 9、ウィンドウビット 15
- **圧縮閾値**: デフォルト 30%（設定ファイルで変更可能）
- **最小サイズ**: 1KB 未満のファイルは圧縮しない

### 環境変数

**実装箇所**: `main.js` 135-136 行

```bash
# ImageMagick のパスを指定（デフォルト: "magick"）
export MAGICK_PATH="/usr/local/bin/magick"

# 自動再起動機能の設定
export RESTART_ENABLED="true"        # 再起動機能の有効/無効
export RESTART_TIME="03:00"          # 再起動時刻（24時間形式、JST）

# HTTP圧縮設定
export COMPRESSION_ENABLED="true"    # 圧縮機能の有効/無効
export COMPRESSION_THRESHOLD="0.3"   # 圧縮閾値（0.0-1.0）
```

### 自動再起動機能

**実装箇所**: `main.js` 122-169 行

毎日特定時刻にプロセスを自動再起動し、メモリリークやリソース問題を防止します。

#### 設定方法

```bash
# Windows (コマンドプロンプト)
set RESTART_ENABLED=true
set RESTART_TIME=03:00
node main.js

# Windows (PowerShell)
$env:RESTART_ENABLED="true"
$env:RESTART_TIME="03:00"
node main.js

# Linux/macOS
export RESTART_ENABLED="true"
export RESTART_TIME="03:00"
node main.js
```

#### 設定オプション

| 環境変数          | 説明                  | デフォルト | 例                   |
| ----------------- | --------------------- | ---------- | -------------------- |
| `RESTART_ENABLED` | 再起動機能の有効/無効 | `false`    | `"true"`, `"false"`  |
| `RESTART_TIME`    | 再起動時刻（JST）     | `"03:00"`  | `"02:30"`, `"14:00"` |

#### 動作仕様

- **チェック間隔**: 1 分間隔で現在時刻をチェック
- **予告機能**: 再起動 5 分前にログで予告
- **グレースフルシャットダウン**: 既存接続の完了を待ってから再起動
- **重複防止**: 同日の重複再起動を防止
- **ログ出力**: 再起動予告と実行ログを記録

#### 使用例

```bash
# 毎日午前3時に再起動
export RESTART_ENABLED="true"
export RESTART_TIME="03:00"

# 毎日午後2時に再起動
export RESTART_ENABLED="true"
export RESTART_TIME="14:00"

# 再起動機能を無効化
export RESTART_ENABLED="false"
```

#### プロセス管理ツールとの連携

PM2 などのプロセス管理ツールと組み合わせることで、完全な自動復旧が可能です：

```bash
# PM2での起動例
pm2 start main.js --name webdav-server --restart-delay 5000

# 環境変数付きで起動
RESTART_ENABLED=true RESTART_TIME=03:00 pm2 start main.js
```

## 技術的詳細

### アーキテクチャの特徴

#### ハイブリッド処理システム

- **WebDAV + HTTP**: 単一サーバーで WebDAV プロトコルと HTTP 画像変換を同時処理
- **ストリーミング処理**: 大容量画像でもメモリ効率的な処理を実現
- **原子的操作**: キャッシュ更新時の整合性を保証

#### 高度なキャッシュ戦略

- **多層キャッシュ**: LRU メモリキャッシュ + ファイルベースキャッシュの組み合わせ
- **in-flight deduplication**: 同一画像の同時変換要求を効率的に統合
- **失敗バックオフ**: 連続失敗時の再試行制御によるサーバー保護

#### 並列処理最適化

- **改良した並列実行**: p-limit による改良した並列処理で、複数画像を同時に変換
- **並列数制限**: 設定値に応じた同時実行数の制御（メモリ枯渇・CPU 過負荷防止）
- **in-flight 管理**: 重複変換防止とタイムアウト管理による安定性向上
- **動的並列制御**: config.txt の MAX_CONCURRENCY でリアルタイム調整可能（再起動不要）

#### セキュリティ設計

- **パストラバーサル対策**: プラットフォーム対応の安全なパス解決
- **DoS 攻撃防止**: Depth: infinity 拒否による無限探索の防止
- **リソース保護**: 並列度制御とタイムアウト設定による枯渇防止

## パフォーマンス最適化

### Sharp 設定

**実装箇所**: `main.js` 93-133 行

- **システム情報自動検出**: CPU 数とメモリ情報から推奨並列数を自動算出
- **並列処理**: 設定値に応じた最適な並列度（config.txt の MAX_CONCURRENCY で制御）
- **メモリキャッシュ**: 設定値に応じたメモリキャッシュ（同一画像の再変換高速化）
- **ファイルキャッシュ**: 150 個のファイルキャッシュ（ディスク I/O 最適化）
- **アイテムキャッシュ**: 300 個のアイテムキャッシュ（メタデータ取得高速化）

### キャッシュ戦略

**実装箇所**: キャッシュシステム

- **ディレクトリリストキャッシュ**: 200,000 エントリ（1 時間 TTL、LRU アルゴリズム、メモリ制限）
- **ファイル統計キャッシュ**: 1,000,000 エントリ（1 時間 TTL、分離設計、TTL 管理）
- **画像変換結果キャッシュ**: ファイルベース（5 分 TTL、原子的更新、競合回避）

### 並列処理制御

**実装箇所**: `.core/image.js`、`main.js`

- **p-limit**: 設定値による最大並列度制御（メモリ枯渇と CPU 過負荷の防止）
- **in-flight dedupe**: 重複変換要求の効率的な処理（同一キーの変換要求統合、タイムアウト制御）
- **失敗バックオフ**: 変換失敗時の再試行制御（連続失敗時の再試行制御、リトライ制限）
- **動的再初期化**: 設定変更時の並列制御自動再初期化（再起動不要）
- **システム情報 API**: `/setting/sysinfo`エンドポイントで CPU・メモリ情報と推奨値を取得可能

## トラブルシューティング

### よくある問題

#### 1. ポートが使用中

```コマンドライン
ポート 1900 は既に使用されています。v20.0 (軽量版) の起動をスキップします。
```

**解決方法**: 他のプロセスを終了するか、ポート番号を変更してください。

#### 2. ImageMagick が見つからない

```コマンドライン
[ImageMagick変換失敗] spawn magick ENOENT
```

**解決方法**:

- ImageMagick をインストールする
- 環境変数 `MAGICK_PATH` を設定する
- Sharp のみで動作するため、ImageMagick は必須ではありません

#### 3. キャッシュディレクトリの権限エラー

```コマンドライン
[cache write error] EACCES
```

**解決方法**: キャッシュディレクトリの書き込み権限を確認してください。

#### 4. メモリ不足

```コマンドライン
[Sharp失敗→ImageMagick] out of memory
```

**解決方法**:

- システムのメモリを増やす
- `Photo_Size` を小さくする
- 軽量版を使用する

### ログの確認

サーバーは詳細なログを出力します：

- **リクエスト情報**: アクセス元、メソッド、パス
- **変換処理**: 変換開始・完了、使用エンジン
- **キャッシュ状況**: キャッシュヒット・ミス
- **エラー処理**: フォールバック処理の詳細
- **ストリームエラー**: キャッシュ配信時の `error`/`close` の詳細

### パフォーマンス監視

```bash
# プロセス監視
ps aux | grep node

# メモリ使用量確認
top -p $(pgrep -f "node main.js")

# ディスク使用量確認
du -sh Y:/caches/webdav/tmp
```

## ソースコード構造

### ファイル構成

```コマンドライン
プロジェクトルート/
├── main.js (149行) - メインエントリーポイント
├── config.txt - 動的設定ファイル
├── .core/
│   ├── config.js (460行) - 設定管理・検証・動的読み込み
│   ├── cache.js (148行) - キャッシュシステム管理
│   ├── image.js (1331行) - 画像変換処理
│   └── webdav.js (667行) - WebDAVサーバー実装
└── test.js (11行) - テスト用サーバー
```

### モジュール分割の詳細

**main.js (149 行)**:

- モジュール読み込み・共通初期化
- システム情報取得と推奨値算出
- Sharp ライブラリのパフォーマンス最適化設定
- 設定変更監視と Sharp 設定の再適用
- 自動再起動機能
- メインループ（単一サーバー起動）

**.core/config.js (460 行)**:

- 設定値検証機能
- 動的設定読み込み機能
- 設定ファイル監視・更新
- 各種設定取得関数

**.core/cache.js (148 行)**:

- キャッシュディレクトリ管理
- キャッシュクリーンアップ機能
- キャッシュシステム初期化

**.core/image.js (1331 行)**:

- 画像変換エンジン（Sharp/ImageMagick）
- 並列処理制御（p-limit）
- in-flight 重複防止
- 動的並列制御再初期化
- 原子的キャッシュ更新
- ストリーミング処理
- エラーハンドリング・フォールバック

**.core/webdav.js (667 行)**:

- WebDAV サーバー実装（RFC4918 準拠）
- セキュリティ対策
- HTTP 圧縮機能
- キャッシュ機能付きファイルシステム
- システム情報 API（`/setting/sysinfo`）

### 主要な関数・クラス

| 関数/クラス名                  | ファイル        | 機能                                                                             |
| ------------------------------ | --------------- | -------------------------------------------------------------------------------- |
| `configureSharp()`             | main.js         | Sharp ライブラリのパフォーマンス最適化設定                                       |
| `validateConfigValue()`        | .core/config.js | 設定値検証関数（入力規則チェック、自動修正）                                     |
| `getDynamicConfig()`           | .core/config.js | 動的設定読み込み関数（型変換、デフォルト値）                                     |
| `loadConfig()`                 | .core/config.js | 設定ファイル監視・更新（差分検出、ログ出力）                                     |
| `initializeCacheSystem()`      | .core/cache.js  | キャッシュシステム初期化（ディレクトリ作成、権限確認）                           |
| `startWebDAV()`                | .core/webdav.js | WebDAV サーバー起動メイン関数（単一サーバー、ハイブリッド処理）                  |
| `CachedFileSystem`             | .core/webdav.js | キャッシュ機能付き WebDAV ファイルシステム（LRU キャッシュ統合）                 |
| `safeResolve()`                | .core/webdav.js | セキュアなパス解決（パストラバーサル対策、プラットフォーム対応）                 |
| `convertAndRespond()`          | .core/image.js  | 画像変換・レスポンス送信（Sharp/ImageMagick、原子的更新）                        |
| `convertAndRespondWithLimit()` | .core/image.js  | 並列制限付き画像変換（p-limit による改良した並列処理、in-flight 管理、重複防止） |
| `reinitializeConcurrency()`    | .core/image.js  | 並列制御の動的再初期化（設定変更時に自動実行）                                   |
| `getSystemInfo()`              | main.js         | システム情報取得（CPU 数、メモリ情報、推奨値算出）                               |
| `readdirSyncWrap()`            | .core/webdav.js | 同期ディレクトリ読み込みキャッシュ（ストリーミング読み込み、MAX_LIST 制限）      |
| `statSyncWrap()`               | .core/webdav.js | 同期ファイル統計キャッシュ（エラーハンドリング、デフォルト値）                   |
| `readdirPWrap()`               | .core/webdav.js | 非同期ディレクトリ読み込みキャッシュ（非同期 opendir、エラー回復）               |
| `statPWrap()`                  | .core/webdav.js | 非同期ファイル統計キャッシュ（Promise 対応、エラー処理）                         |

### データフロー

1. **初期化**: main.js → モジュール読み込み → .core/config.js 初期化 → .core/cache.js 初期化 → Sharp 最適化設定 → 設定変更監視開始
2. **設定監視**: main.js → 10 秒間隔で設定ファイル監視 → 設定値検証 → 差分検出 → Sharp 設定・並列制御再初期化
3. **リクエスト受信**: .core/webdav.js → HTTP サーバー → セキュアパス解決 → 画像拡張子判定
4. **並列処理**: .core/webdav.js → 画像変換リクエスト → 非同期関数で直接実行 → p-limit による並列制御
5. **画像変換**: .core/image.js → 並列制限チェック → in-flight 重複チェック → キャッシュキー生成 → キャッシュチェック → Sharp/ImageMagick 変換 → 原子的キャッシュ更新 → ストリーミングレスポンス
6. **WebDAV 処理**: .core/webdav.js → ファイルシステム操作 → LRU キャッシュ活用 → セキュリティチェック → HTTP 圧縮 → レスポンス

## API リファレンス

### 画像変換パラメータ

| パラメータ | 説明     | 範囲   | デフォルト         |
| ---------- | -------- | ------ | ------------------ |
| `q`        | 画像品質 | 10-100 | サーバー設定による |

### レスポンスヘッダー

| ヘッダー           | 説明                        |
| ------------------ | --------------------------- |
| `Content-Type`     | `image/webp`                |
| `Content-Length`   | ファイルサイズ              |
| `Content-Encoding` | `gzip`（圧縮時）            |
| `Last-Modified`    | 最終更新日時                |
| `ETag`             | エンティティタグ            |
| `Cache-Control`    | キャッシュ制御              |
| `Vary`             | `Accept-Encoding`（圧縮時） |

## ライセンス

ISC

## 更新履歴

- **v24.8.0**: ポップアップ表示
  - 📊 **ポップアップ表示**: 設定保存・読み込み・統計パネル再読込などの状態を画面上部のポップアップで案内
- **v24.7.0**: 統計収集＆表示機能を追加
  - 📊 **通信量統計の表示**: logs/stats.json 蓄積、/setting/stats API、設定画面の通信量ダッシュボード、スマホ横スクロール対応サマリカード
- **v24.6.0**: 画像変換機能の切り替え
  - ⚡ **画像変換機能のオンオフ**: 画像変換機能をオフにして一般的な WebDAV サーバーとしても使用可能
- **v24.5.0**: エラーハンドリングによる安定性向上
  - 🧯 キャッシュ配信ストリームの `error/close` ハンドリングを追加（安全に 500 応答）
  - 🔒 変換ハンドラ全体を `catch` で保護し、未捕捉例外でもサーバー継続
  - 🧹 クライアント切断時に Sharp パイプラインを破棄してリソースリーク防止
  - 🧰 既存の並列処理/キャッシュ/フォールバック動作に影響しない非侵襲実装
- **v24.4.1**: 設定 UI の視認性向上とレイアウト調整
  - 🎛️ **詳細設定の初期展開**: 「詳細設定 (WEBP_DETAILED_ENABLED)」がオンなら初期状態で折り畳み項目を表示
  - 📐 **子項目インデント**: 折り畳み対象の行にインデント（`.row.child`）を適用して階層を視覚化
  - 🧩 **はみ出し対策**: 狭幅時のインデント軽減とスライダー/数値出力の最小幅見直しで表示崩れを防止
- **v24.4.0**: システム情報自動検出
  - 🖥️ **システム情報自動検出**: CPU 数とメモリ情報から並列数の推奨値を自動算出
  - 🎯 **UI 上限自動設定**: 設定画面の並列数上限をシステム情報に基づいて動的に設定
- **v24.3.0**: 並列処理の実装修正
  - 🚀 **改良した並列処理**: 画像変換のスタック処理を除去し、p-limit による改良した並列処理を実装
  - ⚡ **パフォーマンス向上**: 複数画像を同時に変換可能になり、処理速度が大幅に向上
  - 🔄 **動的並列制御**: 設定変更時の並列制御自動再初期化機能を追加
  - 📊 **設定監視強化**: 設定変更検出と Sharp 設定の自動再適用機能を追加
- **v24.2.0**: キャッシュキー生成の最適化
  - 🔧 **SHA-256 ハッシュ化**: キャッシュキーを SHA-256 ハッシュで生成し、Windows のパス長制限（260 文字）を回避
  - 🛡️ **長いファイルパス対応**: 日本語を含む長いファイルパスでもキャッシュ機能が正常に動作
- **v24.1.0**: HEIC 形式に対応
  - 🔄 **HEIC/HEIF 形式対応**: ImageMagick への直接ルーティングで HEIC/HEIF 形式もリアルタイム変換に対応
- **v24.0.0**: Node.js 25.0.0 対応
  - ⚡ **最新 Node.js 対応**: JSON.stringify や WebAssembly のパフォーマンス改善により高速化
  - 🎨 **設定画面改善**: 不完全な自動再起動機能に関する UI を削除（自動再起動機能の実装が成功次第復活予定）
- **v23.3.0**: preset と reductionEffort パラメータを導入
  - 🔧 **preset と reductionEffort パラメータ**: preset と reductionEffort を設定可能
  - 🎨 **設定画面改善**: preset と reductionEffort パラメータ設定用の項目を追加
- **v23.2.1**: 設定画面の UI 修正
  - 🎨 **設定画面改善**: effort 用の UI を修正
- **v23.2.0**: 本格的な effort 設定の導入
  - 🔧 **本格的な effort 設定**: effort 値を 0 から 6 までで設定可能。圧縮率が**最大 50％**UP
  - 🎨 **設定画面改善**: effort 値設定用の項目を追加
- **v23.1.2**: 設定画面の UI 修正
  - 🎨 **設定画面改善**: 画像変換設定のテンプレートを追加、ラベルを修正
- **v23.1.1**: 設定画面の UI 修正
  - 🎨 **設定画面改善**: 直感的な UI
- **v23.1.0**: 設定画面の UI 修正
  - 🎨 **設定画面改善**: テンプレート機能、ダークモード対応、直感的な UI
- **v23.0.0**: 設定画面の導入
  - ⚙️ **設定画面**: `localhost:1900/setting`でアクセスできる設定画面を導入
- **v22.1.2**: 並列処理性能最適化（v24.3.0 で大幅改良）
  - ⚡ **並列処理制限**: p-limit による同時実行数制御でメモリ枯渇・CPU 過負荷を防止
  - 🔄 **in-flight 管理**: 重複変換防止とタイムアウト管理による安定性向上
  - 🎛️ **動的並列制御**: `config.txt`の MAX_CONCURRENCY でリアルタイム調整可能
- **v22.1.1**: 適応的スタック処理システム（v24.3.0 で画像変換から除去）
  - 🔄 **適応的処理方式**: 30 件以下は FIFO、30 件超は LIFO で自動切り替え
  - ⚖️ **公平性とユーザビリティの両立**: 少量リクエスト時は順序保持、大量リクエスト時は最新優先
  - 📊 **処理方式の可視化**: ログで現在の処理方式（FIFO/LIFO）を表示
- **v22.1.0**: モジュール分割と単一サーバー化
  - 🏗️ **モジュール分割**: 機能別に分割された保守しやすいアーキテクチャ
  - 🎯 **単一サーバー化**: 複数サーバーから単一サーバーに簡素化
  - 🚫 **ラベルシステム削除**: 不要なサーバーラベルシステムを完全削除
  - 🔧 **画像処理モード**: 3 つの処理モード（高速・バランス・高圧縮）を動的切り替え
- **v22.0.0**: スタック処理システムと設定値検証機能を追加
  - 🚀 **スタック処理システム**: リクエストスタックによる順次処理（v22.1.1 で適応的処理方式に進化 → v24.3.0 で画像変換から除去）
  - 🛡️ **設定値検証機能**: `config.txt`の入力規則チェックと自動修正
  - 💾 **動的メモリ管理**: 大量画像処理時のメモリ最適化
  - ⚡ **高スペック環境対応**: Ryzen 3950X・64GB RAM 最適化設定
  - 🔧 **エラーハンドリング強化**: Premature close エラー対策と ImageMagick 強制終了
  - 📊 **詳細ログ機能**: 変換段階（Sharp/ImageMagick/元画像）の明確化
- **v21.0.1**: `config.txt`のパス指定を修正
  - 💾 **設定ファイルのパス変更**: `config.txt`のパスをプロジェクトフォルダ内に変更
- **v21.0.0**: 動的設定読み込み機能、HTTP 圧縮機能、高スペック環境最適化を追加
  - 💾 **動的設定ファイル監視**: `config.txt`で各種設定を管理し、これの編集による動的な設定変更を実現
  - 🚀 **HTTP gzip 圧縮**: WebDAV レスポンスとテキストファイルを gzip 圧縮して軽量化、画像以外の通信量を 80 ～ 90％削減
  - ⚡ **高スペック環境向け最適化**: キャッシュサイズ、並列処理数を高スペック環境に合わせて最適化
  - 📊 **設定変更ログの差分出力機能**: `config.txt`の編集＝設定の変更結果をログで出力
- **v20.0.2**: 詳細な技術的説明コメントを追加、README.md の実装箇所情報を更新
- **v20.0.1**: ログを整理、README 作成、バージョン記述を `package.json` に移行
- **v20.0**: パフォーマンス改善、エラーハンドリング強化、キャッシュ最適化
- **v19.0**: ？？？
- **v18.0**: ？？？
- **v17.0**: 暫定安定板
- **v16.0**: ？？？
- **v15.0**: ？？？
- **v14.0**: ？？？
- **v13.0**: ？？？
- **v12.0**: ？？？
- **v11.0**: ？？？
- **v10.0**: ？？？
- **v9.0**: ？？？
- **v8.0**: ？？？
- **v7.0**: ？？？
- **v6.0**: ？？？
- **v5.0**: ？？？
- **v4.0**: Sharp 変換のフォールバックとして ImageMagik と連携
- **v3.0**: Sharp 変換の対応フォーマットを指定
- **v2.0**: Sharp による変換機能を実装
- **v1.0**: シンプルなテスト用サーバー（`sample.js`）

## 改善予定・既知の課題

### 🚧 今後の改善予定

#### セキュリティ強化

- **認証機能の追加**: 基本的な認証システム
- **HTTPS 対応**: SSL/TLS 暗号化通信
- **アクセス制御**: IP アドレス制限、ディレクトリ別権限管理

#### パフォーマンス向上

- **画像形式の拡張**: AVIF、HEIC 出力対応（✅ 実装済み：HEIC/HEIF 入力対応）
- **並列処理の最適化**: より効率的な並列変換処理（✅ 一部実装済み：高スペック環境最適化）

#### 機能拡張

- **Web インターフェース**: ブラウザでのファイル管理 UI（✅ 実装済み：設定画面）
- **API エンドポイント**: RESTful API の提供

#### 運用性向上

- **設定ファイル**: JSON/YAML での設定管理（✅ 一部実装済み：`config.txt`）
- **ログ管理**: 構造化ログ、ログローテーション
- **ヘルスチェック**: サーバー状態監視エンドポイント
- **メトリクス**: パフォーマンス統計の収集（✅ 実装済み：通信量統計の表示）

### ⚠️ 既知の課題

#### 現在の制限事項

- **認証なし**: セキュリティリスク（同一ネットワーク内での使用推奨）
- **メモリ使用量**: 大容量画像処理時のメモリ消費（✅ 改善済み：動的メモリ管理機能追加）
- **キャッシュ容量**: ディスク容量の制限
- **同時接続数**: 大量の同時アクセス時の性能低下（✅ 改善済み：並列処理システム導入）

### 🔧 トラブルシューティング

#### Q: モバイルアプリで接続できない

- PC とモバイルが同じネットワークに接続されているか確認
- ファイアウォールでポートが開放されているか確認
- IP アドレスが正しいか確認

#### Q: 画像が表示されない

- 対応形式（JPG, PNG, TIFF など）か確認
- ファイルサイズが大きすぎないか確認
- ブラウザのキャッシュをクリア

#### Q: サーバーが重い

- 同時接続数を制限
- キャッシュディレクトリの容量を確認
- `config.txt`を修正
