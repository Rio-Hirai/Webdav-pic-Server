# WebDAV 画像変換サーバー

高機能な WebDAV サーバーで、画像の自動変換とキャッシュ機能を備えています。

## 概要

このプロジェクトは、複数の設定で WebDAV サーバーを同時起動し、画像ファイルの自動変換（WebP 形式）とキャッシュ機能を提供する Node.js アプリケーションです。

## 主な機能

### 🚀 複数サーバー同時起動

- **軽量版** (ポート 1900): 高速処理重視、品質 50、リサイズ 896px
- **バランス版** (ポート 1901): 品質と速度のバランス、品質 70、リサイズ 1024px
- **オリジナル版** (ポート 1902): 高品質重視、品質 85、リサイズなし

**実装箇所**: `main.js` 168-206行 - `serverConfigs`配列で各サーバーの設定を定義し、212行で`forEach`ループにより複数サーバーを同時起動

### 🖼️ 画像自動変換

- **対応入力形式**: JPG, JPEG, PNG, TIFF, TIF, BMP, AVIF
- **出力形式**: WebP
- **変換エンジン**: Sharp（高速） + ImageMagick（フォールバック）
- **自動リサイズ**: 設定に応じて最適なサイズに調整
- **品質調整**: クエリパラメータ `?q=70` で指定可能（30-90 の範囲）

**実装箇所**:
- **画像拡張子判定**: `main.js` 231行 - `IMAGE_EXTS`配列で対応形式を定義
- **変換処理メイン**: `main.js` 885-1193行 - `convertAndRespond`関数でSharp/ImageMagickによる変換処理
- **Sharp設定**: `main.js` 47-70行 - パフォーマンス最適化設定（並列度制御、メモリキャッシュ、ファイルキャッシュ）
- **品質パラメータ処理**: `main.js` 673-676行 - クエリパラメータ`q`の取得と検証（30-90の範囲制限）
- **リサイズ処理**: `main.js` 923-947行 - 軽量版と通常版の異なるリサイズ戦略（幅基準 vs 縦横比較）

### ⚡ 高性能キャッシュシステム

- **LRU キャッシュ**: ディレクトリリストとファイル統計の高速キャッシュ
- **画像キャッシュ**: 1MB 以上の画像のみキャッシュ対象
- **自動クリーンアップ**: 5 分 TTL で古いキャッシュを自動削除
- **重複変換防止**: 同じ画像の同時変換要求を効率的に処理
- **失敗バックオフ**: 変換失敗時の再試行制御

**実装箇所**:
- **キャッシュ設定**: `main.js` 95-98行 - キャッシュディレクトリ、TTL、クリーンアップ間隔の設定（ファイルベースキャッシュ、原子的更新、TTL管理）
- **LRUキャッシュ**: `main.js` 264-272行 - ディレクトリリストとファイル統計のLRUキャッシュインスタンス（LRUアルゴリズム、メモリ制限、分離設計）
- **キャッシュラッパー**: `main.js` 286-419行 - `readdirSyncWrap`、`statSyncWrap`等のキャッシュ機能付きファイルシステム関数（ストリーミング読み込み、エラーハンドリング）
- **画像キャッシュ**: `main.js` 689-693行 - キャッシュキー生成とキャッシュパス設定（MD5ハッシュ、変更検知、衝突回避）
- **重複変換防止**: `main.js` 576-581行 - `inflight`マップによる重複変換管理（in-flight deduplication、タイムアウト制御、失敗バックオフ）
- **失敗バックオフ**: `main.js` 706-710行 - `failedCache`による失敗記録と再試行制御（連続失敗時の再試行制御、リトライ制限）
- **自動クリーンアップ**: `main.js` 139-166行 - `cleanupCache`関数による定期クリーンアップ（非同期処理、TTL期限切れファイル削除）

### 🛡️ セキュリティ機能

- **パストラバーサル攻撃対策**: 安全なパス解決
- **Depth: infinity 拒否**: 無限階層のディレクトリ探索を防止
- **ファイルアクセス制限**: ルートディレクトリ外へのアクセスを拒否
- **並列処理制限**: CPU 数に応じた適切な並列度制御

**実装箇所**:
- **パストラバーサル対策**: `main.js` 598-614行 - `safeResolve`関数による安全なパス解決（パストラバーサル対策、プラットフォーム対応、大文字小文字処理、正規化）
- **Depth: infinity拒否**: `main.js` 446-456行 - WebDAVリクエスト前処理ミドルウェア（PROPFIND、Depth: infinity、セキュリティ対策、DoS攻撃防止）
- **並列処理制限**: `main.js` 276行 - `pLimit(os.cpus().length)`による並列度制御（メモリ枯渇とCPU過負荷の防止）
- **アクセス制限**: `main.js` 604-612行 - プラットフォーム別のパス比較によるアクセス制御（Windows/Unix系対応、大文字小文字区別）

## システム要件

- **Node.js**: 16 以上
- **ImageMagick**: フォールバック用（オプション）
- **ディスク容量**: キャッシュ用の十分な容量
- **メモリ**: 画像処理用の十分なメモリ

## インストール

### 1. 依存関係のインストール

```bash
npm install
```

### 2. ImageMagick のインストール（推奨）

#### Windows

```bash
# Chocolatey を使用する場合
choco install imagemagick

# または公式サイトからダウンロード
# <https://imagemagick.org/script/download.php#windows>
```

#### macOS

```bash
brew install imagemagick
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt-get install imagemagick

# CentOS/RHEL
sudo yum install ImageMagick
```

## 使用方法

### 基本的な起動

```bash
# メインサーバーを起動（3つのサーバーが同時起動）
node main.js

# テスト用のシンプルサーバー
node test.js
```

### アクセス方法

起動後、以下の URL でアクセス可能：

- **軽量版**: http://localhost:1900/
- **バランス版**: http://localhost:1901/
- **オリジナル版**: http://localhost:1902/

### モバイル・タブレットでのアクセス

スマートフォンやタブレットから WebDAV サーバーにアクセスするには専用のアプリが必要です：

#### iOS（iPhone/iPad）

- **Documents by Readdle**: 高機能なファイル管理アプリ
- **FE File Explorer**: シンプルなファイル管理アプリ（オススメ）
- **FileBrowser**: WebDAV 対応のファイルブラウザ

#### Android

- **Documents by Readdle**: 高機能なファイル管理アプリ
- **ES File Explorer**: シンプルなファイル管理アプリ（オススメ）
- **Solid Explorer**: モダンなファイル管理アプリ

#### 設定方法

1. アプリをインストール後、WebDAV サーバーを追加
2. サーバー情報を入力：
   - **サーバー**: `http://[PCのIPアドレス]:1901`（例：`http://192.168.1.100:1901`）
   - **ユーザー名**: 空欄（認証なし）
   - **パスワード**: 空欄（認証なし）
3. 接続してファイルにアクセス

**注意**: PC の IP アドレスを確認するには、コマンドプロンプトで `ipconfig`（Windows）または `ifconfig`（Mac/Linux）を実行してください。

### 画像変換の使用例

```bash
# 通常の画像アクセス（自動変換）
http://localhost:1901/path/to/image.jpg

# 品質指定（30-90の範囲）
http://localhost:1901/path/to/image.jpg?q=80

# 自動リサイズ（設定に応じて）
http://localhost:1901/path/to/large_image.jpg
```

## 設定

### サーバー設定の変更

**実装箇所**: `main.js` 168-206行

`main.js` の `serverConfigs` 配列を編集：

```javascript
const serverConfigs = [
  {
    PORT: 1900, // ポート番号
    ROOT_PATH: "Z:/", // ルートディレクトリ
    MAX_LIST: 128 * 2, // 最大リスト数（256）
    Photo_Size: 128 * 7, // 画像リサイズサイズ（896px）
    defaultQuality: 50, // デフォルト品質
    label: "軽量版", // サーバーラベル
  },
  {
    PORT: 1901,
    ROOT_PATH: "Z:/",
    MAX_LIST: 128 * 8, // 最大リスト数（1024）
    Photo_Size: 128 * 8, // 画像リサイズサイズ（1024px）
    defaultQuality: 70,
    label: "(バランス版",
  },
  {
    PORT: 1902,
    ROOT_PATH: "Z:/",
    MAX_LIST: 128 * 32, // 最大リスト数（4096）
    Photo_Size: null, // リサイズなし（オリジナル）
    defaultQuality: 85,
    label: "オリジナル版",
  },
];
```

### キャッシュ設定

**実装箇所**: `main.js` 95-98行

```javascript
const CACHE_DIR = "Y:/caches/webdav/tmp"; // キャッシュディレクトリ
const CACHE_MIN_SIZE = 1 * 1024 * 1024; // キャッシュ最小サイズ（1MB）
const CACHE_TTL_MS = 5 * 60 * 1000; // キャッシュ有効期間（5分）
const CLEANUP_INTERVAL_MS = 30 * 60 * 1000; // クリーンアップ間隔（30分）
```

### 環境変数

**実装箇所**: `main.js` 44-45行

```bash
# ImageMagick のパスを指定（デフォルト: "magick"）
export MAGICK_PATH="/usr/local/bin/magick"
```

## 技術的詳細

### アーキテクチャの特徴

#### ハイブリッド処理システム
- **WebDAV + HTTP**: 単一サーバーでWebDAVプロトコルとHTTP画像変換を同時処理
- **ストリーミング処理**: 大容量画像でもメモリ効率的な処理を実現
- **原子的操作**: キャッシュ更新時の整合性を保証

#### 高度なキャッシュ戦略
- **多層キャッシュ**: LRUメモリキャッシュ + ファイルベースキャッシュの組み合わせ
- **in-flight deduplication**: 同一画像の同時変換要求を効率的に統合
- **失敗バックオフ**: 連続失敗時の再試行制御によるサーバー保護

#### セキュリティ設計
- **パストラバーサル対策**: プラットフォーム対応の安全なパス解決
- **DoS攻撃防止**: Depth: infinity拒否による無限探索の防止
- **リソース保護**: 並列度制御とタイムアウト設定による枯渇防止

## パフォーマンス最適化

### Sharp 設定

**実装箇所**: `main.js` 47-70行

- **並列処理**: CPU 数に応じた最適な並列度（concurrency制限、メインスレッド保護）
- **メモリキャッシュ**: 200MB のメモリキャッシュ（同一画像の再変換高速化）
- **ファイルキャッシュ**: 100個のファイルキャッシュ（ディスクI/O最適化）
- **アイテムキャッシュ**: 200個のアイテムキャッシュ（メタデータ取得高速化）
- **軽量版**: 最速処理モード（effort=0, smartSubsample=false）

### キャッシュ戦略

**実装箇所**: `main.js` 264-272行

- **ディレクトリリストキャッシュ**: 50,000 エントリ（1 時間 TTL、LRUアルゴリズム、メモリ制限）
- **ファイル統計キャッシュ**: 200,000 エントリ（1 時間 TTL、分離設計、TTL管理）
- **画像変換結果キャッシュ**: ファイルベース（5 分 TTL、原子的更新、競合回避）

### 並列処理制御

**実装箇所**: `main.js` 276行、576-581行、706-710行

- **p-limit**: CPU 数に応じた適切な並列度制御（メモリ枯渇とCPU過負荷の防止）
- **in-flight dedupe**: 重複変換要求の効率的な処理（同一キーの変換要求統合、タイムアウト制御）
- **失敗バックオフ**: 変換失敗時の再試行制御（連続失敗時の再試行制御、リトライ制限）

## トラブルシューティング

### よくある問題

#### 1. ポートが使用中

```
ポート 1900 は既に使用されています。v20.0 (軽量版) の起動をスキップします。
```

**解決方法**: 他のプロセスを終了するか、ポート番号を変更してください。

#### 2. ImageMagick が見つからない

```
[ImageMagick変換失敗] spawn magick ENOENT
```

**解決方法**:

- ImageMagick をインストールする
- 環境変数 `MAGICK_PATH` を設定する
- Sharp のみで動作するため、ImageMagick は必須ではありません

#### 3. キャッシュディレクトリの権限エラー

```
[cache write error] EACCES
```

**解決方法**: キャッシュディレクトリの書き込み権限を確認してください。

#### 4. メモリ不足

```
[Sharp失敗→ImageMagick] out of memory
```

**解決方法**:

- システムのメモリを増やす
- `Photo_Size` を小さくする
- 軽量版を使用する

### ログの確認

サーバーは詳細なログを出力します：

- **リクエスト情報**: アクセス元、メソッド、パス
- **変換処理**: 変換開始・完了、使用エンジン
- **キャッシュ状況**: キャッシュヒット・ミス
- **エラー処理**: フォールバック処理の詳細

### パフォーマンス監視

```bash
# プロセス監視
ps aux | grep node

# メモリ使用量確認
top -p $(pgrep -f "node main.js")

# ディスク使用量確認
du -sh Y:/caches/webdav/tmp
```

## ソースコード構造

### ファイル構成

```
main.js (1193行)
├── 1-18行: モジュール読み込み・共通初期化（Node.js標準モジュール、外部ライブラリ）
├── 19-41行: ロガー設定（ISO8601タイムスタンプ、構造化ログ）
├── 43-70行: ImageMagick設定・Sharp最適化（並列度制御、メモリキャッシュ）
├── 72-98行: ストリーム処理・キャッシュ設定（PassThrough、pipeline、ファイルベースキャッシュ）
├── 100-166行: キャッシュ管理関数（同期削除、非同期クリーンアップ）
├── 168-212行: サーバー設定・起動ループ（複数サーバー同時起動）
├── 214-502行: WebDAVサーバー実装（RFC4918準拠、セキュリティ対策）
├── 504-883行: HTTPサーバー・画像変換処理（ハイブリッド処理、ストリーミング）
└── 885-1193行: 画像変換エンジン（Sharp/ImageMagick、原子的キャッシュ更新）
```

### 主要な関数・クラス

| 関数/クラス名 | 行数 | 機能 |
|--------------|------|------|
| `timestamp()` | 24-26行 | ログ用タイムスタンプ生成（ISO8601形式） |
| `resetCacheSync()` | 100-114行 | キャッシュディレクトリの同期削除（withFileTypes、再帰削除） |
| `cleanupCache()` | 139-163行 | キャッシュファイルの定期クリーンアップ（非同期処理、TTL管理） |
| `startWebDAV()` | 226-883行 | WebDAVサーバー起動メイン関数（複数サーバー、ハイブリッド処理） |
| `CachedFileSystem` | 430-502行 | キャッシュ機能付きWebDAVファイルシステム（LRUキャッシュ統合） |
| `safeResolve()` | 598-614行 | セキュアなパス解決（パストラバーサル対策、プラットフォーム対応） |
| `convertAndRespond()` | 885-1193行 | 画像変換・レスポンス送信（Sharp/ImageMagick、原子的更新） |
| `readdirSyncWrap()` | 286-312行 | 同期ディレクトリ読み込みキャッシュ（ストリーミング読み込み、MAX_LIST制限） |
| `statSyncWrap()` | 321-341行 | 同期ファイル統計キャッシュ（エラーハンドリング、デフォルト値） |
| `readdirPWrap()` | 351-375行 | 非同期ディレクトリ読み込みキャッシュ（非同期opendir、エラー回復） |
| `statPWrap()` | 385-405行 | 非同期ファイル統計キャッシュ（Promise対応、エラー処理） |

### データフロー

1. **初期化**: モジュール読み込み → Sharp最適化設定 → キャッシュ設定 → サーバー設定
2. **リクエスト受信**: HTTPサーバー → セキュアパス解決 → 画像拡張子判定
3. **画像変換**: キャッシュキー生成 → キャッシュチェック → 重複変換排除 → Sharp/ImageMagick変換 → 原子的キャッシュ更新 → ストリーミングレスポンス
4. **WebDAV処理**: ファイルシステム操作 → LRUキャッシュ活用 → セキュリティチェック → レスポンス

## API リファレンス

### 画像変換パラメータ

| パラメータ | 説明     | 範囲  | デフォルト         |
| ---------- | -------- | ----- | ------------------ |
| `q`        | 画像品質 | 30-90 | サーバー設定による |

### レスポンスヘッダー

| ヘッダー         | 説明             |
| ---------------- | ---------------- |
| `Content-Type`   | `image/webp`     |
| `Content-Length` | ファイルサイズ   |
| `Last-Modified`  | 最終更新日時     |
| `ETag`           | エンティティタグ |
| `Cache-Control`  | キャッシュ制御   |

## ライセンス

ISC

## 更新履歴

- **v20.0.2**: 詳細な技術的説明コメントを追加、README.mdの実装箇所情報を更新
- **v20.0.1**: ログを整理、README 作成、バージョン記述を package.json に移行
- **v20.0**: パフォーマンス改善、エラーハンドリング強化、キャッシュ最適化
- **v17.0**: ？？？（暫定安定板）
- **v16.0**: ？？？
- **v15.0**: ？？？
- **v14.0**: ？？？
- **v13.0**: ？？？
- **v1.0**: シンプルなテスト用サーバー
- **test.js**: シンプルなテスト用サーバー

## 改善予定・既知の課題

### 🚧 今後の改善予定

#### セキュリティ強化

- **認証機能の追加**: 基本的なユーザー認証システム
- **HTTPS 対応**: SSL/TLS 暗号化通信
- **アクセス制御**: IP アドレス制限、ディレクトリ別権限管理
- **レート制限**: 同一 IP からの過度なリクエスト制限

#### パフォーマンス向上

- **画像形式の拡張**: AVIF、HEIC 出力対応
- **動的リサイズ**: クライアントサイズに応じた最適化
- **CDN 連携**: 外部 CDN へのキャッシュ配信
- **並列処理の最適化**: より効率的な並列変換処理

#### 機能拡張

- **Web インターフェース**: ブラウザでのファイル管理 UI
- **API エンドポイント**: RESTful API の提供
- **メタデータ管理**: EXIF 情報の保持・表示
- **バッチ処理**: 複数ファイルの一括変換

#### 運用性向上

- **設定ファイル**: JSON/YAML での設定管理
- **ログ管理**: 構造化ログ、ログローテーション
- **ヘルスチェック**: サーバー状態監視エンドポイント
- **メトリクス**: パフォーマンス統計の収集

### ⚠️ 既知の課題

#### 現在の制限事項

- **認証なし**: セキュリティリスク（同一ネットワーク内での使用推奨）
- **メモリ使用量**: 大容量画像処理時のメモリ消費
- **キャッシュ容量**: ディスク容量の制限
- **同時接続数**: 大量の同時アクセス時の性能低下

#### 互換性の問題

- **古いブラウザ**: WebP 非対応ブラウザでの表示問題
- **モバイルアプリ**: 一部アプリでの WebDAV 実装の違い
- **ファイル名**: 特殊文字を含むファイル名の処理

#### パフォーマンス課題

- **初回アクセス**: キャッシュ未生成時の遅延
- **大容量ファイル**: 数 GB の画像ファイルの処理時間
- **ネットワーク**: 低速回線での転送効率

### 🔧 トラブルシューティング

#### よくある問題と対処法

**Q: モバイルアプリで接続できない**

- PC とモバイルが同じネットワークに接続されているか確認
- ファイアウォールでポートが開放されているか確認
- IP アドレスが正しいか確認

**Q: 画像が表示されない**

- 対応形式（JPG, PNG, TIFF など）か確認
- ファイルサイズが大きすぎないか確認
- ブラウザのキャッシュをクリア

**Q: サーバーが重い**

- 同時接続数を制限
- キャッシュディレクトリの容量を確認
- 軽量版サーバー（ポート 1900）を使用
