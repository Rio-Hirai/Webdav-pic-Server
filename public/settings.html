<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebDAV Server - Settings (フォーム)</title>
  <link rel="stylesheet" href="/setting/css/settings.css">
</head>
<body>
  <div class="container">
    <h1>WebDAV Server — 設定編集</h1>
  <div class="header-row">
      <div class="lead">フォームで設定を編集できます。各項目の説明を参照の上、編集してください。編集後は <strong>保存</strong> を押して反映します。</div>
      <div class="header-actions">
        <button id="themeToggle" class="btn-ghost" type="button">ダーク</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <form id="settingsForm" autocomplete="off">
          <div class="field-group">
            <h3>圧縮設定</h3>
            <div class="row">
              <label for="COMPRESSION_ENABLED">レスポンス圧縮を有効にする</label>
              <input id="COMPRESSION_ENABLED" name="COMPRESSION_ENABLED" type="checkbox" />
            </div>
            <div class="row">
              <label for="COMPRESSION_THRESHOLD">圧縮閾値 (0.0〜1.0)</label>
              <input id="COMPRESSION_THRESHOLD" name="COMPRESSION_THRESHOLD" type="number" step="0.01" min="0" max="1" />
            </div>
            <div class="desc">テキスト系レスポンスを gzip 圧縮するか。閾値は圧縮後サイズ ÷ 元のサイズ（小さいほど圧縮が適用されやすい）。</div>
          </div>

          <div class="field-group">
            <h3>サーバー設定</h3>
            <div class="row">
              <label for="PORT">待ち受けポート</label>
              <input id="PORT" name="PORT" type="number" min="1" max="65535" />
            </div>
            <div class="row">
              <label for="ROOT_PATH">WebDAV ルートパス</label>
              <input id="ROOT_PATH" name="ROOT_PATH" type="text" />
            </div>
            <div class="row">
              <label for="MAX_LIST">ディレクトリ一覧の最大件数</label>
              <input id="MAX_LIST" name="MAX_LIST" type="number" min="1" />
            </div>
            <div class="desc">サーバーの待ち受けポート、WebDAV のルートフォルダ、ディレクトリ一覧で表示する最大件数を指定します。</div>
          </div>

          <div class="field-group">
            <h3>画像変換設定</h3>
            <div class="row">
              <label for="IMAGE_TEMPLATE">テンプレート選択</label>
              <select id="IMAGE_TEMPLATE" name="IMAGE_TEMPLATE">
                <option value="">テンプレートを選択しない</option>
                <option value="small">Small</option>
                <option value="medium">Medium</option>
                <option value="large">Large</option>
                <option value="hq">High Quality</option>
              </select>
            </div>
            <div class="row">
              <label for="PHOTO_SIZE">画像最大サイズ (px)</label>
              <input id="PHOTO_SIZE" name="PHOTO_SIZE" type="number" min="16" />
            </div>
            <div class="row">
              <label for="DEFAULT_QUALITY">デフォルト画質</label>
              <input id="DEFAULT_QUALITY" name="DEFAULT_QUALITY" type="number" min="1" max="100" />
            </div>
            <div class="row">
              <label for="IMAGE_MODE">画像処理モード</label>
              <select id="IMAGE_MODE" name="IMAGE_MODE">
                <option value="1">1 — 高速（低負荷）</option>
                <option value="2">2 — バランス（推奨）</option>
                <option value="3">3 — 高品質（高負荷）</option>
              </select>
            </div>
            <div class="desc">画像のリサイズ上限(px)、デフォルトの出力品質（JPEG 等）、処理モードを設定します。</div>
          </div>

          <div class="field-group">
            <h3>キャッシュ / メモリ</h3>
            <div class="row">
              <label for="CACHE_TTL_MS">キャッシュ有効期限 (ms)</label>
              <input id="CACHE_TTL_MS" name="CACHE_TTL_MS" type="number" min="0" />
            </div>
            <div class="row">
              <label for="CACHE_MIN_SIZE">キャッシュ対象最小サイズ (bytes)</label>
              <input id="CACHE_MIN_SIZE" name="CACHE_MIN_SIZE" type="number" min="0" />
            </div>
            <div class="row">
              <label for="MAX_CONCURRENCY">同時処理数の上限</label>
              <input id="MAX_CONCURRENCY" name="MAX_CONCURRENCY" type="number" min="1" />
            </div>
            <div class="row">
              <label for="SHARP_MEMORY_LIMIT">Sharp メモリ制限 (MB)</label>
              <input id="SHARP_MEMORY_LIMIT" name="SHARP_MEMORY_LIMIT" type="number" min="0" />
            </div>
            <div class="row">
              <label for="SHARP_PIXEL_LIMIT">Sharp ピクセル上限</label>
              <input id="SHARP_PIXEL_LIMIT" name="SHARP_PIXEL_LIMIT" type="number" min="0" />
            </div>
            <div class="desc">画像変換キャッシュの設定や Sharp ライブラリのメモリ・処理上限を調整します。</div>
          </div>

          <div class="field-group">
            <h3>レート制限</h3>
            <div class="row">
              <label for="RATE_LIMIT_ENABLED">レート制限を有効にする</label>
              <input id="RATE_LIMIT_ENABLED" name="RATE_LIMIT_ENABLED" type="checkbox" />
            </div>
            <div class="row">
              <label for="RATE_LIMIT_REQUESTS">許可リクエスト数 / ウィンドウ時間</label>
              <input id="RATE_LIMIT_REQUESTS" name="RATE_LIMIT_REQUESTS" type="number" min="0" />
            </div>
            <div class="row">
              <label for="RATE_LIMIT_WINDOW_MS">ウィンドウ時間 (ms)</label>
              <input id="RATE_LIMIT_WINDOW_MS" name="RATE_LIMIT_WINDOW_MS" type="number" min="0" />
            </div>
            <div class="row">
              <label for="RATE_LIMIT_QUEUE_SIZE">レート制限キューサイズ</label>
              <input id="RATE_LIMIT_QUEUE_SIZE" name="RATE_LIMIT_QUEUE_SIZE" type="number" min="0" />
            </div>
            <div class="desc">大量アクセス対策の設定です。負荷状況に応じて調整してください。</div>
          </div>

          <div class="field-group">
            <h3>緊急 / スタック / 再起動</h3>
            <div class="row">
              <label for="EMERGENCY_DISABLE_RATE_LIMIT">緊急時にレート制限を無効化する</label>
              <input id="EMERGENCY_DISABLE_RATE_LIMIT" name="EMERGENCY_DISABLE_RATE_LIMIT" type="checkbox" />
            </div>
            <div class="row">
              <label for="STACK_MAX_SIZE">スタック最大サイズ</label>
              <input id="STACK_MAX_SIZE" name="STACK_MAX_SIZE" type="number" min="1" />
            </div>
            <div class="row">
              <label for="STACK_PROCESSING_DELAY_MS">スタック処理遅延 (ms)</label>
              <input id="STACK_PROCESSING_DELAY_MS" name="STACK_PROCESSING_DELAY_MS" type="number" min="0" />
            </div>
            <div class="row">
              <label for="RESTART_ENABLED">自動再起動を有効にする</label>
              <input id="RESTART_ENABLED" name="RESTART_ENABLED" type="checkbox" />
            </div>
            <div class="row">
              <label for="RESTART_TIME">自動再起動時刻 (HH:MM)</label>
              <input id="RESTART_TIME" name="RESTART_TIME" type="text" pattern="^\\d{1,2}:\\d{2}$" />
            </div>
            <div class="desc">緊急時の動作やスタック処理、定期的な自動再起動の設定を行います。</div>
          </div>

          <div class="field-group">
            <h3>その他</h3>
            <div class="row">
              <label for="MAGICK_PATH">ImageMagick コマンド / パス</label>
              <input id="MAGICK_PATH" name="MAGICK_PATH" type="text" />
            </div>
            <div class="desc">ImageMagick を使用する場合のコマンド名またはフルパス。未設定時は既定のコマンド名を使用します。</div>
          </div>

          <div class="actions">
            <button type="button" id="btnLoad" class="btn-ghost">再読み込み</button>
            <button type="button" id="btnSave">保存</button>
            <button type="button" id="btnRaw">生データ表示切替</button>
            <div class="status" id="status"></div>
          </div>

        </form>
      </div>

      <div class="card">
        <h3>項目説明</h3>
        <div class="small">
          このパネルでは各設定項目の簡単な説明を表示します。フォームで値を変更して <strong>Save</strong> を押すとサーバ上の <code>config.txt</code> を上書きします。運用中は必ずバックアップを取ってから変更してください。
        </div>

  <hr />

        <div id="help" class="small">
          <strong>COMPRESSION_ENABLED</strong><br/>テキスト系レスポンスの gzip 圧縮を有効にします。<br/><br/>
          <strong>COMPRESSION_THRESHOLD</strong><br/>圧縮後のサイズ比 (compressed / original)。小さいほど圧縮が適用されやすくなります（例: 0.3）。<br/><br/>
          <strong>PHOTO_SIZE</strong><br/>画像変換時の最大ピクセル幅/高さ（px）。<br/><br/>
          <strong>IMAGE_MODE</strong><br/>処理モード。1=高速, 2=バランス, 3=高品質（品質と負荷のトレードオフ）。<br/><br/>
          <strong>CACHE_TTL_MS</strong><br/>キャッシュの有効期限（ミリ秒）。期限切れのキャッシュは定期的に削除されます。<br/><br/>
          <strong>SHARP_MEMORY_LIMIT</strong><br/>Sharp のメモリキャッシュ（MB）。システムの物理メモリに合わせて調整してください。<br/><br/>
          <strong>RATE_LIMIT_*</strong><br/>大量アクセス対策の設定（許可リクエスト数、ウィンドウ時間、キュー長など）。<br/>
        </div>

  <hr />

        <div>
          <h4>Raw content</h4>
          <pre id="raw" tabindex="0" role="region" aria-label="設定ファイルの生テキスト">読み込みしてください</pre>
        </div>

      </div>
    </div>
  </div>

  <!-- fixed save bar -->
  <div id="fixedBar" class="fixed-bar" aria-hidden="false">
    <div class="fixed-bar-inner">
      <button id="btnLoadFixed" class="btn-ghost" type="button">再読み込み</button>
      <button id="btnSaveFixed" class="btn-primary" type="button">保存</button>
      <div class="status" id="statusFixed"></div>
    </div>
  </div>

  <script>
    // mapping between form fields and config keys
    const keys = [
      'COMPRESSION_ENABLED','COMPRESSION_THRESHOLD',
      'PORT','ROOT_PATH','MAX_LIST',
      'PHOTO_SIZE','DEFAULT_QUALITY','IMAGE_MODE',
      'CACHE_TTL_MS','CACHE_MIN_SIZE','MAX_CONCURRENCY','SHARP_MEMORY_LIMIT','SHARP_PIXEL_LIMIT',
      'RATE_LIMIT_ENABLED','RATE_LIMIT_REQUESTS','RATE_LIMIT_WINDOW_MS','RATE_LIMIT_QUEUE_SIZE',
      'EMERGENCY_DISABLE_RATE_LIMIT','STACK_MAX_SIZE','STACK_PROCESSING_DELAY_MS',
      'RESTART_ENABLED','RESTART_TIME','MAGICK_PATH'
    ];

    // convenience helpers
    const byId = id => document.getElementById(id);
    const statusEl = byId('status');
    const rawEl = byId('raw');
    const themeBtn = byId('themeToggle');

    // Theme helpers: apply and persist theme (light/dark)
    function applyTheme(theme){
      if (theme === 'dark') document.documentElement.setAttribute('data-theme','dark');
      else document.documentElement.removeAttribute('data-theme');
      if (themeBtn) themeBtn.textContent = theme === 'dark' ? 'ライト' : 'ダーク';
    }

    function loadTheme(){
      try {
        const t = localStorage.getItem('settings_theme') || 'light';
        applyTheme(t);
      } catch(e){}
    }

    function toggleTheme(){
      try{
        const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('settings_theme', next);
        applyTheme(next);
      }catch(e){}
    }

    function setStatus(msg, err) {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.style.color = err ? 'var(--danger)' : '';
    }

    // parse config.txt into object {KEY: value}
    function parseConfig(text) {
      const out = {};
      const lines = text.split(/\r?\n/);
      for (const line of lines) {
        const t = line.trim();
        if (!t || t.startsWith('#')) continue;
        const idx = t.indexOf('=');
        if (idx === -1) continue;
        const k = t.slice(0, idx).trim();
        let v = t.slice(idx+1).trim();
        // keep as string; we'll interpret booleans/numbers in UI logic
        out[k] = v;
      }
      return out;
    }

    // populate form from config object
    function populateForm(cfg) {
      for (const k of keys) {
        const el = byId(k);
        if (!el) continue;
        const v = cfg[k];
        if (el.type === 'checkbox') {
          el.checked = (typeof v !== 'undefined') ? (String(v).toLowerCase() === 'true') : false;
        } else {
          el.value = (typeof v !== 'undefined') ? v : '';
        }
      }
      // show raw
      buildRaw();
    }

    // build raw config text from form values (with comments/header)
    function buildConfigText() {
      const header = [
        '# WebDAV画像変換サーバー設定ファイル (自動生成)',
        '# 編集はフォームで行ってください。'
      ];
      const lines = [...header];
      // group order similar to original file
      const add = (k) => {
        const el = byId(k);
        if (!el) return;
        let v;
        if (el.type === 'checkbox') v = el.checked ? 'true' : 'false';
        else v = el.value ?? '';
        lines.push(`${k}=${v}`);
      };
      const groups = [
        ['COMPRESSION_ENABLED','COMPRESSION_THRESHOLD'],
        ['PORT','ROOT_PATH','MAX_LIST'],
        ['PHOTO_SIZE','DEFAULT_QUALITY','IMAGE_MODE'],
        ['CACHE_TTL_MS','CACHE_MIN_SIZE','MAX_CONCURRENCY','SHARP_MEMORY_LIMIT','SHARP_PIXEL_LIMIT'],
        ['RATE_LIMIT_ENABLED','RATE_LIMIT_REQUESTS','RATE_LIMIT_WINDOW_MS','RATE_LIMIT_QUEUE_SIZE'],
        ['EMERGENCY_DISABLE_RATE_LIMIT'],
        ['STACK_MAX_SIZE','STACK_PROCESSING_DELAY_MS'],
        ['RESTART_ENABLED','RESTART_TIME'],
        ['MAGICK_PATH']
      ];
      for (const g of groups) {
        lines.push(''); // blank line between groups
        for (const k of g) add(k);
      }
      return lines.join('\n') + '\n';
    }

    // build raw preview
    function buildRaw() {
      if (!rawEl) return;
      rawEl.textContent = buildConfigText();
    }

    // validate simple constraints, returns {ok:bool, msg:...}
    function validate() {
      // example: port range
      const port = Number(byId('PORT').value || 0);
      if (!Number.isInteger(port) || port < 1 || port > 65535) return {ok:false,msg:'PORT は 1..65535 の整数で指定してください'};
      const q = Number(byId('DEFAULT_QUALITY').value || 0);
      if (!Number.isFinite(q) || q < 1 || q > 100) return {ok:false,msg:'DEFAULT_QUALITY は 1..100 で指定してください'};
      const pct = Number(byId('COMPRESSION_THRESHOLD').value || -1);
      if (!Number.isFinite(pct) || pct < 0 || pct > 1) return {ok:false,msg:'COMPRESSION_THRESHOLD は 0.0 〜 1.0 の値で指定してください'};
      return {ok:true};
    }

    // fetch config.txt content
    async function loadConfig() {
      setStatus('Loading...');
      try {
        const r = await fetch('/setting/data');
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const txt = j.content || '';
        byId('status').textContent = '';
        const cfg = parseConfig(txt);
        populateForm(cfg);
        setStatus('Loaded');
      } catch (e) {
        setStatus('Load error: ' + (e.message || e), true);
      }
    }

    // save config: build text and POST
    async function saveConfig() {
      setStatus('Validating...');
      const v = validate();
      if (!v.ok) { setStatus(v.msg, true); return; }
      const text = buildConfigText();
      // show raw preview before saving
      rawEl.textContent = text;
      setStatus('Saving...');
      try {
        const r = await fetch('/setting/save', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ content: text })
        });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        setStatus('Saved');
      } catch (e) {
        setStatus('Save error: ' + (e.message || e), true);
      }
    }

    // event wiring
    document.getElementById('btnLoad').addEventListener('click', loadConfig);
    document.getElementById('btnSave').addEventListener('click', () => {
      saveConfig();
    });
    document.getElementById('btnRaw').addEventListener('click', () => {
      rawEl.style.display = rawEl.style.display === 'none' ? 'block' : 'none';
    });
    if (themeBtn) themeBtn.addEventListener('click', toggleTheme);

    // initialize
    (function init(){
      // set some defaults
      for (const k of keys) {
        const el = byId(k);
        if (!el) continue;
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
      }
      loadConfig();
      loadTheme();
      // wire template selector
      const templateSelect = byId('IMAGE_TEMPLATE');
      const templates = {
        small: { PHOTO_SIZE: '640', DEFAULT_QUALITY: '30', IMAGE_MODE: '1' },
        medium: { PHOTO_SIZE: '800', DEFAULT_QUALITY: '50', IMAGE_MODE: '2' },
        large: { PHOTO_SIZE: '1280', DEFAULT_QUALITY: '70', IMAGE_MODE: '2' },
        hq: { PHOTO_SIZE: '2400', DEFAULT_QUALITY: '95', IMAGE_MODE: '3' }
      };
      if (templateSelect) {
        templateSelect.addEventListener('change', (ev) => {
          const v = ev.target.value;
          if (!v) return; // no-op when clearing
          const t = templates[v];
          if (!t) return;
          // apply template values to form fields
          for (const k of Object.keys(t)) {
            const el = byId(k);
            if (!el) continue;
            el.value = t[k];
          }
        });
      }

      // wire fixed bar buttons (if present)
      const btnSaveFixed = byId('btnSaveFixed');
      const btnLoadFixed = byId('btnLoadFixed');
      const statusFixed = byId('statusFixed');
      if (btnSaveFixed) btnSaveFixed.addEventListener('click', () => saveConfig());
      if (btnLoadFixed) btnLoadFixed.addEventListener('click', () => loadConfig());
      // keep status in sync
      const origSetStatus = setStatus;
      setStatus = (msg, err) => {
        origSetStatus(msg, err);
        if (statusFixed) statusFixed.textContent = msg || '';
      };
    })();
  </script>
</body>
</html>
