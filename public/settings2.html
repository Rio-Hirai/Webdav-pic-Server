<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>âš™ï¸ WebDAV Pic Server - Settings</title>
    <link rel="stylesheet" href="/setting/css/settings2.css" />
    <!-- favicons: add both /icons and /setting/icons paths to match server static routing -->
    <!-- PNGå½¢å¼ã‚’å„ªå…ˆï¼ˆSafariå¯¾å¿œï¼‰ -->
    <link rel="icon" type="image/png" sizes="256x256" href="/icons/favicon-256.png" />
    <link rel="icon" type="image/png" sizes="256x256" href="/setting/icons/favicon-256.png" />
    <!-- SVGå½¢å¼ï¼ˆãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰ -->
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg" />
    <link rel="icon" type="image/svg+xml" href="/setting/icons/favicon.svg" />
    <!-- WebPå½¢å¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ -->
    <link rel="icon" type="image/webp" sizes="256x256" href="/icons/favicon-256.webp" />
    <link rel="icon" type="image/webp" sizes="256x256" href="/setting/icons/favicon-256.webp" />
    <!-- Apple Touch Iconï¼ˆiPhone/iPadç”¨ï¼‰ -->
    <link rel="apple-touch-icon" sizes="256x256" href="/icons/favicon-256.png" />
    <link rel="apple-touch-icon" sizes="256x256" href="/setting/icons/favicon-256.png" />
    <!-- å¾“æ¥ã®shortcut icon -->
    <link rel="shortcut icon" href="/setting/icons/favicon-256.png" />
  </head>
  <body>
    <div class="container">
      <div class="page-header">
        <h1>WebDAV Pic Server</h1>
        <p class="page-subtitle">è¨­å®šç”»é¢</p>
      </div>

      <div class="grid">
        <div class="card">
          <form id="settingsForm" autocomplete="off">
            <div class="field-group">
              <h2 class="field-group-title">
                <span class="field-group-icon">ğŸ–¼ï¸</span>
                ç”»åƒå¤‰æ›è¨­å®š
              </h2>
              <div class="row checkbox-row">
                <label for="IMAGE_CONVERSION_ENABLED">ç”»åƒå¤‰æ›æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                <input type="checkbox" id="IMAGE_CONVERSION_ENABLED" name="IMAGE_CONVERSION_ENABLED" />
              </div>
              <div class="row" id="image-template-row">
                <label for="IMAGE_TEMPLATE">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                <select id="IMAGE_TEMPLATE" name="IMAGE_TEMPLATE">
                  <option value="">æœªé¸æŠ</option>
                  <option value="hq">0 - å…ƒç”»è³ª</option>
                  <option value="smallest">1 - æœ€ä½ç”»è³ª</option>
                  <option value="small">2 - ä½ç”»è³ª</option>
                  <option value="medium">3 - ä¸­ç”»è³ª</option>
                  <option value="large">4 - é«˜ç”»è³ª</option>
                </select>
              </div>
              <div class="row child" id="photo-size-row">
                <label for="PHOTO_SIZE">æœ€å¤§ç”»åƒã‚µã‚¤ã‚º (px)</label>
                <div class="field-control">
                  <input id="PHOTO_SIZE" name="PHOTO_SIZE" type="range" step="16" min="320" max="2400" />
                  <output id="PHOTO_SIZE_VAL" for="PHOTO_SIZE">1080</output>
                </div>
              </div>
              <div class="row child" id="default-quality-row">
                <label for="DEFAULT_QUALITY">å“è³ªï¼ˆ1 ã€œ 100ï¼‰</label>
                <div class="field-control">
                  <input id="DEFAULT_QUALITY" name="DEFAULT_QUALITY" type="range" step="1" min="1" max="100" />
                  <output id="DEFAULT_QUALITY_VAL" for="DEFAULT_QUALITY">50</output>
                </div>
              </div>
              <div class="row child" id="image-mode-row">
                <label for="IMAGE_MODE">ç”»åƒå‡¦ç†ãƒ¢ãƒ¼ãƒ‰</label>
                <select id="IMAGE_MODE" name="IMAGE_MODE">
                  <option value="1">1 - é«˜é€Ÿï¼ˆä½è² è·ï¼‰</option>
                  <option value="2">2 - ãƒãƒ©ãƒ³ã‚¹</option>
                  <option value="3">3 - é«˜åœ§ç¸®ï¼ˆé«˜è² è·ï¼‰</option>
                </select>
              </div>
              <div class="row child" id="webp-effort-row">
                <label for="WEBP_EFFORT">åœ§ç¸®åŠªåŠ› (0=æœ€é€Ÿ ... 6=æœ€é«˜åœ§ç¸®)</label>
                <div class="field-control">
                  <input id="WEBP_EFFORT" name="WEBP_EFFORT" type="range" step="1" min="0" max="6" />
                  <output id="WEBP_EFFORT_VAL" for="WEBP_EFFORT">1</output>
                </div>
              </div>
              <div class="row child" id="webp-effort-fast-row">
                <label for="WEBP_EFFORT_FAST">åœ§ç¸®åŠªåŠ› (é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ç”¨)</label>
                <div class="field-control">
                  <input id="WEBP_EFFORT_FAST" name="WEBP_EFFORT_FAST" type="range" step="1" min="0" max="2" />
                  <output id="WEBP_EFFORT_FAST_VAL" for="WEBP_EFFORT_FAST">0</output>
                </div>
              </div>
              <div class="row child checkbox-row" id="webp-detailed-enabled-row">
                <label for="WEBP_DETAILED_ENABLED">è©³ç´°è¨­å®š</label>
                <input type="checkbox" id="WEBP_DETAILED_ENABLED" name="WEBP_DETAILED_ENABLED" />
              </div>
              <div class="row child" id="webp-detailed-preset-row">
                <label for="WEBP_PRESET">ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                <select id="WEBP_PRESET" name="WEBP_PRESET">
                  <option value="default">default - æ¨™æº–</option>
                  <option value="picture">picture - å†™çœŸå‘ã‘</option>
                  <option value="photo">photo - é«˜å“è³ªå†™çœŸ</option>
                  <option value="drawing">drawing - å›³é¢ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆ</option>
                  <option value="icon">icon - ã‚¢ã‚¤ã‚³ãƒ³</option>
                  <option value="text">text - ãƒ†ã‚­ã‚¹ãƒˆ</option>
                </select>
              </div>
              <div class="row child" id="webp-detailed-reduction-row">
                <label for="WEBP_REDUCTION_EFFORT">å‰Šæ¸›åŠªåŠ› (0=ç„¡åŠ¹ ... 6=æœ€å¤§)</label>
                <div class="field-control">
                  <input id="WEBP_REDUCTION_EFFORT" name="WEBP_REDUCTION_EFFORT" type="range" step="1" min="0" max="6" />
                  <output id="WEBP_REDUCTION_EFFORT_VAL" for="WEBP_REDUCTION_EFFORT">0</output>
                </div>
              </div>
            </div>

            <div class="field-group">
              <h2 class="field-group-title">
                <span class="field-group-icon">ğŸ—œï¸</span>
                ãƒ¬ã‚¹ãƒãƒ³ã‚¹åœ§ç¸®è¨­å®š
              </h2>
              <div class="row checkbox-row">
                <label for="COMPRESSION_ENABLED">gzip åœ§ç¸®ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                <input id="COMPRESSION_ENABLED" name="COMPRESSION_ENABLED" type="checkbox" />
              </div>
              <div class="row">
                <label for="COMPRESSION_THRESHOLD">åœ§ç¸®é–¾å€¤ (0.00 ã€œ 1.00)</label>
                <div class="field-control">
                  <input id="COMPRESSION_THRESHOLD" name="COMPRESSION_THRESHOLD" type="range" step="0.01" min="0" max="1" />
                  <output id="COMPRESSION_THRESHOLD_VAL" for="COMPRESSION_THRESHOLD">0.00</output>
                </div>
              </div>
            </div>

            <div class="field-group">
              <h2 class="field-group-title">
                <span class="field-group-icon">ğŸ’¾</span>
                ã‚­ãƒ£ãƒƒã‚·ãƒ¥ / ãƒ¡ãƒ¢ãƒª
              </h2>
              <div class="row">
                <label for="CACHE_TTL_MS">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™ (ç§’)</label>
                <input id="CACHE_TTL_MS" name="CACHE_TTL_MS" type="number" min="0" inputmode="numeric" title="æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
              </div>
              <div class="row">
                <label for="CACHE_MIN_SIZE">ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ã®æœ€å°ã‚µã‚¤ã‚º (KB)</label>
                <input id="CACHE_MIN_SIZE" name="CACHE_MIN_SIZE" type="number" min="0" inputmode="numeric" title="æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (KB)" />
              </div>
              <div class="row">
                <label for="MAX_CONCURRENCY">åŒæ™‚å‡¦ç†æ•°ã®ä¸Šé™ï¼ˆ1 ã€œ 32ï¼‰</label>
                <div class="field-control">
                  <input id="MAX_CONCURRENCY" name="MAX_CONCURRENCY" type="range" step="1" min="1" max="32" />
                  <output id="MAX_CONCURRENCY_VAL" for="MAX_CONCURRENCY">4</output>
                </div>
              </div>
              <div class="row">
                <label for="SHARP_MEMORY_LIMIT">ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ä¸Šé™ (128 ã€œ 8192 MB)</label>
                <div class="field-control">
                  <input id="SHARP_MEMORY_LIMIT" name="SHARP_MEMORY_LIMIT" type="range" step="1" min="128" max="8192" />
                  <output id="SHARP_MEMORY_LIMIT_VAL" for="SHARP_MEMORY_LIMIT">512</output>
                </div>
              </div>
            </div>

            <div class="field-group">
              <h2 class="field-group-title">
                <span class="field-group-icon">âš™ï¸</span>
                ã‚µãƒ¼ãƒãƒ¼è¨­å®š
              </h2>
              <div class="row">
                <label for="PORT">å¾…ã¡å—ã‘ãƒãƒ¼ãƒˆç•ªå·</label>
                <input id="PORT" name="PORT" type="number" min="1" max="65535" inputmode="numeric" title="1ã€œ65535 ã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
              </div>
              <div class="row">
                <label for="ROOT_PATH">ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹</label>
                <input id="ROOT_PATH" name="ROOT_PATH" type="text" />
              </div>
              <div class="row">
                <label for="MAX_LIST">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§ã®æœ€å¤§ä»¶æ•°</label>
                <input id="MAX_LIST" name="MAX_LIST" type="number" min="1" inputmode="numeric" title="1 ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
              </div>
            </div>

            <div class="field-group">
              <h2 class="field-group-title">
                <span class="field-group-icon">ğŸš¦</span>
                ãƒ¬ãƒ¼ãƒˆåˆ¶é™
              </h2>
              <div class="row checkbox-row">
                <label for="RATE_LIMIT_ENABLED">ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                <input id="RATE_LIMIT_ENABLED" name="RATE_LIMIT_ENABLED" type="checkbox" />
              </div>
              <div class="row">
                <label for="RATE_LIMIT_REQUESTS">è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</label>
                <input id="RATE_LIMIT_REQUESTS" name="RATE_LIMIT_REQUESTS" type="number" min="0" inputmode="numeric" title="æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
              </div>
              <div class="row">
                <label for="RATE_LIMIT_WINDOW_MS">ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿå­˜æ™‚é–“ (ç§’)</label>
                <input id="RATE_LIMIT_WINDOW_MS" name="RATE_LIMIT_WINDOW_MS" type="number" min="0" inputmode="numeric" title="æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ç§’)" />
              </div>
              <div class="row">
                <label for="RATE_LIMIT_QUEUE_SIZE">ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚º</label>
                <input id="RATE_LIMIT_QUEUE_SIZE" name="RATE_LIMIT_QUEUE_SIZE" type="number" min="0" inputmode="numeric" title="æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
              </div>
            </div>

            <div class="field-group">
              <h2 class="field-group-title">
                <span class="field-group-icon">ğŸš¨</span>
                ç·Šæ€¥ / ã‚¹ã‚¿ãƒƒã‚¯ / å†èµ·å‹•
              </h2>
              <div class="row checkbox-row">
                <label for="EMERGENCY_DISABLE_RATE_LIMIT">ç·Šæ€¥æ™‚ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹</label>
                <input id="EMERGENCY_DISABLE_RATE_LIMIT" name="EMERGENCY_DISABLE_RATE_LIMIT" type="checkbox" />
              </div>
              <div class="row">
                <label for="STACK_MAX_SIZE">ã‚¹ã‚¿ãƒƒã‚¯æœ€å¤§ã‚µã‚¤ã‚º</label>
                <input id="STACK_MAX_SIZE" name="STACK_MAX_SIZE" type="number" min="1" inputmode="numeric" title="1 ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
              </div>
              <div class="row">
                <label for="STACK_PROCESSING_DELAY_MS">ã‚¹ã‚¿ãƒƒã‚¯å‡¦ç†é…å»¶ (ms)</label>
                <input id="STACK_PROCESSING_DELAY_MS" name="STACK_PROCESSING_DELAY_MS" type="number" min="0" inputmode="numeric" title="æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ms)" />
              </div>
            </div>

            <div class="field-group">
              <h2 class="field-group-title">
                <span class="field-group-icon">ğŸ”§</span>
                ãã®ä»–
              </h2>
              <div class="row">
                <label for="MAGICK_PATH">ImageMagick ã‚³ãƒãƒ³ãƒ‰ / ãƒ‘ã‚¹</label>
                <input id="MAGICK_PATH" name="MAGICK_PATH" type="text" />
              </div>
            </div>
          </form>
        </div>

        <section class="card full-width stats-card" id="statsPanel" aria-live="polite">
          <div class="stats-header">
            <h2 class="stats-title">
              <span class="stats-icon">ğŸ“Š</span>
              é€šä¿¡é‡ã®å‰Šæ¸›çŠ¶æ³
            </h2>
            <div class="stats-meta">
              <span id="statsUpdated" class="stats-meta-text">æ›´æ–°: --</span>
              <button type="button" id="statsRefresh" class="btn-ghost btn-small">æ›´æ–°</button>
            </div>
          </div>
          <div class="stats-summary">
            <div class="stat-box">
              <div class="stat-label">ç´¯è¨ˆå‰Šæ¸›é‡</div>
              <div class="stat-value" id="statsSavedBytes">--</div>
              <div class="stat-sub" id="statsSavedPercent">--</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ç´¯è¨ˆå‡¦ç†ä»¶æ•°</div>
              <div class="stat-value" id="statsRequestCount">--</div>
              <div class="stat-sub" id="statsSince">èµ·ç‚¹: --</div>
            </div>
          </div>
          <div class="stats-table-wrapper">
            <table class="stats-table">
              <thead>
                <tr>
                  <th scope="col">ã‚«ãƒ†ã‚´ãƒª</th>
                  <th scope="col">ä»¶æ•°</th>
                  <th scope="col">å‰Šæ¸›é‡</th>
                  <th scope="col">å‰Šæ¸›ç‡</th>
                  <th scope="col">å‚™è€ƒ</th>
                </tr>
              </thead>
              <tbody id="statsCategoryBody">
                <tr>
                  <td colspan="5" class="stats-empty">èª­ã¿è¾¼ã¿ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <!-- å›ºå®šè¡¨ç¤ºã•ã‚Œã‚‹ä¿å­˜ãƒãƒ¼ -->
    <div id="fixedBar" class="fixed-bar" aria-hidden="false">
      <div class="fixed-bar-inner">
        <button id="btnLoadFixed" class="btn-ghost" type="button">
          <span class="btn-icon">â†»</span>
          å†èª­ã¿è¾¼ã¿
        </button>
        <button id="btnSaveFixed" class="btn-primary" type="button">
          <span class="btn-icon">âœ“</span>
          ä¿å­˜
        </button>
        <button id="themeToggle" class="btn-ghost" type="button">
          <span class="btn-icon">ğŸŒ™</span>
          <span class="btn-text">ãƒ€ãƒ¼ã‚¯</span>
        </button>
      </div>
    </div>
    <div class="status-popup-stack" id="statusPopupContainer" aria-live="polite" aria-atomic="true"></div>

    <script>
      // ==========================================
      // ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ¦‚è¦ï¼ˆæ—¥æœ¬èªï¼‰
      // ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚µãƒ¼ãƒä¸Šã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸã—ã¾ã™ã€‚
      // ä¸»ãªæ©Ÿèƒ½:
      //  - /setting/data ã‹ã‚‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã™ã‚‹ (loadConfig)
      //  - ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‹ã‚‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ (buildConfigText)
      //  - /setting/save ã« POST ã—ã¦ä¿å­˜ã™ã‚‹ (saveConfig)
      //  - UI è¡¨ç¤ºã®è£œåŠ©ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å‡ºåŠ›è¡¨ç¤ºã€ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«åŒ–ï¼‰
      //  - å…¥åŠ›æ¤œè¨¼ã¨æœªä¿å­˜åˆ¤å®šï¼ˆdirty ãƒã‚§ãƒƒã‚¯ï¼‰
      // å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã¯å…ƒã®ã¾ã¾ã«ã—ã€å¯èª­æ€§å‘ä¸Šã®ãŸã‚ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚
      // ==========================================
      /*
    åˆ‡ã‚Šæ›¿ãˆã‚¬ã‚¤ãƒ‰ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰

    ç¾åœ¨ã®å®Ÿè£…:
      - è¡Œã®ç„¡åŠ¹åŒ–ã¯ "å‡ºç¾/æ¶ˆæ»…"ï¼ˆCSS ã‚¯ãƒ©ã‚¹ `.row.hidden` ã‚’ä»˜ã‘å¤–ã—ï¼‰ã§è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚
        ã“ã‚Œã¯ DOM ä¸Šã§è¦ç´ ã‚’å®Œå…¨ã«éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¦‹ãˆãªããªã‚Šã€æ“ä½œã§ããªããªã‚Šã¾ã™ã€‚
      - å…ƒã®å®Ÿè£…ï¼ˆè‰²ã§ãƒ‡ã‚£ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦æ®‹ã—ã¦ã‚ã‚Šã¾ã™ï¼ˆ`.row.disabled` ã‚’ä»˜ã‘å¤–ã—ï¼‰ã€‚

    ç›®çš„:
      - ã™ãã«å…ƒã«æˆ»ã›ã‚‹ã‚ˆã†ã€ã©ã®ç®‡æ‰€ã‚’å¤‰æ›´ã™ã‚Œã°ã‚ˆã„ã‹æ‰‹é †ã‚’æ®‹ã—ã¾ã™ã€‚

    1) å…ƒã®ï¼ˆè‰²ã§ãƒ‡ã‚£ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰æ–¹å¼ã«æˆ»ã™æ‰‹é †ï¼ˆæ‰‹å‹•ï¼‰
      - è©²å½“ç®‡æ‰€: populateForm ã¨ init å†…ã®å„ toggle ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆCOMPRESSION, IMAGE_MODE, RATE_LIMIT, RESTARTï¼‰ã«ã‚ã‚Šã¾ã™ã€‚
      - ä¾‹: ç¾åœ¨ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼ˆå‡ºç¾/æ¶ˆæ»…ï¼‰:
          row.classList.add('hidden');
           // row.classList.add('disabled');
          webpFastRow.classList.remove('hidden');
           // webpFastRow.classList.remove('disabled');
      - å…ƒã«æˆ»ã™ã«ã¯ä¸Šè¨˜ã§ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ã•ã‚Œã¦ã„ã‚‹è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã€`hidden` ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤ã—ã¦ãã ã•ã„:
           // row.classList.add('hidden');
          row.classList.add('disabled');
           // webpFastRow.classList.remove('hidden');
          webpFastRow.classList.remove('disabled');

    2) ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ã‘ã« input ã®ç„¡åŠ¹åŒ–ï¼ˆæ¨å¥¨ï¼‰ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•
      - è¦–è¦šçš„ã«éè¡¨ç¤ºã«ã™ã‚‹ã ã‘ã§ãªãã€é–¢é€£ã™ã‚‹ input è¦ç´ ã«å¯¾ã—ã¦ `el.disabled = true/false` ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã‚„ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã«å¯¾ã—ã¦ã‚‚æ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚
      - ä¾‹ï¼ˆtoggle é–¢æ•°å†…ã«è¿½åŠ ï¼‰:
          const slider = byId('COMPRESSION_THRESHOLD');
          if (disable) {
            row.classList.add('hidden');
             if (slider) slider.disabled = true;  // ã“ã“ã‚’è¿½åŠ 
          } else {
            row.classList.remove('hidden');
             if (slider) slider.disabled = false; // ã“ã“ã‚’è¿½åŠ 
          }

    3) å®‰å…¨å¯¾ç­–
      - ã¾ãšã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã§æ—§å®Ÿè£…ã‚’æ®‹ã—ã¦ã„ã¾ã™ã€‚å‹•ä½œç¢ºèªå¾Œã«ä¸è¦ã§ã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’å‰Šé™¤ã—ã¦æ•´ç†ã—ã¦ãã ã•ã„ã€‚
      - å¤‰æ›´ã¯ populateFormï¼ˆåˆæœŸåæ˜ ï¼‰ã¨ initï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ï¼‰åŒæ–¹ã«åæ˜ ã—ã¦ãã ã•ã„ã€‚

    å‚è€ƒ: å¤‰æ›´ç®‡æ‰€ã‚’ grep ã—ãŸã„å ´åˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
      - "classList.add('hidden')" / "classList.remove('hidden')"
      - ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ã•ã‚ŒãŸæ—§è¡Œ: "classList.add('disabled')" / "classList.remove('disabled')"

  */
      // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã¨è¨­å®šã‚­ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
      const keys = ["COMPRESSION_ENABLED", "COMPRESSION_THRESHOLD", "PORT", "ROOT_PATH", "MAX_LIST", "IMAGE_CONVERSION_ENABLED", "PHOTO_SIZE", "DEFAULT_QUALITY", "IMAGE_MODE", "CACHE_TTL_MS", "CACHE_MIN_SIZE", "MAX_CONCURRENCY", "SHARP_MEMORY_LIMIT", "SHARP_PIXEL_LIMIT", "WEBP_EFFORT", "WEBP_EFFORT_FAST", "WEBP_PRESET", "WEBP_REDUCTION_EFFORT", "WEBP_DETAILED_ENABLED", "RATE_LIMIT_ENABLED", "RATE_LIMIT_REQUESTS", "RATE_LIMIT_WINDOW_MS", "RATE_LIMIT_QUEUE_SIZE", "EMERGENCY_DISABLE_RATE_LIMIT", "STACK_MAX_SIZE", "STACK_PROCESSING_DELAY_MS", "RESTART_ENABLED", "RESTART_TIME", "MAGICK_PATH"];

      // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      const byId = (id) => document.getElementById(id);
      const statusEl = byId("status");
      const popupContainer = byId("statusPopupContainer");
      const rawEl = byId("raw");
      const themeBtn = byId("themeToggle");
      const statsEls = {
        panel: document.getElementById("statsPanel"),
        refreshBtn: document.getElementById("statsRefresh"),
        savedBytes: document.getElementById("statsSavedBytes"),
        savedPercent: document.getElementById("statsSavedPercent"),
        requestCount: document.getElementById("statsRequestCount"),
        since: document.getElementById("statsSince"),
        updated: document.getElementById("statsUpdated"),
        tbody: document.getElementById("statsCategoryBody"),
      };
      // æœªä¿å­˜æ¤œå‡ºã®ãŸã‚ã®åˆæœŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
      let initialConfigText = null;
      let statsIntervalId = null;

      // ãƒ†ãƒ¼ãƒåˆ‡æ›¿ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ï¼‰
      function applyTheme(theme) {
        if (theme === "dark") document.documentElement.setAttribute("data-theme", "dark");
        else document.documentElement.removeAttribute("data-theme");
        try {
          if (themeBtn) {
            const btnText = themeBtn.querySelector(".btn-text");
            const btnIcon = themeBtn.querySelector(".btn-icon");
            if (btnText) btnText.textContent = theme === "dark" ? "ãƒ©ã‚¤ãƒˆ" : "ãƒ€ãƒ¼ã‚¯";
            if (btnIcon) btnIcon.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
          }
        } catch (e) {}
      }

      function loadTheme() {
        try {
          const t = localStorage.getItem("settings_theme") || "light";
          applyTheme(t);
        } catch (e) {}
      }

      function toggleTheme() {
        try {
          const current = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          localStorage.setItem("settings_theme", next);
          applyTheme(next);
        } catch (e) {}
      }

      const statsCategoryLabels = {
        image: "ç”»åƒå¤‰æ›",
        text: "ãƒ†ã‚­ã‚¹ãƒˆåœ§ç¸®",
      };

      function formatBytesHuman(bytes) {
        const num = Number(bytes);
        if (!Number.isFinite(num) || num <= 0) return "0 B";
        const units = ["B", "KB", "MB", "GB", "TB"];
        let value = num;
        let unitIndex = 0;
        while (value >= 1024 && unitIndex < units.length - 1) {
          value /= 1024;
          unitIndex++;
        }
        const digits = value >= 100 ? 0 : value >= 10 ? 1 : 2;
        return `${value.toFixed(digits)} ${units[unitIndex]}`;
      }

      function formatPercentFromRatio(ratio) {
        const num = Number(ratio);
        if (!Number.isFinite(num) || num <= 0) return "0%";
        const value = num * 100;
        return `${value.toFixed(value >= 10 ? 1 : 2)}%`;
      }

      function formatDateTime(isoString) {
        if (!isoString) return "--";
        try {
          return new Date(isoString).toLocaleString("ja-JP", { hour12: false });
        } catch (e) {
          return isoString;
        }
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã«å¿œã˜ãŸè£…é£¾æƒ…å ±ã‚’è¿”ã™
      function resolveStatusVisual(message, err) {
        const base = { className: "", title: "ãŠçŸ¥ã‚‰ã›", icon: "i" };
        if (!message) return base;
        if (err) return { className: "is-error", title: "ã‚¨ãƒ©ãƒ¼", icon: "!" };
        if (/å®Œäº†|æˆåŠŸ|å®Œäº†ã—ã¾ã—ãŸ|ä¿å­˜ãŒå®Œäº†/.test(message)) {
          return { className: "is-success", title: "æˆåŠŸ", icon: "âœ“" };
        }
        if (/ä¸­|å®Ÿè¡Œ|ç¢ºèª|èª­ã¿è¾¼ã¿/.test(message)) {
          return { className: "is-progress", title: "å‡¦ç†ä¸­", icon: "â€¦" };
        }
        return base;
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºã™ã‚‹
      function showStatusPopup(message, err) {
        try {
          if (!popupContainer || !message) return;
          const visual = resolveStatusVisual(message, err);
          const item = document.createElement("div");
          item.className = "status-popup" + (visual.className ? ` ${visual.className}` : "");
          item.setAttribute("role", "status");
          const icon = document.createElement("span");
          icon.className = "status-popup-icon";
          icon.textContent = visual.icon;
          const body = document.createElement("div");
          body.className = "status-popup-body";
          const title = document.createElement("div");
          title.className = "status-popup-title";
          title.textContent = visual.title;
          const text = document.createElement("div");
          text.className = "status-popup-message";
          text.textContent = message;
          body.appendChild(title);
          body.appendChild(text);
          item.appendChild(icon);
          item.appendChild(body);
          popupContainer.appendChild(item);
          requestAnimationFrame(() => item.classList.add("is-visible"));
          setTimeout(() => {
            item.classList.remove("is-visible");
            setTimeout(() => {
              try {
                item.remove();
              } catch (e) {}
            }, 220);
          }, 2000);
        } catch (e) {}
      }

      function setStatus(msg, err) {
        try {
          if (msg) showStatusPopup(msg, err);
          if (!statusEl) return;
          statusEl.textContent = msg || "";
          statusEl.style.color = err ? "var(--danger)" : "";
        } catch (e) {
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã® DOM æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
        }
      }

      function renderStats(snapshot) {
        if (!statsEls.panel) return;
        const totals = snapshot && snapshot.totals ? snapshot.totals : {};
        if (statsEls.savedBytes) statsEls.savedBytes.textContent = formatBytesHuman(totals.savedBytes);
        if (statsEls.savedPercent) statsEls.savedPercent.textContent = formatPercentFromRatio(totals.reductionRatio);
        if (statsEls.requestCount) statsEls.requestCount.textContent = (totals.requests || 0).toLocaleString("ja-JP");
        if (statsEls.since) {
          statsEls.since.textContent = snapshot && snapshot.since ? `é–‹å§‹: ${formatDateTime(snapshot.since)}` : "é–‹å§‹: --";
        }
        if (statsEls.updated) {
          statsEls.updated.textContent = snapshot && snapshot.lastUpdated ? `æ›´æ–°: ${formatDateTime(snapshot.lastUpdated)}` : "æ›´æ–°: --";
        }
        if (statsEls.tbody) {
          statsEls.tbody.innerHTML = buildStatsRows(snapshot && snapshot.categories);
        }
      }

      function renderStatsError(message) {
        if (!statsEls.panel || !statsEls.tbody) return;
        statsEls.savedBytes && (statsEls.savedBytes.textContent = "--");
        statsEls.savedPercent && (statsEls.savedPercent.textContent = "--");
        statsEls.requestCount && (statsEls.requestCount.textContent = "--");
        statsEls.updated && (statsEls.updated.textContent = "æ›´æ–°: ã‚¨ãƒ©ãƒ¼");
        statsEls.tbody.innerHTML = `<tr><td colspan="5" class="stats-empty">å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ (${message})</td></tr>`;
      }

      function buildStatsRows(categories) {
        const entries = Object.entries(categories || {});
        if (!entries.length) {
          return '<tr><td colspan="5" class="stats-empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        }
        return entries
          .map(([key, data]) => {
            const label = statsCategoryLabels[key] || key;
            const requests = (data && data.requests ? data.requests : 0).toLocaleString("ja-JP");
            const saved = formatBytesHuman(data && data.savedBytes);
            const percent = formatPercentFromRatio(data && data.reductionRatio);
            const memoParts = [];
            if (data && data.cacheHits) memoParts.push(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ${data.cacheHits.toLocaleString("ja-JP")}ä»¶`);
            if (data && data.maxSavedBytes) memoParts.push(`æœ€å¤§ ${formatBytesHuman(data.maxSavedBytes)}`);
            const memo = memoParts.length ? memoParts.join(" / ") : "â€”";
            return `<tr><th scope="row">${label}</th><td>${requests}</td><td>${saved}</td><td>${percent}</td><td>${memo}</td></tr>`;
          })
          .join("");
      }

      async function loadStatsPanel(manual) {
        if (!statsEls.panel) return;
        if (manual) {
          if (statsEls.refreshBtn) statsEls.refreshBtn.disabled = true;
          showStatusPopup("é€šä¿¡é‡ã®å‰Šæ¸›çŠ¶æ³ã‚’å†èª­è¾¼ä¸­...", false);
        }
        try {
          const response = await fetch("/setting/stats");
          if (!response.ok) throw new Error("HTTP " + response.status);
          const snapshot = await response.json();
          renderStats(snapshot);
          if (manual) showStatusPopup("é€šä¿¡é‡ã®å‰Šæ¸›çŠ¶æ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ", false);
        } catch (err) {
          const msg = err && err.message ? err.message : "unknown";
          renderStatsError(msg);
          if (manual) showStatusPopup("é€šä¿¡é‡ã®å‰Šæ¸›çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + msg, true);
        } finally {
          if (manual && statsEls.refreshBtn) statsEls.refreshBtn.disabled = false;
        }
      }

      function initStatsPanel() {
        if (!statsEls.panel) return;
        loadStatsPanel(true);
        if (statsEls.refreshBtn) {
          statsEls.refreshBtn.addEventListener("click", () => loadStatsPanel(true));
        }
        if (statsIntervalId) clearInterval(statsIntervalId);
        statsIntervalId = setInterval(loadStatsPanel, 15000);
      }

      // config.txt ã®å†…å®¹ã‚’è§£æã—ã¦ { KEY: value } å½¢å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
      // - ã‚³ãƒ¡ãƒ³ãƒˆè¡Œ(#)ãŠã‚ˆã³ç©ºè¡Œã¯ç„¡è¦–
      // - å€¤ã¯æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒã—ã€UI å´ã§å¿…è¦ã«å¿œã˜ã¦å‹å¤‰æ›ã™ã‚‹
      function parseConfig(text) {
        const out = {};
        const lines = text.split(/\r?\n/);
        for (const line of lines) {
          const t = line.trim();
          if (!t || t.startsWith("#")) continue;
          const idx = t.indexOf("=");
          if (idx === -1) continue;
          const k = t.slice(0, idx).trim();
          let v = t.slice(idx + 1).trim();
          // å€¤ã¯æ–‡å­—åˆ—ã®ã¾ã¾ä¿æŒã—ã€UI å´ã§çœŸå½å€¤ã‚„æ•°å€¤ã¨ã—ã¦è§£é‡ˆã—ã¾ã™
          out[k] = v;
        }
        return out;
      }

      // è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã«å€¤ã‚’åæ˜ ã™ã‚‹
      // - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯ 'true'/'false' æ–‡å­—åˆ—ã‚’çœŸå½ã«å¤‰æ›
      // - ä¸€éƒ¨ã®é …ç›®ã¯è¡¨ç¤ºå˜ä½ï¼ˆç§’/KBï¼‰ã«å¤‰æ›ã—ã¦è¡¨ç¤ºã™ã‚‹
      function populateForm(cfg) {
        for (const k of keys) {
          const el = byId(k);
          if (!el) continue;
          const v = cfg[k];
          if (el.type === "checkbox") {
            el.checked = typeof v !== "undefined" ? String(v).toLowerCase() === "true" : false;
          } else {
            el.value = typeof v !== "undefined" ? v : "";
          }
        }
        // ç”Ÿãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º/æ›´æ–°
        buildRaw();
        // åœ§ç¸®é–¾å€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆèª­ã¿è¾¼ã‚“ã è¨­å®šã‚’åæ˜ ï¼‰
        try {
          const compSlider = byId("COMPRESSION_THRESHOLD");
          const compOut = byId("COMPRESSION_THRESHOLD_VAL");
          if (compSlider && compOut) {
            const n = Number(compSlider.value || 0);
            compOut.textContent = isNaN(n) ? "0.00" : n.toFixed(2);
          }
          // åœ§ç¸®æœ‰åŠ¹ãƒ•ãƒ©ã‚°ã«å¿œã˜ã¦åœ§ç¸®é–¾å€¤è¡Œã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
          try {
            const compRow = compSlider ? compSlider.closest(".row") : null;
            const compFlag = byId("COMPRESSION_ENABLED");
            if (compRow && compFlag) {
              // å­é …ç›®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
              try {
                compRow.classList.add("child");
              } catch (e) {}
              if (compFlag.checked) {
                compRow.classList.remove("hidden");
                // compRow.classList.remove('disabled');
              } else {
                compRow.classList.add("hidden");
                // compRow.classList.add('disabled');
              }
            }
          } catch (e) {}
        } catch (e) {}
        // CACHE_TTL_MSï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ msï¼‰ã‚’ UI ç”¨ã«ç§’ã«å¤‰æ›
        try {
          const el = byId("CACHE_TTL_MS");
          if (el) {
            const raw = cfg["CACHE_TTL_MS"];
            if (typeof raw !== "undefined" && raw !== "") {
              const ms = Number(raw);
              if (!isNaN(ms)) el.value = String(Math.round(ms / 1000));
            }
          }
        } catch (e) {}
        // CACHE_MIN_SIZEï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ bytesï¼‰ã‚’ UI ç”¨ã« KB ã«å¤‰æ›
        try {
          const el = byId("CACHE_MIN_SIZE");
          if (el) {
            const raw = cfg["CACHE_MIN_SIZE"];
            if (typeof raw !== "undefined" && raw !== "") {
              const bytes = Number(raw);
              if (!isNaN(bytes)) el.value = String(Math.round(bytes / 1024));
            }
          }
        } catch (e) {}
        // RATE_LIMIT_WINDOW_MSï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ msï¼‰ã‚’ UI ç”¨ã«ç§’ã«å¤‰æ›
        try {
          const el = byId("RATE_LIMIT_WINDOW_MS");
          if (el) {
            const raw = cfg["RATE_LIMIT_WINDOW_MS"];
            if (typeof raw !== "undefined" && raw !== "") {
              const ms = Number(raw);
              if (!isNaN(ms)) el.value = String(Math.round(ms / 1000));
            }
          }
        } catch (e) {}
        // DEFAULT_QUALITY ã®è¡¨ç¤ºã‚’æ›´æ–°
        try {
          const qSlider = byId("DEFAULT_QUALITY");
          const qOut = byId("DEFAULT_QUALITY_VAL");
          if (qSlider && qOut) {
            const n = Number(qSlider.value || 50);
            qOut.textContent = isNaN(n) ? "50" : String(n);
          }
        } catch (e) {}
        // WEBP_EFFORT ã¨ WEBP_EFFORT_FAST ã®è¡¨ç¤ºæ›´æ–°
        try {
          const eSlider = byId("WEBP_EFFORT");
          const eOut = byId("WEBP_EFFORT_VAL");
          if (eSlider && eOut) {
            const n = Number(eSlider.value || 1);
            eOut.textContent = isNaN(n) ? "1" : String(Math.round(n));
          }
        } catch (e) {}
        try {
          const efSlider = byId("WEBP_EFFORT_FAST");
          const efOut = byId("WEBP_EFFORT_FAST_VAL");
          if (efSlider && efOut) {
            const n = Number(efSlider.value || 0);
            efOut.textContent = isNaN(n) ? "0" : String(Math.round(n));
          }
        } catch (e) {}
        try {
          const reSlider = byId("WEBP_REDUCTION_EFFORT");
          const reOut = byId("WEBP_REDUCTION_EFFORT_VAL");
          if (reSlider && reOut) {
            const n = Number(reSlider.value || 0);
            reOut.textContent = isNaN(n) ? "0" : String(Math.round(n));
          }
        } catch (e) {}
        // IMAGE_CONVERSION_ENABLED ã®åˆæœŸçŠ¶æ…‹ã«å¿œã˜ã¦ç”»åƒå¤‰æ›é–¢é€£é …ç›®ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
        try {
          const imgConvFlag = byId("IMAGE_CONVERSION_ENABLED");
          const imgTemplateRow = byId("image-template-row");
          const photoSizeRow = byId("photo-size-row");
          const defaultQualityRow = byId("default-quality-row");
          const imageModeRow = byId("image-mode-row");
          const webpEffortRow = byId("webp-effort-row");
          const webpEffortFastRow = byId("webp-effort-fast-row");
          const webpDetailedEnabledRow = byId("webp-detailed-enabled-row");
          const webpPresetRow = byId("webp-detailed-preset-row");
          const webpReductionRow = byId("webp-detailed-reduction-row");
          if (imgConvFlag && (imgTemplateRow || photoSizeRow || defaultQualityRow || imageModeRow)) {
            // å­é …ç›®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
            try {
              [imgTemplateRow, photoSizeRow, defaultQualityRow, imageModeRow, webpEffortRow, webpEffortFastRow, webpDetailedEnabledRow, webpPresetRow, webpReductionRow].forEach((r) => {
                if (r) r.classList.add("child");
              });
            } catch (e) {}
            const disable = !imgConvFlag.checked;
            [imgTemplateRow, photoSizeRow, defaultQualityRow, imageModeRow, webpEffortRow, webpEffortFastRow, webpDetailedEnabledRow, webpPresetRow, webpReductionRow].forEach((r) => {
              if (!r) return;
              if (disable) {
                r.classList.add("hidden"); /* r.classList.add('disabled'); */
              } else {
                r.classList.remove("hidden"); /* r.classList.remove('disabled'); */
              }
            });
          }
        } catch (e) {}
        // IMAGE_MODE ã«å¿œã˜ã¦ WebP effort ã®è¡Œã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–ï¼ˆIMAGE_CONVERSION_ENABLEDãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
        try {
          const imgConvFlag = byId("IMAGE_CONVERSION_ENABLED");
          const imgMode = byId("IMAGE_MODE");
          const webpRow = byId("WEBP_EFFORT") ? byId("WEBP_EFFORT").closest(".row") : null;
          const webpFastRow = byId("WEBP_EFFORT_FAST") ? byId("WEBP_EFFORT_FAST").closest(".row") : null;
          if (imgMode && webpRow && webpFastRow && imgConvFlag && imgConvFlag.checked) {
            // ãƒ¢ãƒ¼ãƒ‰ '1' = é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ (é«˜é€Ÿç”¨ effort ã‚’æœ‰åŠ¹ã«ã™ã‚‹)
            if (String(imgMode.value) === "1") {
              webpRow.classList.add("hidden");
              // webpRow.classList.add('disabled');
              webpFastRow.classList.remove("hidden");
              // webpFastRow.classList.remove('disabled');
            } else {
              webpRow.classList.remove("hidden");
              // webpRow.classList.remove('disabled');
              webpFastRow.classList.add("hidden");
              // webpFastRow.classList.add('disabled');
            }
          }
        } catch (e) {}
        // WEBP_DETAILED_ENABLED ã®åˆæœŸçŠ¶æ…‹ã«å¿œã˜ã¦é–¢é€£è¡Œã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–ï¼ˆIMAGE_CONVERSION_ENABLEDãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
        try {
          const imgConvFlag = byId("IMAGE_CONVERSION_ENABLED");
          const webpDetailedFlag = byId("WEBP_DETAILED_ENABLED");
          const webpPresetRow = byId("webp-detailed-preset-row");
          const webpReductionRow = byId("webp-detailed-reduction-row");
          if (webpDetailedFlag && (webpPresetRow || webpReductionRow) && imgConvFlag && imgConvFlag.checked) {
            // ã•ã‚‰ã«æ·±ã„éšå±¤ã®å­é …ç›®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
            try {
              [webpPresetRow, webpReductionRow].forEach((r) => {
                if (r) {
                  r.classList.remove("child");
                  r.classList.add("child-2");
                }
              });
            } catch (e) {}
            const disable = !webpDetailedFlag.checked;
            [webpPresetRow, webpReductionRow].forEach((r) => {
              if (!r) return;
              if (disable) {
                r.classList.add("hidden"); /* r.classList.add('disabled'); */
              } else {
                r.classList.remove("hidden"); /* r.classList.remove('disabled'); */
              }
            });
          }
        } catch (e) {}
        // RATE_LIMIT_ENABLED ã«å¿œã˜ã¦ãƒ¬ãƒ¼ãƒˆåˆ¶é™é–¢é€£è¡Œã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
        try {
          const rateFlag = byId("RATE_LIMIT_ENABLED");
          const rReq = byId("RATE_LIMIT_REQUESTS") ? byId("RATE_LIMIT_REQUESTS").closest(".row") : null;
          const rWin = byId("RATE_LIMIT_WINDOW_MS") ? byId("RATE_LIMIT_WINDOW_MS").closest(".row") : null;
          const rQueue = byId("RATE_LIMIT_QUEUE_SIZE") ? byId("RATE_LIMIT_QUEUE_SIZE").closest(".row") : null;
          if (rateFlag && (rReq || rWin || rQueue)) {
            // å­é …ç›®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
            try {
              [rReq, rWin, rQueue].forEach((r) => {
                if (r) r.classList.add("child");
              });
            } catch (e) {}
            const disable = !rateFlag.checked;
            [rReq, rWin, rQueue].forEach((r) => {
              if (!r) return;
              if (disable) {
                r.classList.add("hidden"); /* r.classList.add('disabled'); */
              } else {
                r.classList.remove("hidden"); /* r.classList.remove('disabled'); */
              }
            });
          }
        } catch (e) {}
        // RESTART_ENABLED ã«å¿œã˜ã¦è‡ªå‹•å†èµ·å‹•æ™‚åˆ»å…¥åŠ›ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
        try {
          const restartFlag = byId("RESTART_ENABLED");
          const restartTimeRow = byId("RESTART_TIME") ? byId("RESTART_TIME").closest(".row") : null;
          if (restartFlag && restartTimeRow) {
            // å­é …ç›®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
            try {
              restartTimeRow.classList.add("child");
            } catch (e) {}
            if (restartFlag.checked) {
              restartTimeRow.classList.remove("hidden");
              // restartTimeRow.classList.remove('disabled');
            } else {
              restartTimeRow.classList.add("hidden");
              // restartTimeRow.classList.add('disabled');
            }
          }
        } catch (e) {}
        // WEBP_DETAILED_ENABLED ã®åˆæœŸçŠ¶æ…‹ã«å¿œã˜ã¦é–¢é€£è¡Œã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–ï¼ˆåˆæœŸè¡¨ç¤ºæ™‚ã®æŠ˜ã‚Šç•³ã¿è§£é™¤å¯¾å¿œï¼‰
        try {
          const webpDetailedFlag = byId("WEBP_DETAILED_ENABLED");
          const webpPresetRow = byId("webp-detailed-preset-row");
          const webpReductionRow = byId("webp-detailed-reduction-row");
          const imgConvFlag = byId("IMAGE_CONVERSION_ENABLED");
          // è¡¨ç¤ºåˆ‡æ›¿ã¯ç”»åƒå¤‰æ›æ©Ÿèƒ½ãŒæœ‰åŠ¹ãªå ´åˆã«ã®ã¿åæ˜ ã™ã‚‹ã€‚
          if (webpDetailedFlag && (webpPresetRow || webpReductionRow) && imgConvFlag && imgConvFlag.checked) {
            const disable = !webpDetailedFlag.checked;
            [webpPresetRow, webpReductionRow].forEach((r) => {
              if (!r) return;
              if (disable) {
                r.classList.add("hidden"); /* r.classList.add('disabled'); */
              } else {
                r.classList.remove("hidden"); /* r.classList.remove('disabled'); */
              }
            });
          } else {
            // IMAGE_CONVERSION_ENABLED ãŒç„¡åŠ¹ãªå ´åˆã¯å¸¸ã«æŠ˜ã‚Šç•³ã‚€
            [webpPresetRow, webpReductionRow].forEach((r) => {
              if (!r) return;
              r.classList.add("hidden");
            });
          }
        } catch (e) {}
        // PHOTO_SIZE ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºã‚’æ›´æ–° (px è¡¨ç¤º)
        try {
          const pSlider = byId("PHOTO_SIZE");
          const pOut = byId("PHOTO_SIZE_VAL");
          if (pSlider && pOut) {
            const n = Number(pSlider.value || 1080);
            pOut.textContent = isNaN(n) ? "1080" : String(Math.round(n));
          }
        } catch (e) {}
        // MAX_CONCURRENCY ã®è¡¨ç¤ºã‚’æ›´æ–°
        try {
          const mSlider = byId("MAX_CONCURRENCY");
          const mOut = byId("MAX_CONCURRENCY_VAL");
          if (mSlider && mOut) {
            const n = Number(mSlider.value || 4);
            mOut.textContent = isNaN(n) ? "4" : String(Math.round(n));
          }
        } catch (e) {}
        // SHARP_MEMORY_LIMIT ã®è¡¨ç¤ºã‚’æ›´æ–°
        try {
          const sSlider = byId("SHARP_MEMORY_LIMIT");
          const sOut = byId("SHARP_MEMORY_LIMIT_VAL");
          if (sSlider && sOut) {
            const n = Number(sSlider.value || 512);
            sOut.textContent = isNaN(n) ? "512" : String(Math.round(n));
          }
        } catch (e) {}
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡Œã®ãƒˆã‚°ãƒ«è¡¨ç¤ºã‚’ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«åŒæœŸ
        try {
          document.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
            try {
              const row = cb.closest(".checkbox-row");
              if (!row) return;
              const sw = row.querySelector(".switch");
              if (!sw) return;
              if (cb.checked) sw.classList.add("on");
              else sw.classList.remove("on");
              sw.setAttribute("aria-checked", cb.checked ? "true" : "false");
            } catch (e) {}
          });
        } catch (e) {}
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ã®ç¾åœ¨å€¤ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµ„ã¿ç«‹ã¦ã‚‹
      // - UI è¡¨ç¤ºã®å˜ä½å¤‰æ›ï¼ˆç§’â†’msã€KBâ†’bytesï¼‰ã‚’é€†å¤‰æ›ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®å€¤ã«æ•´å½¢ã™ã‚‹
      function buildConfigText() {
        const header = ["# WebDAVç”»åƒå¤‰æ›ã‚µãƒ¼ãƒãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (è‡ªå‹•ç”Ÿæˆ)", "# ç·¨é›†ã¯ãƒ•ã‚©ãƒ¼ãƒ ã§è¡Œã£ã¦ãã ã•ã„ã€‚"];
        const lines = [...header];
        // å‡ºåŠ›é †ï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã«è¿‘ã„é †åºï¼‰
        const add = (k) => {
          const el = byId(k);
          if (!el) return;
          let v;
          if (el.type === "checkbox") v = el.checked ? "true" : "false";
          else if (k === "CACHE_TTL_MS") {
            // UI ã¯ç§’è¡¨ç¤ºã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã«ãƒŸãƒªç§’ã«æˆ»ã™
            const secs = Number(el.value || 0);
            v = String(Math.round((isNaN(secs) ? 0 : secs) * 1000));
          } else if (k === "CACHE_MIN_SIZE") {
            // UI ã¯ KB è¡¨ç¤ºã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã«ãƒã‚¤ãƒˆã«æˆ»ã™
            const kb = Number(el.value || 0);
            v = String(Math.round((isNaN(kb) ? 0 : kb) * 1024));
          } else if (k === "RATE_LIMIT_WINDOW_MS") {
            // UI ã¯ç§’è¡¨ç¤ºã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã«ãƒŸãƒªç§’ã«æˆ»ã™
            const secs = Number(el.value || 0);
            v = String(Math.round((isNaN(secs) ? 0 : secs) * 1000));
          } else v = el.value ?? "";
          lines.push(`${k}=${v}`);
        };
        const groups = [["COMPRESSION_ENABLED", "COMPRESSION_THRESHOLD"], ["PORT", "ROOT_PATH", "MAX_LIST"], ["IMAGE_CONVERSION_ENABLED", "PHOTO_SIZE", "DEFAULT_QUALITY", "IMAGE_MODE"], ["WEBP_EFFORT", "WEBP_EFFORT_FAST", "WEBP_PRESET", "WEBP_REDUCTION_EFFORT", "WEBP_DETAILED_ENABLED"], ["CACHE_TTL_MS", "CACHE_MIN_SIZE", "MAX_CONCURRENCY", "SHARP_MEMORY_LIMIT", "SHARP_PIXEL_LIMIT"], ["RATE_LIMIT_ENABLED", "RATE_LIMIT_REQUESTS", "RATE_LIMIT_WINDOW_MS", "RATE_LIMIT_QUEUE_SIZE"], ["EMERGENCY_DISABLE_RATE_LIMIT"], ["STACK_MAX_SIZE", "STACK_PROCESSING_DELAY_MS"], ["RESTART_ENABLED", "RESTART_TIME"], ["MAGICK_PATH"]];
        for (const g of groups) {
          lines.push(""); // ã‚°ãƒ«ãƒ¼ãƒ—é–“ã«ç©ºè¡Œã‚’æŒ¿å…¥
          for (const k of g) add(k);
        }
        return lines.join("\n") + "\n";
      }

      // ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆrawï¼‰ã‚’æ›´æ–°ã™ã‚‹
      function buildRaw() {
        if (!rawEl) return;
        rawEl.textContent = buildConfigText();
      }

      // ä¿å­˜ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
      function setSaveEnabled(enabled) {
        try {
          const btns = [];
          const a = byId("btnSave");
          if (a) btns.push(a);
          const b = byId("btnSaveFixed");
          if (b) btns.push(b);
          for (const btn of btns) {
            btn.disabled = !enabled;
            if (!enabled) btn.setAttribute("aria-disabled", "true");
            else btn.removeAttribute("aria-disabled");
          }
        } catch (e) {}
      }

      // åˆæœŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨æ¯”è¼ƒã—ã¦å¤‰æ›´ãŒã‚ã‚Œã° true ã‚’è¿”ã™ï¼ˆæœªä¿å­˜åˆ¤å®šï¼‰
      function checkDirty() {
        try {
          const cur = buildConfigText();
          const dirty = initialConfigText === null ? false : cur !== initialConfigText;
          setSaveEnabled(dirty);
          return dirty;
        } catch (e) {
          return false;
        }
      }

      // å…¥åŠ›ã®ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†
      // æˆåŠŸ: {ok:true}
      // å¤±æ•—: {ok:false, msg: 'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'}
      function validate() {
        // ä¾‹: ãƒãƒ¼ãƒˆç¯„å›²
        const port = Number(byId("PORT").value || 0);
        if (!Number.isInteger(port) || port < 1 || port > 65535) return { ok: false, msg: "PORT ã¯ 1..65535 ã®æ•´æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„" };
        const q = Number(byId("DEFAULT_QUALITY").value || 0);
        if (!Number.isFinite(q) || q < 1 || q > 100) return { ok: false, msg: "DEFAULT_QUALITY ã¯ 1..100 ã§æŒ‡å®šã—ã¦ãã ã•ã„" };
        const pct = Number(byId("COMPRESSION_THRESHOLD").value || -1);
        if (!Number.isFinite(pct) || pct < 0 || pct > 1) return { ok: false, msg: "COMPRESSION_THRESHOLD ã¯ 0.0 ã€œ 1.0 ã®å€¤ã§æŒ‡å®šã—ã¦ãã ã•ã„" };
        // CACHE_TTL_MS ã¯ UI ã§ç§’è¡¨ç¤º
        const cacheSecs = Number(byId("CACHE_TTL_MS").value || 0);
        if (!Number.isFinite(cacheSecs) || cacheSecs < 0) return { ok: false, msg: "CACHE_TTL_MS ã¯ 0 ä»¥ä¸Šã®ç§’æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„" };
        // RATE_LIMIT_WINDOW_MS ã¯ UI ã§ç§’è¡¨ç¤º
        const rateWindowSecs = Number(byId("RATE_LIMIT_WINDOW_MS").value || 0);
        if (!Number.isFinite(rateWindowSecs) || rateWindowSecs < 0) return { ok: false, msg: "RATE_LIMIT_WINDOW_MS ã¯ 0 ä»¥ä¸Šã®ç§’æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„" };
        // CACHE_MIN_SIZE ã¯ UI ã§ KB è¡¨ç¤º
        const cacheMinKb = Number(byId("CACHE_MIN_SIZE").value || 0);
        if (!Number.isFinite(cacheMinKb) || cacheMinKb < 0) return { ok: false, msg: "CACHE_MIN_SIZE ã¯ 0 ä»¥ä¸Šã® KB ã§æŒ‡å®šã—ã¦ãã ã•ã„" };
        return { ok: true };
      }

      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã™ã‚‹éåŒæœŸé–¢æ•°
      // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: GET /setting/data
      async function loadConfig() {
        setStatus("èª­ã¿è¾¼ã¿ä¸­...");
        try {
          const r = await fetch("/setting/data");
          if (!r.ok) throw new Error("HTTP " + r.status);
          const j = await r.json();
          const txt = j.content || "";
          const statusLocal = byId("status");
          if (statusLocal) statusLocal.textContent = "";
          const cfg = parseConfig(txt);
          populateForm(cfg);
          // æœªä¿å­˜ãƒã‚§ãƒƒã‚¯ç”¨ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜
          initialConfigText = buildConfigText();
          checkDirty();
          setStatus("èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ");
        } catch (e) {
          setStatus("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + (e.message || e), true);
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‚’çµ„ã¿ç«‹ã¦ã¦ã‚µãƒ¼ãƒã«ä¿å­˜ã™ã‚‹éåŒæœŸé–¢æ•°
      // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: POST /setting/save
      async function saveConfig() {
        setStatus("å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...");
        const v = validate();
        if (!v.ok) {
          setStatus(v.msg, true);
          return;
        }
        const text = buildConfigText();
        // ä¿å­˜å‰ã«ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆrawï¼‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
        if (rawEl) rawEl.textContent = text;
        setStatus("ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...");
        try {
          // Node.js 25.0.0æœ€é©åŒ–: JSON.stringifyã®é«˜é€ŸåŒ–ã‚’æ´»ç”¨
          const r = await fetch("/setting/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: text }),
          });
          if (!r.ok) throw new Error("HTTP " + r.status);
          // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ›´æ–°ã—ã€æ¬¡ã®å¤‰æ›´ã¾ã§ä¿å­˜ã‚’ç„¡åŠ¹åŒ–
          initialConfigText = buildConfigText();
          setSaveEnabled(false);
          setStatus("ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸ");
        } catch (e) {
          setStatus("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + (e.message || e), true);
        }
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆé…ç·šï¼ˆãƒœã‚¿ãƒ³ãŒã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã‚¬ãƒ¼ãƒ‰ä»˜ãï¼‰
      const btnLoadEl = document.getElementById("btnLoad");
      const btnSaveEl = document.getElementById("btnSave");
      const btnRawEl = document.getElementById("btnRaw");
      if (btnLoadEl) btnLoadEl.addEventListener("click", loadConfig);
      if (btnSaveEl)
        btnSaveEl.addEventListener("click", () => {
          saveConfig();
        });
      if (btnRawEl)
        btnRawEl.addEventListener("click", () => {
          if (!rawEl) return; // raw ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ„å›³çš„ã«å‰Šé™¤/ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆã¿
          rawEl.style.display = rawEl.style.display === "none" ? "block" : "none";
        });
      if (themeBtn) themeBtn.addEventListener("click", toggleTheme);

      // åˆæœŸåŒ–
      (function init() {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
        for (const k of keys) {
          const el = byId(k);
          if (!el) continue;
          if (el.type === "checkbox") el.checked = false;
          else el.value = "";
        }
        loadConfig();
        loadTheme();
        initStatsPanel();

        // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—ã—ã¦ä¸¦åˆ—æ•°ä¸Šé™ã‚’å‹•çš„ã«è¨­å®š
        (async () => {
          try {
            const r = await fetch("/setting/sysinfo");
            if (r.ok) {
              const sysInfo = await r.json();
              const mSlider = byId("MAX_CONCURRENCY");
              if (mSlider) {
                mSlider.max = sysInfo.maxConcurrency || 32;
                mSlider.setAttribute("data-recommended", sysInfo.recommendedConcurrency || 4);
                // æ¨å¥¨å€¤ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ©ãƒ™ãƒ«ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¿½åŠ 
                const label = mSlider.closest(".row")?.querySelector("label");
                if (label && sysInfo.recommendedConcurrency) {
                  const tip = document.createElement("span");
                  tip.textContent = ` ï¼ˆæ¨å¥¨: ${sysInfo.recommendedConcurrency}ï¼‰`;
                  tip.style.fontSize = "0.9em";
                  tip.style.opacity = "0.7";
                  label.appendChild(tip);
                }
              }
            }
          } catch (e) {
            // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼‰
          }
        })();

        // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒå–å¾—ã•ã‚Œã‚‹ã¾ã§ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        setSaveEnabled(false);
        // æœªä¿å­˜çŠ¶æ…‹ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã®å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼ã‚’é…ç·š
        for (const k of keys) {
          const el = byId(k);
          if (!el) continue;
          const ev = el.type === "checkbox" || el.tagName.toLowerCase() === "select" ? "change" : "input";
          el.addEventListener(ev, () => checkDirty());
        }
        // åœ§ç¸®æœ‰åŠ¹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã¨ãã«åœ§ç¸®é–¾å€¤ã‚’æœ‰åŠ¹/ç„¡åŠ¹ã«ã™ã‚‹
        try {
          const compFlag = byId("COMPRESSION_ENABLED");
          const compSlider = byId("COMPRESSION_THRESHOLD");
          if (compFlag && compSlider) {
            const toggleCompRow = () => {
              const row = compSlider.closest(".row");
              if (!row) return;
              if (compFlag.checked) {
                row.classList.remove("hidden");
                // row.classList.remove('disabled');
              } else {
                row.classList.add("hidden");
                // row.classList.add('disabled');
              }
            };
            compFlag.addEventListener("change", () => {
              toggleCompRow();
              checkDirty();
            });
            // åˆæœŸçŠ¶æ…‹ã‚’åæ˜ 
            toggleCompRow();
          }
        } catch (e) {}
        // åœ§ç¸®é–¾å€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š: å‡ºåŠ›ã¨æœªä¿å­˜çŠ¶æ…‹ã‚’æ›´æ–°
        const compSlider = byId("COMPRESSION_THRESHOLD");
        const compOut = byId("COMPRESSION_THRESHOLD_VAL");
        function updateCompressionDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (compOut) compOut.textContent = "0.00";
            return;
          }
          if (compOut) compOut.textContent = n.toFixed(2);
        }
        if (compSlider) {
          // populateForm ãŒå€¤ã‚’è¨­å®šã™ã‚‹éš›ã€è¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
          compSlider.addEventListener("input", (e) => {
            updateCompressionDisplay(e.target.value);
            checkDirty();
          });
          // ç¾åœ¨ã®å€¤ã‹ã‚‰è¡¨ç¤ºã‚’åˆæœŸåŒ–
          updateCompressionDisplay(compSlider.value || 0);
        }
        // DEFAULT_QUALITY ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š
        const qSlider = byId("DEFAULT_QUALITY");
        const qOut = byId("DEFAULT_QUALITY_VAL");
        function updateQualityDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (qOut) qOut.textContent = "50";
            return;
          }
          if (qOut) qOut.textContent = String(Math.round(n));
        }
        if (qSlider) {
          qSlider.addEventListener("input", (e) => {
            updateQualityDisplay(e.target.value);
            checkDirty();
          });
          updateQualityDisplay(qSlider.value || 50);
        }
        // WEBP_EFFORT ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š
        const eSlider = byId("WEBP_EFFORT");
        const eOut = byId("WEBP_EFFORT_VAL");
        function updateWebpEffortDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (eOut) eOut.textContent = "1";
            return;
          }
          if (eOut) eOut.textContent = String(Math.round(n));
        }
        if (eSlider) {
          eSlider.addEventListener("input", (ev) => {
            updateWebpEffortDisplay(ev.target.value);
            checkDirty();
          });
          updateWebpEffortDisplay(eSlider.value || 1);
        }
        // WEBP_EFFORT_FAST ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š
        const efSlider = byId("WEBP_EFFORT_FAST");
        const efOut = byId("WEBP_EFFORT_FAST_VAL");
        function updateWebpEffortFastDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (efOut) efOut.textContent = "0";
            return;
          }
          if (efOut) efOut.textContent = String(Math.round(n));
        }
        if (efSlider) {
          efSlider.addEventListener("input", (ev) => {
            updateWebpEffortFastDisplay(ev.target.value);
            checkDirty();
          });
          updateWebpEffortFastDisplay(efSlider.value || 0);
        }
        // WEBP_REDUCTION_EFFORT ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š
        const reSlider = byId("WEBP_REDUCTION_EFFORT");
        const reOut = byId("WEBP_REDUCTION_EFFORT_VAL");
        function updateWebpReductionEffortDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (reOut) reOut.textContent = "0";
            return;
          }
          if (reOut) reOut.textContent = String(Math.round(n));
        }
        if (reSlider) {
          reSlider.addEventListener("input", (ev) => {
            updateWebpReductionEffortDisplay(ev.target.value);
            checkDirty();
          });
          updateWebpReductionEffortDisplay(reSlider.value || 0);
        }
        // PHOTO_SIZE ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š
        const pSlider = byId("PHOTO_SIZE");
        const pOut = byId("PHOTO_SIZE_VAL");
        function updatePhotoSizeDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (pOut) pOut.textContent = "1080";
            return;
          }
          if (pOut) pOut.textContent = String(Math.round(n));
        }
        if (pSlider) {
          pSlider.addEventListener("input", (e) => {
            updatePhotoSizeDisplay(e.target.value);
            checkDirty();
          });
          // åˆæœŸè¡¨ç¤º
          updatePhotoSizeDisplay(pSlider.value || 1080);
        }
        // MAX_CONCURRENCY ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š
        const mSlider = byId("MAX_CONCURRENCY");
        const mOut = byId("MAX_CONCURRENCY_VAL");
        function updateMaxConcurrencyDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (mOut) mOut.textContent = "4";
            return;
          }
          if (mOut) mOut.textContent = String(Math.round(n));
        }
        if (mSlider) {
          mSlider.addEventListener("input", (e) => {
            updateMaxConcurrencyDisplay(e.target.value);
            checkDirty();
          });
          updateMaxConcurrencyDisplay(mSlider.value || 4);
        }
        // SHARP_MEMORY_LIMIT ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é…ç·š
        const sSlider = byId("SHARP_MEMORY_LIMIT");
        const sOut = byId("SHARP_MEMORY_LIMIT_VAL");
        function updateSharpMemoryDisplay(v) {
          const n = Number(v);
          if (isNaN(n)) {
            if (sOut) sOut.textContent = "512";
            return;
          }
          if (sOut) sOut.textContent = String(Math.round(n));
        }
        if (sSlider) {
          sSlider.addEventListener("input", (e) => {
            updateSharpMemoryDisplay(e.target.value);
            checkDirty();
          });
          updateSharpMemoryDisplay(sSlider.value || 512);
        }
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®é…ç·š
        const templateSelect = byId("IMAGE_TEMPLATE");
        const templates = {
          smallest: { PHOTO_SIZE: "640", DEFAULT_QUALITY: "10", IMAGE_MODE: "3" },
          small: { PHOTO_SIZE: "720", DEFAULT_QUALITY: "30", IMAGE_MODE: "1" },
          medium: { PHOTO_SIZE: "1040", DEFAULT_QUALITY: "50", IMAGE_MODE: "2" },
          large: { PHOTO_SIZE: "1440", DEFAULT_QUALITY: "70", IMAGE_MODE: "3" },
          hq: { PHOTO_SIZE: "2400", DEFAULT_QUALITY: "85", IMAGE_MODE: "3" },
        };
        if (templateSelect) {
          templateSelect.addEventListener("change", (ev) => {
            const v = ev.target.value;
            if (!v) return; // é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
            const t = templates[v];
            if (!t) return;
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«é©ç”¨
            for (const k of Object.keys(t)) {
              const el = byId(k);
              if (!el) continue;
              el.value = t[k];
            }
            // ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ãªå¤‰æ›´ã¯ã™ã¹ã¦ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ input/change ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ãªã„ãŸã‚ã€
            // UI å°‚ç”¨ã®è¡¨ç¤ºï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å‡ºåŠ›ï¼‰ã‚’æ‰‹å‹•ã§æ›´æ–°
            try {
              if (typeof updateQualityDisplay === "function" && qSlider) updateQualityDisplay(qSlider.value);
            } catch (e) {}
            try {
              if (typeof updatePhotoSizeDisplay === "function" && pSlider) updatePhotoSizeDisplay(pSlider.value);
            } catch (e) {}
            try {
              if (typeof updateWebpEffortDisplay === "function" && eSlider) updateWebpEffortDisplay(eSlider.value);
            } catch (e) {}
            try {
              if (typeof updateWebpEffortFastDisplay === "function" && efSlider) updateWebpEffortFastDisplay(efSlider.value);
            } catch (e) {}
            try {
              if (typeof updateCompressionDisplay === "function" && compSlider) updateCompressionDisplay(compSlider.value);
            } catch (e) {}
            // ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸãŸã‚ã€æœªä¿å­˜çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
            try {
              checkDirty();
            } catch (e) {}
          });
        }

        // IMAGE_MODE ã®å¤‰æ›´ã«å¿œã˜ã¦ WEBP_EFFORT è¡Œã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆIMAGE_CONVERSION_ENABLEDãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
        try {
          const imgConvFlag = byId("IMAGE_CONVERSION_ENABLED");
          const imgModeEl = byId("IMAGE_MODE");
          const webpRow = byId("WEBP_EFFORT") ? byId("WEBP_EFFORT").closest(".row") : null;
          const webpFastRow = byId("WEBP_EFFORT_FAST") ? byId("WEBP_EFFORT_FAST").closest(".row") : null;
          const toggleWebpRows = () => {
            if (!imgModeEl || !webpRow || !webpFastRow || !imgConvFlag || !imgConvFlag.checked) return;
            if (String(imgModeEl.value) === "1") {
              webpRow.classList.add("hidden");
              // webpRow.classList.add('disabled');
              webpFastRow.classList.remove("hidden");
              // webpFastRow.classList.remove('disabled');
            } else {
              webpRow.classList.remove("hidden");
              // webpRow.classList.remove('disabled');
              webpFastRow.classList.add("hidden");
              // webpFastRow.classList.add('disabled');
            }
          };
          imgModeEl.addEventListener("change", () => {
            try {
              toggleWebpRows();
              checkDirty();
            } catch (e) {}
          });
          // åˆæœŸçŠ¶æ…‹
          toggleWebpRows();
        } catch (e) {}

        // RATE_LIMIT_ENABLED ã®åˆ‡æ›¿ã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™é …ç›®ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
        try {
          const rateFlag = byId("RATE_LIMIT_ENABLED");
          const rReq = byId("RATE_LIMIT_REQUESTS") ? byId("RATE_LIMIT_REQUESTS").closest(".row") : null;
          const rWin = byId("RATE_LIMIT_WINDOW_MS") ? byId("RATE_LIMIT_WINDOW_MS").closest(".row") : null;
          const rQueue = byId("RATE_LIMIT_QUEUE_SIZE") ? byId("RATE_LIMIT_QUEUE_SIZE").closest(".row") : null;
          const toggleRateRows = () => {
            if (!rateFlag) return;
            const disable = !rateFlag.checked;
            [rReq, rWin, rQueue].forEach((r) => {
              if (!r) return;
              if (disable) {
                r.classList.add("hidden"); /* r.classList.add('disabled'); */
              } else {
                r.classList.remove("hidden"); /* r.classList.remove('disabled'); */
              }
            });
          };
          if (rateFlag) {
            rateFlag.addEventListener("change", () => {
              try {
                toggleRateRows();
                checkDirty();
              } catch (e) {}
            });
            toggleRateRows();
          }
        } catch (e) {}

        // RESTART_ENABLED ã®åˆ‡æ›¿ã§å†èµ·å‹•æ™‚åˆ»å…¥åŠ›ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
        try {
          const restartFlag = byId("RESTART_ENABLED");
          const restartTimeRow = byId("RESTART_TIME") ? byId("RESTART_TIME").closest(".row") : null;
          const toggleRestart = () => {
            if (!restartFlag || !restartTimeRow) return;
            if (restartFlag.checked) {
              restartTimeRow.classList.remove("hidden");
              // restartTimeRow.classList.remove('disabled');
            } else {
              restartTimeRow.classList.add("hidden");
              // restartTimeRow.classList.add('disabled');
            }
          };
          if (restartFlag) {
            restartFlag.addEventListener("change", () => {
              try {
                toggleRestart();
                checkDirty();
              } catch (e) {}
            });
            toggleRestart();
          }
        } catch (e) {}

        // IMAGE_CONVERSION_ENABLED ã®åˆ‡æ›¿ã§ç”»åƒå¤‰æ›é–¢é€£é …ç›®ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–
        try {
          const imgConvFlag = byId("IMAGE_CONVERSION_ENABLED");
          const imgModeEl = byId("IMAGE_MODE");
          const webpDetailedFlag = byId("WEBP_DETAILED_ENABLED");
          const imgTemplateRow = byId("image-template-row");
          const photoSizeRow = byId("photo-size-row");
          const defaultQualityRow = byId("default-quality-row");
          const imageModeRow = byId("image-mode-row");
          const webpEffortRow = byId("webp-effort-row");
          const webpEffortFastRow = byId("webp-effort-fast-row");
          const webpDetailedEnabledRow = byId("webp-detailed-enabled-row");
          const webpPresetRow = byId("webp-detailed-preset-row");
          const webpReductionRow = byId("webp-detailed-reduction-row");
          const toggleImageConversionRows = () => {
            if (!imgConvFlag) return;
            const disable = !imgConvFlag.checked;
            [imgTemplateRow, photoSizeRow, defaultQualityRow, imageModeRow, webpEffortRow, webpEffortFastRow, webpDetailedEnabledRow, webpPresetRow, webpReductionRow].forEach((r) => {
              if (!r) return;
              if (disable) {
                r.classList.add("hidden");
                /* r.classList.add('disabled'); */
              } else {
                r.classList.remove("hidden");
                /* r.classList.remove('disabled'); */
              }
            });
            // IMAGE_CONVERSION_ENABLEDãŒæœ‰åŠ¹ã«ãªã£ãŸå ´åˆã€IMAGE_MODEã«å¿œã˜ã¦WEBP_EFFORTã¨WEBP_EFFORT_FASTã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            if (!disable && imgModeEl && webpEffortRow && webpEffortFastRow) {
              if (String(imgModeEl.value) === "1") {
                webpEffortRow.classList.add("hidden");
                webpEffortFastRow.classList.remove("hidden");
              } else {
                webpEffortRow.classList.remove("hidden");
                webpEffortFastRow.classList.add("hidden");
              }
            }
            // IMAGE_CONVERSION_ENABLEDãŒæœ‰åŠ¹ã«ãªã£ãŸå ´åˆã€WEBP_DETAILED_ENABLEDã«å¿œã˜ã¦è©³ç´°è¨­å®šé …ç›®ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            if (!disable && webpDetailedFlag && webpPresetRow && webpReductionRow) {
              // ã•ã‚‰ã«æ·±ã„éšå±¤ã®å­é …ç›®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
              try {
                [webpPresetRow, webpReductionRow].forEach((r) => {
                  if (r) {
                    r.classList.remove("child");
                    r.classList.add("child-2");
                  }
                });
              } catch (e) {}
              const detailedDisable = !webpDetailedFlag.checked;
              [webpPresetRow, webpReductionRow].forEach((r) => {
                if (!r) return;
                if (detailedDisable) {
                  r.classList.add("hidden");
                } else {
                  r.classList.remove("hidden");
                }
              });
            }
          };
          if (imgConvFlag) {
            imgConvFlag.addEventListener("change", () => {
              try {
                toggleImageConversionRows();
                checkDirty();
              } catch (e) {}
            });
            toggleImageConversionRows();
          }
        } catch (e) {}

        // WEBP_DETAILED_ENABLED ã®åˆ‡æ›¿ã§è©³ç´°è¨­å®šé …ç›®ã‚’æœ‰åŠ¹/ç„¡åŠ¹åŒ–ï¼ˆIMAGE_CONVERSION_ENABLEDãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
        try {
          const imgConvFlag = byId("IMAGE_CONVERSION_ENABLED");
          const webpDetailedFlag = byId("WEBP_DETAILED_ENABLED");
          const webpPresetRow = byId("webp-detailed-preset-row");
          const webpReductionRow = byId("webp-detailed-reduction-row");
          const toggleWebpDetailedRows = () => {
            if (!webpDetailedFlag || !imgConvFlag || !imgConvFlag.checked) return;
            // ã•ã‚‰ã«æ·±ã„éšå±¤ã®å­é …ç›®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
            try {
              [webpPresetRow, webpReductionRow].forEach((r) => {
                if (r) {
                  r.classList.remove("child");
                  r.classList.add("child-2");
                }
              });
            } catch (e) {}
            const disable = !webpDetailedFlag.checked;
            [webpPresetRow, webpReductionRow].forEach((r) => {
              if (!r) return;
              if (disable) {
                r.classList.add("hidden");
                /* r.classList.add('disabled'); */
              } else {
                r.classList.remove("hidden");
                /* r.classList.remove('disabled'); */
              }
            });
          };
          if (webpDetailedFlag) {
            webpDetailedFlag.addEventListener("change", () => {
              try {
                toggleWebpDetailedRows();
                checkDirty();
              } catch (e) {}
            });
            toggleWebpDetailedRows();
          }
        } catch (e) {}

        // å›ºå®šãƒãƒ¼ãƒœã‚¿ãƒ³ã®é…ç·šï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        const btnSaveFixed = byId("btnSaveFixed");
        const btnLoadFixed = byId("btnLoadFixed");
        if (btnSaveFixed) btnSaveFixed.addEventListener("click", () => saveConfig());
        if (btnLoadFixed) btnLoadFixed.addEventListener("click", () => loadConfig());

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡Œã‚’ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«ãªè¦–è¦šçš„ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã«å¤‰æ›
        try {
          const checkboxRows = document.querySelectorAll(".checkbox-row");
          checkboxRows.forEach((row) => {
            const cb = row.querySelector('input[type="checkbox"]');
            if (!cb) return;
            // äºŒé‡æŒ¿å…¥ã‚’å›é¿
            if (row.querySelector(".switch")) return;
            const sw = document.createElement("span");
            sw.className = "switch" + (cb.checked ? " on" : "");
            sw.setAttribute("tabindex", "0");
            sw.setAttribute("role", "switch");
            sw.setAttribute("aria-checked", cb.checked ? "true" : "false");
            // ã‚¹ã‚¤ãƒƒãƒãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒˆã‚°ãƒ«ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
            const toggle = () => {
              cb.checked = !cb.checked;
              // è¦–è¦šçš„è¡¨ç¤ºã‚’æ›´æ–°
              if (cb.checked) sw.classList.add("on");
              else sw.classList.remove("on");
              sw.setAttribute("aria-checked", cb.checked ? "true" : "false");
              // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã« change ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
              try {
                cb.dispatchEvent(new Event("change", { bubbles: true }));
              } catch (e) {}
              try {
                checkDirty();
              } catch (e) {}
            };
            sw.addEventListener("click", (e) => {
              e.preventDefault();
              toggle();
            });
            sw.addEventListener("keydown", (e) => {
              if (e.key === " " || e.key === "Enter") {
                e.preventDefault();
                toggle();
              }
            });
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¤–éƒ¨ã§å¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã‚¹ã‚¤ãƒƒãƒã‚’åŒæœŸ
            cb.addEventListener("change", () => {
              if (cb.checked) sw.classList.add("on");
              else sw.classList.remove("on");
              sw.setAttribute("aria-checked", cb.checked ? "true" : "false");
            });
            // ãƒ©ãƒ™ãƒ«ã®å¾Œã¾ãŸã¯è¡Œã®æœ€å¾Œã«ã‚¹ã‚¤ãƒƒãƒã‚’è¿½åŠ 
            row.appendChild(sw);
          });
        } catch (e) {}
      })();
    </script>
  </body>
</html>
